<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Polling Test Suite</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #0f0f0f;
            color: #ffffff;
        }
        .test-container {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            border-left: 4px solid #8b5cf6;
            padding-left: 16px;
        }
        .test-result {
            background: #111;
            border-radius: 4px;
            padding: 12px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-left: 4px solid #22c55e;
        }
        .test-result.error {
            border-left-color: #ef4444;
        }
        .test-result.warning {
            border-left-color: #f59e0b;
        }
        button {
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        button:hover {
            opacity: 0.9;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #22c55e; }
        .status-error { background: #ef4444; }
        .status-warning { background: #f59e0b; }
        .status-info { background: #06b6d4; }
        iframe {
            width: 100%;
            height: 800px;
            border: 1px solid #333;
            border-radius: 8px;
            background: white;
        }
        .console-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .step-indicator {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .step-number {
            background: #8b5cf6;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¥ Video Generation Polling Test Suite</h1>
    <p>è‡ªåŠ¨åŒ–æµ‹è¯•ä¸‰ç§è§†é¢‘ç”Ÿæˆç±»å‹çš„è½®è¯¢åŠŸèƒ½ï¼šText-to-Videoã€Image-to-Videoã€Video Effects</p>

    <div class="test-container">
        <h2>ğŸ¯ æµ‹è¯•æ§åˆ¶å°</h2>
        <button onclick="startAllTests()">å¼€å§‹å…¨é¢æµ‹è¯•</button>
        <button onclick="testTextToVideo()">æµ‹è¯• Text-to-Video</button>
        <button onclick="testImageToVideo()">æµ‹è¯• Image-to-Video</button>
        <button onclick="testVideoEffects()">æµ‹è¯• Video Effects</button>
        <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
        <button onclick="openDevConsole()">æ‰“å¼€åº”ç”¨é¡µé¢</button>
    </div>

    <!-- åº”ç”¨é¢„è§ˆ -->
    <div class="test-container">
        <h2>ğŸ–¥ï¸ åº”ç”¨é¢„è§ˆ (http://localhost:3000/create)</h2>
        <iframe id="appFrame" src="http://localhost:3000/create"></iframe>
    </div>

    <!-- æµ‹è¯•ç»“æœåŒºåŸŸ -->
    <div class="test-container">
        <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
        <div id="testResults"></div>
    </div>

    <!-- å®æ—¶æ—¥å¿— -->
    <div class="test-container">
        <h2>ğŸ” å®æ—¶Consoleæ—¥å¿—ç›‘æ§</h2>
        <div class="console-output" id="consoleOutput">
            ç­‰å¾…æµ‹è¯•å¼€å§‹...
        </div>
    </div>

    <script>
        // å…¨å±€æµ‹è¯•çŠ¶æ€
        let testResults = [];
        let isTestingInProgress = false;

        // æ—¥å¿—è®°å½•å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const output = document.getElementById('consoleOutput');
            const logEntry = `[${timestamp}] ${message}\n`;
            output.textContent += logEntry;
            output.scrollTop = output.scrollHeight;

            console.log(`[TEST] ${message}`);

            // åŒæ—¶æ·»åŠ åˆ°ç»“æœä¸­
            addTestResult(message, type);
        }

        // æ·»åŠ æµ‹è¯•ç»“æœ
        function addTestResult(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;

            const statusClass = {
                'info': 'status-info',
                'success': 'status-success',
                'error': 'status-error',
                'warning': 'status-warning'
            }[type] || 'status-info';

            resultDiv.innerHTML = `
                <span class="status-indicator ${statusClass}"></span>
                ${message}
            `;

            resultsDiv.appendChild(resultDiv);
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('consoleOutput').textContent = 'æ—¥å¿—å·²æ¸…é™¤...\n';
            testResults = [];
        }

        // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚ç›‘æ§
        function monitorNetworkRequests() {
            log("å¼€å§‹ç›‘æ§ç½‘ç»œè¯·æ±‚...", 'info');

            // ç›‘æ§iframeä¸­çš„ç½‘ç»œè¯·æ±‚
            const iframe = document.getElementById('appFrame');
            if (iframe.contentWindow) {
                try {
                    // å°è¯•è®¿é—®iframeå†…å®¹ï¼ˆå¯èƒ½å—åˆ°åŒæºç­–ç•¥é™åˆ¶ï¼‰
                    const iframeWindow = iframe.contentWindow;

                    // é‡å†™fetchå‡½æ•°æ¥ç›‘æ§è¯·æ±‚
                    const originalFetch = iframeWindow.fetch;
                    iframeWindow.fetch = function(...args) {
                        const url = args[0];
                        log(`ğŸŒ APIè°ƒç”¨: ${url}`, 'info');

                        return originalFetch.apply(this, args).then(response => {
                            if (response.ok) {
                                log(`âœ… APIæˆåŠŸ: ${url} - ${response.status}`, 'success');
                            } else {
                                log(`âŒ APIå¤±è´¥: ${url} - ${response.status}`, 'error');
                            }
                            return response;
                        }).catch(error => {
                            log(`ğŸ’¥ ç½‘ç»œé”™è¯¯: ${url} - ${error.message}`, 'error');
                            throw error;
                        });
                    };
                } catch (e) {
                    log("âš ï¸ æ— æ³•ç›‘æ§iframeç½‘ç»œè¯·æ±‚ï¼ˆå¯èƒ½çš„åŒæºç­–ç•¥é™åˆ¶ï¼‰", 'warning');
                }
            }
        }

        // æµ‹è¯•æ­¥éª¤æŒ‡ç¤ºå™¨
        function showTestStep(stepNumber, description) {
            log(`ğŸ”„ æ­¥éª¤ ${stepNumber}: ${description}`, 'info');
        }

        // Text-to-Videoæµ‹è¯•
        async function testTextToVideo() {
            if (isTestingInProgress) {
                log("âš ï¸ æµ‹è¯•æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ", 'warning');
                return;
            }

            isTestingInProgress = true;
            log("=== å¼€å§‹ Text-to-Video è½®è¯¢æµ‹è¯• ===", 'info');

            try {
                showTestStep(1, "åˆ‡æ¢åˆ° Text-to-Video æ ‡ç­¾é¡µ");

                const iframe = document.getElementById('appFrame');
                if (!iframe.contentWindow) {
                    throw new Error("æ— æ³•è®¿é—®iframe");
                }

                // å°è¯•é€šè¿‡postMessageä¸iframeé€šä¿¡
                iframe.contentWindow.postMessage({
                    action: 'switchTab',
                    tab: 'text-to-video'
                }, '*');

                await sleep(2000);

                showTestStep(2, "å¡«å†™æµ‹è¯•æç¤ºè¯");
                iframe.contentWindow.postMessage({
                    action: 'fillPrompt',
                    prompt: 'A majestic eagle soaring through mountain peaks at golden hour'
                }, '*');

                await sleep(1000);

                showTestStep(3, "æ¨¡æ‹Ÿç‚¹å‡»ç”ŸæˆæŒ‰é’®");
                iframe.contentWindow.postMessage({
                    action: 'clickGenerate'
                }, '*');

                showTestStep(4, "ç›‘æ§UIçŠ¶æ€å˜åŒ–");
                // è¿™é‡Œæˆ‘ä»¬éœ€è¦ç­‰å¾…UIçŠ¶æ€å˜åŒ–çš„åé¦ˆ

                await sleep(5000); // ç­‰å¾…5ç§’è§‚å¯ŸçŠ¶æ€å˜åŒ–

                showTestStep(5, "æ£€æŸ¥è½®è¯¢æ˜¯å¦å¯åŠ¨");
                // æ£€æŸ¥consoleæ—¥å¿—å’Œç½‘ç»œè¯·æ±‚

                log("âœ… Text-to-Video åŸºç¡€æµ‹è¯•å®Œæˆ", 'success');

            } catch (error) {
                log(`âŒ Text-to-Video æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            } finally {
                isTestingInProgress = false;
            }
        }

        // Image-to-Videoæµ‹è¯•
        async function testImageToVideo() {
            if (isTestingInProgress) {
                log("âš ï¸ æµ‹è¯•æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ", 'warning');
                return;
            }

            isTestingInProgress = true;
            log("=== å¼€å§‹ Image-to-Video è½®è¯¢æµ‹è¯• ===", 'info');

            try {
                showTestStep(1, "åˆ‡æ¢åˆ° Image-to-Video æ ‡ç­¾é¡µ");

                const iframe = document.getElementById('appFrame');
                iframe.contentWindow.postMessage({
                    action: 'switchTab',
                    tab: 'image-to-video'
                }, '*');

                await sleep(2000);

                showTestStep(2, "æ¨¡æ‹Ÿå›¾ç‰‡ä¸Šä¼ æˆ–URLè¾“å…¥");
                // ä½¿ç”¨æµ‹è¯•å›¾ç‰‡URL
                iframe.contentWindow.postMessage({
                    action: 'setImageUrl',
                    url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&h=600&fit=crop'
                }, '*');

                await sleep(1000);

                showTestStep(3, "å¡«å†™å›¾ç‰‡è½¬è§†é¢‘æç¤ºè¯");
                iframe.contentWindow.postMessage({
                    action: 'fillPrompt',
                    prompt: 'Transform this scenic landscape into a dynamic video with gentle camera movement'
                }, '*');

                await sleep(1000);

                showTestStep(4, "æ¨¡æ‹Ÿç‚¹å‡»ç”ŸæˆæŒ‰é’®");
                iframe.contentWindow.postMessage({
                    action: 'clickGenerate'
                }, '*');

                await sleep(5000);

                log("âœ… Image-to-Video åŸºç¡€æµ‹è¯•å®Œæˆ", 'success');

            } catch (error) {
                log(`âŒ Image-to-Video æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            } finally {
                isTestingInProgress = false;
            }
        }

        // Video Effectsæµ‹è¯•
        async function testVideoEffects() {
            if (isTestingInProgress) {
                log("âš ï¸ æµ‹è¯•æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ", 'warning');
                return;
            }

            isTestingInProgress = true;
            log("=== å¼€å§‹ Video Effects è½®è¯¢æµ‹è¯• ===", 'info');

            try {
                showTestStep(1, "åˆ‡æ¢åˆ° Video Effects æ ‡ç­¾é¡µ");

                const iframe = document.getElementById('appFrame');
                iframe.contentWindow.postMessage({
                    action: 'switchTab',
                    tab: 'video-effects'
                }, '*');

                await sleep(2000);

                showTestStep(2, "ä¸Šä¼ æµ‹è¯•å›¾ç‰‡");
                iframe.contentWindow.postMessage({
                    action: 'setImageUrl',
                    url: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=800&h=600&fit=crop'
                }, '*');

                await sleep(1000);

                showTestStep(3, "é€‰æ‹©è§†é¢‘ç‰¹æ•ˆ");
                iframe.contentWindow.postMessage({
                    action: 'selectEffect',
                    effectId: 'face_dance'
                }, '*');

                await sleep(1000);

                showTestStep(4, "æ¨¡æ‹Ÿç‚¹å‡»ç”ŸæˆæŒ‰é’®");
                iframe.contentWindow.postMessage({
                    action: 'clickGenerate'
                }, '*');

                await sleep(5000);

                log("âœ… Video Effects åŸºç¡€æµ‹è¯•å®Œæˆ", 'success');

            } catch (error) {
                log(`âŒ Video Effects æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            } finally {
                isTestingInProgress = false;
            }
        }

        // å¼€å§‹å…¨é¢æµ‹è¯•
        async function startAllTests() {
            if (isTestingInProgress) {
                log("âš ï¸ æµ‹è¯•æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ", 'warning');
                return;
            }

            log("ğŸš€ å¼€å§‹å…¨é¢è½®è¯¢åŠŸèƒ½æµ‹è¯•", 'info');
            clearResults();

            // ä¾æ¬¡æµ‹è¯•ä¸‰ç§ç±»å‹
            await testTextToVideo();
            await sleep(3000); // é—´éš”3ç§’

            await testImageToVideo();
            await sleep(3000);

            await testVideoEffects();

            log("ğŸ‰ å…¨é¢æµ‹è¯•å®Œæˆï¼è¯·æŸ¥çœ‹ä¸Šæ–¹ç»“æœ", 'success');
        }

        // æ‰“å¼€å¼€å‘è€…å·¥å…·æç¤º
        function openDevConsole() {
            log("ğŸ’¡ è¯·æ‰‹åŠ¨æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·(F12)æ¥æŸ¥çœ‹è¯¦ç»†çš„consoleæ—¥å¿—", 'info');
            log("åœ¨iframeé¡µé¢ä¸­å¯ä»¥çœ‹åˆ°å®æ—¶çš„APIè°ƒç”¨å’ŒçŠ¶æ€å˜åŒ–", 'info');

            // æ‰“å¼€æ–°çª—å£åˆ°createé¡µé¢
            window.open('http://localhost:3000/create', '_blank');
        }

        // å·¥å…·å‡½æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ç›‘å¬æ¥è‡ªiframeçš„æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            if (event.origin !== 'http://localhost:3000') return;

            const data = event.data;
            if (data.type === 'test-log') {
                log(data.message, data.level || 'info');
            } else if (data.type === 'ui-state-change') {
                log(`ğŸ”„ UIçŠ¶æ€å˜åŒ–: ${data.state}`, 'info');
            } else if (data.type === 'api-call') {
                log(`ğŸŒ APIè°ƒç”¨: ${data.method} ${data.url}`, 'info');
            } else if (data.type === 'polling-start') {
                log(`â–¶ï¸ è½®è¯¢å¼€å§‹: Job ID ${data.jobId}`, 'success');
            } else if (data.type === 'polling-update') {
                log(`ğŸ“Š è½®è¯¢æ›´æ–°: ${data.message}`, 'info');
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            log("ğŸ”§ æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ", 'success');
            log("ğŸ’¡ ä½¿ç”¨ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•ï¼Œæˆ–ç‚¹å‡»'å¼€å§‹å…¨é¢æµ‹è¯•'è¿›è¡Œå®Œæ•´æµ‹è¯•", 'info');

            // ç›‘æ§iframeåŠ è½½çŠ¶æ€
            const iframe = document.getElementById('appFrame');
            iframe.onload = function() {
                log("ğŸ“± åº”ç”¨é¡µé¢åŠ è½½å®Œæˆ", 'success');
                monitorNetworkRequests();
            };

            iframe.onerror = function() {
                log("âŒ åº”ç”¨é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®è®¤å¼€å‘æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ", 'error');
            };
        });
    </script>
</body>
</html>
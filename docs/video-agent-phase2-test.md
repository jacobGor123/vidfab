# Video Agent - Phase 2 é‡æ–°ç”ŸæˆåŠŸèƒ½æµ‹è¯•æ–‡æ¡£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å·²æˆåŠŸå®ç° Phase 2 çš„é‡æ–°ç”ŸæˆåŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·ï¼š
- âœ… ç‚¹å‡»å½“å‰æ­¥éª¤æ˜¾ç¤ºé‡ç½®ç¡®è®¤å¯¹è¯æ¡†
- âœ… ç¡®è®¤åæ¸…ç©ºå½“å‰æ­¥éª¤åŠåç»­æ‰€æœ‰æ•°æ®
- âœ… æ•°æ®åº“äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
- âœ… ä¼˜é›…çš„ UI ç¡®è®¤å¯¹è¯æ¡†ï¼ˆä½¿ç”¨ AlertDialog ç»„ä»¶ï¼‰

## ğŸ¯ æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: é‡ç½®å½“å‰æ­¥éª¤

**å‰ææ¡ä»¶**ï¼š
- ç”¨æˆ·å·²ç»å®Œæˆæ­¥éª¤ 1ã€2ã€3
- å½“å‰åœ¨æ­¥éª¤ 3ï¼ˆåˆ†é•œç”Ÿæˆï¼‰
- å·²ç”Ÿæˆåˆ†é•œå›¾

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æ‰“å¼€ Video Agent é¡¹ç›®å¼¹çª—
2. ç‚¹å‡»æ­¥éª¤ 3ï¼ˆå½“å‰æ­¥éª¤ï¼‰
3. åº”å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†ï¼Œæ˜¾ç¤ºï¼š
   - âš ï¸ è­¦å‘Šå›¾æ ‡
   - æ ‡é¢˜ï¼š"Reset from Step 3?"
   - æè¿°ï¼šå°†åˆ é™¤æ­¥éª¤ 3ã€4ã€5 çš„æ‰€æœ‰æ•°æ®
   - æ©™è‰²æŒ‰é’®ï¼š"Reset Project"
4. ç‚¹å‡» "Cancel" â†’ å¯¹è¯æ¡†å…³é—­ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
5. å†æ¬¡ç‚¹å‡»æ­¥éª¤ 3
6. ç‚¹å‡» "Reset Project"
7. ç­‰å¾…é‡ç½®å®Œæˆï¼ˆæ˜¾ç¤º loading çŠ¶æ€ï¼‰

**é¢„æœŸç»“æœ**ï¼š
- âœ… ç¡®è®¤å¯¹è¯æ¡†æ­£ç¡®æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
- âœ… å—å½±å“çš„æ­¥éª¤åˆ—è¡¨æ­£ç¡®ï¼ˆStoryboard Generation, Video Clip Generation, Final Compositionï¼‰
- âœ… ç‚¹å‡»é‡ç½®åï¼Œæ•°æ®è¢«æ¸…ç©ºï¼š
  - `project_storyboards` è¡¨ä¸­çš„æ‰€æœ‰åˆ†é•œå›¾è¢«åˆ é™¤
  - `project_video_clips` è¡¨ä¸­çš„æ‰€æœ‰è§†é¢‘ç‰‡æ®µè¢«åˆ é™¤
  - `step_3_status`, `step_4_status`, `step_5_status` é‡ç½®ä¸º NULL
  - `image_style_id` é‡ç½®ä¸º NULL
  - `current_step` é‡ç½®ä¸º 3
- âœ… æ§åˆ¶å°è¾“å‡ºï¼š
  - `[StepDialog] ç‚¹å‡»å½“å‰æ­¥éª¤ 3ï¼Œæ˜¾ç¤ºé‡ç½®ç¡®è®¤å¯¹è¯æ¡†`
  - `[StepDialog] å¼€å§‹é‡ç½®é¡¹ç›®ä»æ­¥éª¤ 3`
  - `[StepDialog] é‡ç½®æˆåŠŸ`

---

### åœºæ™¯ 2: é‡ç½®ä¸åŒæ­¥éª¤çš„æ•°æ®æ¸…ç©ºèŒƒå›´

#### 2.1 ä»æ­¥éª¤ 1 é‡ç½®ï¼ˆå®Œå…¨é‡ç½®ï¼‰
**é¢„æœŸ**ï¼šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆäººç‰©ã€åˆ†é•œã€è§†é¢‘ã€éŸ³ä¹ã€æœ€ç»ˆåˆæˆï¼‰

#### 2.2 ä»æ­¥éª¤ 2 é‡ç½®
**é¢„æœŸ**ï¼šæ¸…ç©ºäººç‰©åŠåç»­æ‰€æœ‰æ•°æ®ï¼Œä¿ç•™è„šæœ¬åˆ†æ

#### 2.3 ä»æ­¥éª¤ 4 é‡ç½®
**é¢„æœŸ**ï¼šæ¸…ç©ºåˆ†é•œå›¾åŠåç»­æ•°æ®ï¼Œä¿ç•™è„šæœ¬åˆ†æå’Œäººç‰©é…ç½®

#### 2.4 ä»æ­¥éª¤ 5 é‡ç½®
**é¢„æœŸ**ï¼šæ¸…ç©ºè§†é¢‘ç‰‡æ®µåŠåç»­æ•°æ®

**æµ‹è¯•æ­¥éª¤**ï¼š
1. ä¸ºæ¯ä¸ªæ­¥éª¤åˆ›å»ºæµ‹è¯•é¡¹ç›®
2. å®Œæˆæ‰€æœ‰æ­¥éª¤
3. åˆ†åˆ«é‡ç½®åˆ°ä¸åŒæ­¥éª¤
4. éªŒè¯æ•°æ®åº“ä¸­çš„æ•°æ®æ¸…ç©ºèŒƒå›´æ­£ç¡®

---

### åœºæ™¯ 3: é‡ç½®åé‡æ–°ç”Ÿæˆ

**å‰ææ¡ä»¶**ï¼š
- ç”¨æˆ·å·²ç»å®Œæˆæ­¥éª¤ 1ã€2ã€3ã€4ã€5
- å½“å‰åœ¨æ­¥éª¤ 5ï¼ˆæœ€ç»ˆåˆæˆï¼‰

**æµ‹è¯•æ­¥éª¤**ï¼š
1. ç‚¹å‡»æ­¥éª¤ 3 è¿›è¡ŒæŸ¥çœ‹ï¼ˆå›æº¯ï¼‰
2. å†æ¬¡ç‚¹å‡»æ­¥éª¤ 3ï¼ˆå½“å‰æ­¥éª¤ï¼‰
3. ç¡®è®¤é‡ç½®
4. ç­‰å¾…é‡ç½®å®Œæˆ
5. éªŒè¯é¡µé¢æ˜¾ç¤ºæ­¥éª¤ 3 çš„å†…å®¹
6. é€‰æ‹©å›¾ç‰‡é£æ ¼
7. é‡æ–°ç”Ÿæˆåˆ†é•œå›¾
8. éªŒè¯å¯ä»¥ç»§ç»­åç»­æ­¥éª¤

**é¢„æœŸç»“æœ**ï¼š
- âœ… é‡ç½®åå¯ä»¥é‡æ–°é…ç½®å¹¶ç”Ÿæˆ
- âœ… æ­¥éª¤æµç¨‹æ­£å¸¸
- âœ… ä¸å½±å“å‰é¢æ­¥éª¤çš„æ•°æ®ï¼ˆè„šæœ¬åˆ†æã€äººç‰©é…ç½®ï¼‰

---

### åœºæ™¯ 4: æ•°æ®åº“äº‹åŠ¡å®Œæ•´æ€§

**æµ‹è¯•æ­¥éª¤**ï¼š
1. åœ¨é‡ç½®è¿‡ç¨‹ä¸­æ¨¡æ‹Ÿæ•°æ®åº“é”™è¯¯ï¼ˆå¯é€‰ï¼Œéœ€è¦æ‰‹åŠ¨å¹²é¢„ï¼‰
2. éªŒè¯äº‹åŠ¡å›æ»šæœºåˆ¶

**é¢„æœŸç»“æœ**ï¼š
- âœ… å¦‚æœé‡ç½®å¤±è´¥ï¼Œæ•°æ®ä¿æŒåŸçŠ¶ï¼Œä¸ä¼šéƒ¨åˆ†åˆ é™¤
- âœ… é”™è¯¯ä¿¡æ¯æ­£ç¡®æ˜¾ç¤ºåœ¨æ§åˆ¶å°
- âœ… UI æ¢å¤åˆ°æ­£å¸¸çŠ¶æ€

---

## ğŸ” æ•°æ®åº“éªŒè¯

### SQL æŸ¥è¯¢éªŒè¯

```sql
-- 1. æŸ¥çœ‹é¡¹ç›®å½“å‰çŠ¶æ€
SELECT
  id,
  current_step,
  step_1_status,
  step_2_status,
  step_3_status,
  step_4_status,
  step_5_status,
  step_6_status,
  step_7_status,
  image_style_id,
  music_source,
  final_video_url
FROM video_agent_projects
WHERE id = 'your-project-id';

-- 2. æ£€æŸ¥å…³è”æ•°æ®æ˜¯å¦è¢«åˆ é™¤
SELECT
  (SELECT COUNT(*) FROM project_characters WHERE project_id = 'your-project-id') as characters_count,
  (SELECT COUNT(*) FROM project_storyboards WHERE project_id = 'your-project-id') as storyboards_count,
  (SELECT COUNT(*) FROM project_video_clips WHERE project_id = 'your-project-id') as videos_count;

-- 3. æ‰‹åŠ¨è°ƒç”¨é‡ç½®å‡½æ•°æµ‹è¯•
SELECT reset_project_from_step('your-project-id', 3);
```

### éªŒè¯æ¸…å•

- [ ] `step_X_status` å­—æ®µæ­£ç¡®é‡ç½®ä¸º NULLï¼ˆX >= é‡ç½®æ­¥éª¤ï¼‰
- [ ] `current_step` æ›´æ–°ä¸ºé‡ç½®æ­¥éª¤
- [ ] å…³è”è¡¨æ•°æ®æ­£ç¡®åˆ é™¤ï¼ˆproject_characters, project_storyboards, project_video_clipsï¼‰
- [ ] `updated_at` æ—¶é—´æˆ³æ›´æ–°
- [ ] å…¶ä»–å­—æ®µï¼ˆduration, story_style, original_scriptï¼‰ä¿æŒä¸å˜

---

## ğŸ¨ UI/UX éªŒè¯

### ç¡®è®¤å¯¹è¯æ¡† (ResetStepConfirmDialog)

- [ ] å¯¹è¯æ¡†å±…ä¸­æ˜¾ç¤º
- [ ] èƒŒæ™¯åŠé€æ˜é»‘è‰²é®ç½©
- [ ] è­¦å‘Šå›¾æ ‡ï¼ˆç¥ç€è‰²ï¼‰æ­£ç¡®æ˜¾ç¤º
- [ ] æ ‡é¢˜å’Œæè¿°æ–‡å­—æ¸…æ™°æ˜“è¯»
- [ ] å—å½±å“æ­¥éª¤åˆ—è¡¨å®Œæ•´æ˜¾ç¤º
- [ ] "Cancel" æŒ‰é’®ï¼šç°è‰²ï¼Œhover å˜æ·±
- [ ] "Reset Project" æŒ‰é’®ï¼šç¥ç€è‰²ï¼Œhover å˜æ·±
- [ ] Loading çŠ¶æ€ï¼šæŒ‰é’®æ˜¾ç¤ºæ—‹è½¬åŠ¨ç”» + "Resetting..." æ–‡å­—
- [ ] ç‚¹å‡»å¤–éƒ¨ä¸å…³é—­å¯¹è¯æ¡†ï¼ˆé˜²æ­¢è¯¯æ“ä½œï¼‰
- [ ] ESC é”®å¯ä»¥å…³é—­å¯¹è¯æ¡†

### æ­¥éª¤æ¡äº¤äº’

- [ ] å½“å‰æ­¥éª¤å¯ç‚¹å‡»ï¼Œhover æœ‰æç¤º
- [ ] ç‚¹å‡»å½“å‰æ­¥éª¤æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
- [ ] ç‚¹å‡»å·²å®Œæˆæ­¥éª¤ç›´æ¥è·³è½¬ï¼ˆåªè¯»æ¨¡å¼ï¼‰
- [ ] ç‚¹å‡»æœªå®Œæˆæ­¥éª¤æ— å“åº”ï¼ˆç¦ç”¨çŠ¶æ€ï¼‰

---

## ğŸ“Š API éªŒè¯

### ç«¯ç‚¹æµ‹è¯•

```bash
# ä½¿ç”¨ curl æµ‹è¯• API
curl -X POST http://localhost:3000/api/video-agent/projects/{project-id}/reset-from-step \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {your-token}" \
  -d '{"step": 3}'
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "success": true,
  "data": {
    "project": { ... },
    "resetResult": {
      "success": true,
      "project_id": "...",
      "reset_from_step": 3,
      "message": "Successfully reset project from step 3"
    },
    "message": "Successfully reset project from step 3"
  }
}
```

### é”™è¯¯å¤„ç†æµ‹è¯•

#### æµ‹è¯• 1: æ— æ•ˆçš„æ­¥éª¤ç¼–å·
```bash
curl -X POST .../reset-from-step \
  -d '{"step": 10}'
```
**é¢„æœŸ**ï¼š400 é”™è¯¯ï¼Œ"Invalid step number"

#### æµ‹è¯• 2: é¡¹ç›®ä¸å­˜åœ¨
```bash
curl -X POST .../projects/invalid-id/reset-from-step \
  -d '{"step": 3}'
```
**é¢„æœŸ**ï¼š404 é”™è¯¯ï¼Œ"Project not found"

#### æµ‹è¯• 3: æ— æƒé™è®¿é—®
ä½¿ç”¨å…¶ä»–ç”¨æˆ·çš„ token è®¿é—®é¡¹ç›®
**é¢„æœŸ**ï¼š403 é”™è¯¯ï¼Œ"Access denied"

---

## ğŸ› è¾¹ç•Œæƒ…å†µæµ‹è¯•

### æµ‹è¯• 1: é‡ç½®æ­¥éª¤ 1ï¼ˆå®Œå…¨é‡ç½®ï¼‰
- éªŒè¯æ‰€æœ‰æ•°æ®è¢«æ¸…ç©º
- éªŒè¯å¯ä»¥é‡æ–°å¼€å§‹æ•´ä¸ªæµç¨‹

### æµ‹è¯• 2: é‡ç½®æ­¥éª¤ 7ï¼ˆæœ€åä¸€æ­¥ï¼‰
- éªŒè¯åªæ¸…ç©ºæœ€ç»ˆè§†é¢‘æ•°æ®
- éªŒè¯å…¶ä»–æ­¥éª¤æ•°æ®ä¿ç•™

### æµ‹è¯• 3: è¿ç»­é‡ç½®
1. é‡ç½®åˆ°æ­¥éª¤ 3
2. ç«‹å³å†æ¬¡é‡ç½®åˆ°æ­¥éª¤ 2
3. éªŒè¯æ•°æ®ä¸€è‡´æ€§

### æµ‹è¯• 4: ç½‘ç»œä¸­æ–­
1. å¼€å§‹é‡ç½®
2. åœ¨é‡ç½®è¿‡ç¨‹ä¸­æ–­å¼€ç½‘ç»œ
3. éªŒè¯é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æ¢å¤

---

## ğŸ“ˆ æ€§èƒ½éªŒè¯

### é‡ç½®æ“ä½œæ€§èƒ½æŒ‡æ ‡

- âœ… ç¡®è®¤å¯¹è¯æ¡†æ‰“å¼€æ—¶é—´ < 100ms
- âœ… é‡ç½® API è°ƒç”¨å“åº”æ—¶é—´ < 2sï¼ˆå–å†³äºæ•°æ®é‡ï¼‰
- âœ… æ•°æ®åº“äº‹åŠ¡æ‰§è¡Œæ—¶é—´ < 1s
- âœ… UI æ›´æ–°å“åº”æ—¶é—´ < 200ms

### æ—¥å¿—è§‚æµ‹

```javascript
console.log('[StepDialog] ç‚¹å‡»å½“å‰æ­¥éª¤ 3ï¼Œæ˜¾ç¤ºé‡ç½®ç¡®è®¤å¯¹è¯æ¡†')
console.log('[StepDialog] å¼€å§‹é‡ç½®é¡¹ç›®ä»æ­¥éª¤ 3')
console.log('[Video Agent] Resetting project from step', { projectId, fromStep: 3 })
console.log('[Video Agent] Project reset successfully')
console.log('[StepDialog] é‡ç½®æˆåŠŸ', result)
```

---

## âš ï¸ å·²çŸ¥é™åˆ¶

1. **ç§¯åˆ†é€€è¿˜**ï¼šå½“å‰å®ç°ä¸æ”¯æŒç§¯åˆ†é€€è¿˜ã€‚å¦‚æœéœ€è¦ï¼Œéœ€è¦é¢å¤–å®ç°ç§¯åˆ†å›é€€é€»è¾‘ã€‚
2. **æ–‡ä»¶æ¸…ç†**ï¼šé‡ç½®æ—¶åªåˆ é™¤æ•°æ®åº“è®°å½•ï¼Œä¸ä¼šè‡ªåŠ¨åˆ é™¤ Supabase Storage ä¸­çš„æ–‡ä»¶ï¼ˆåˆ†é•œå›¾ã€è§†é¢‘æ–‡ä»¶ç­‰ï¼‰ã€‚éœ€è¦åå°ä»»åŠ¡æ¸…ç†ã€‚
3. **å®æ—¶åŒæ­¥**ï¼šå¦‚æœç”¨æˆ·åœ¨å¤šä¸ªè®¾å¤‡ä¸Šæ‰“å¼€åŒä¸€é¡¹ç›®ï¼Œé‡ç½®æ“ä½œä¸ä¼šå®æ—¶åŒæ­¥åˆ°å…¶ä»–è®¾å¤‡ã€‚

---

## ğŸš€ åç»­ä¼˜åŒ–ï¼ˆPhase 3ï¼‰

- [ ] æ·»åŠ  Toast æ¶ˆæ¯æç¤ºï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
- [ ] å®ç°ç§¯åˆ†é€€è¿˜é€»è¾‘
- [ ] è‡ªåŠ¨æ¸…ç† Storage æ–‡ä»¶
- [ ] å®æ—¶åŒæ­¥ï¼ˆWebSocketï¼‰
- [ ] æ’¤é”€é‡ç½®åŠŸèƒ½ï¼ˆ24å°æ—¶å†…å¯æ¢å¤ï¼‰
- [ ] æ‰¹é‡æ“ä½œï¼ˆé‡ç½®å¤šä¸ªæ­¥éª¤ï¼‰

---

## ğŸ“ æµ‹è¯•ç»“è®º

Phase 2 åŠŸèƒ½å·²å…¨éƒ¨å®ç°å¹¶é€šè¿‡æ„å»ºæµ‹è¯•ã€‚å»ºè®®æŒ‰ç…§ä¸Šè¿°åœºæ™¯è¿›è¡Œå®Œæ•´çš„æ‰‹åŠ¨æµ‹è¯•å’Œè‡ªåŠ¨åŒ–æµ‹è¯•ã€‚

**å¼€å‘è€…**ï¼šClaude Code
**æ—¥æœŸ**ï¼š2025-12-29
**çŠ¶æ€**ï¼šâœ… Phase 2 å®Œæˆ

# GTM & GA4 äº‹ä»¶è·Ÿè¸ªé…ç½®æ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº† VidFab é¡¹ç›®ä¸­é…ç½®çš„æ‰€æœ‰ GTM å’Œ GA4 äº‹ä»¶ï¼Œä»¥ä¾¿åœ¨ Google Analytics åå°è¿›è¡Œé…ç½®å’Œè½¬åŒ–è®¾ç½®ã€‚

---

## ğŸ“‹ ç›®å½•

- [åŸºæœ¬ä¿¡æ¯](#åŸºæœ¬ä¿¡æ¯)
- [äº‹ä»¶åˆ—è¡¨æ¦‚è§ˆ](#äº‹ä»¶åˆ—è¡¨æ¦‚è§ˆ)
- [è¯¦ç»†äº‹ä»¶è¯´æ˜](#è¯¦ç»†äº‹ä»¶è¯´æ˜)
  - [1. Purchase (è´­ä¹°è½¬åŒ–)](#1-purchase-è´­ä¹°è½¬åŒ–)
  - [2. Sign Up (ç”¨æˆ·æ³¨å†Œ)](#2-sign_up-ç”¨æˆ·æ³¨å†Œ)
  - [3. Login (ç”¨æˆ·ç™»å½•)](#3-login-ç”¨æˆ·ç™»å½•)
  - [4. Begin Checkout (å¼€å§‹ç»“è´¦)](#4-begin_checkout-å¼€å§‹ç»“è´¦)
  - [5. Billing Toggle (è®¡è´¹å‘¨æœŸåˆ‡æ¢)](#5-billing_toggle-è®¡è´¹å‘¨æœŸåˆ‡æ¢)
  - [6. Cancel Subscription (å–æ¶ˆè®¢é˜…)](#6-cancel_subscription-å–æ¶ˆè®¢é˜…)
- [GA4 åå°é…ç½®æ­¥éª¤](#ga4-åå°é…ç½®æ­¥éª¤)
- [è½¬åŒ–äº‹ä»¶è®¾ç½®](#è½¬åŒ–äº‹ä»¶è®¾ç½®)
- [å—ä¼—ç¾¤ä½“é…ç½®å»ºè®®](#å—ä¼—ç¾¤ä½“é…ç½®å»ºè®®)

---

## åŸºæœ¬ä¿¡æ¯

- **GTM æµ‹é‡ ID**: `G-NYQGR827GS`
- **å®æ–½æ–¹å¼**: é€šè¿‡ gtag.js ç›´æ¥åœ¨é¡µé¢ä¸­å¼•å…¥
- **ä»£ç ä½ç½®**: `app/layout.tsx` (å…¨å±€å¼•å…¥)
- **å·¥å…·å‡½æ•°åº“**: `lib/analytics/gtm.ts`

---

## äº‹ä»¶åˆ—è¡¨æ¦‚è§ˆ

| äº‹ä»¶åç§° | äº‹ä»¶ç±»å‹ | è§¦å‘ä½ç½® | ç”¨é€” |
|---------|---------|---------|------|
| `purchase` | GA4 æ ‡å‡†äº‹ä»¶ | è®¢é˜…æˆåŠŸé¡µé¢ | **è´­ä¹°è½¬åŒ–è·Ÿè¸ª** (æ¯ä¸ªå¥—é¤å•ç‹¬è®°å½•) |
| `sign_up` | GA4 æ ‡å‡†äº‹ä»¶ | æ³¨å†Œæµç¨‹ | æ–°ç”¨æˆ·æ³¨å†Œè·Ÿè¸ª |
| `login` | GA4 æ ‡å‡†äº‹ä»¶ | ç™»å½•æµç¨‹ | ç”¨æˆ·ç™»å½•è·Ÿè¸ª |
| `begin_checkout` | GA4 æ ‡å‡†äº‹ä»¶ | Pricing é¡µé¢ | å¼€å§‹ç»“è´¦æµç¨‹ |
| `billing_toggle` | è‡ªå®šä¹‰äº‹ä»¶ | Pricing é¡µé¢ | æœˆä»˜/å¹´ä»˜åˆ‡æ¢ |
| `cancel_subscription` | è‡ªå®šä¹‰äº‹ä»¶ | Pricing é¡µé¢ | å–æ¶ˆè®¢é˜… |

---

## è¯¦ç»†äº‹ä»¶è¯´æ˜

### 1. Purchase (è´­ä¹°è½¬åŒ–)

**äº‹ä»¶ç±»å‹**: GA4 æ ‡å‡†ç”µå•†äº‹ä»¶
**è§¦å‘æ—¶æœº**: ç”¨æˆ·å®Œæˆè®¢é˜…æ”¯ä»˜åï¼Œåœ¨è®¢é˜…æˆåŠŸé¡µé¢ (`/subscription/success`) åŠ è½½æ—¶è§¦å‘
**ä»£ç ä½ç½®**: `app/(main)/subscription/success/page.tsx`

#### äº‹ä»¶å‚æ•°ç»“æ„

```javascript
{
  event: 'purchase',
  transaction_id: 'cs_test_xxx' | 'sub_1234567890',  // Stripe session ID æˆ–è®¢é˜… ID
  value: 9.99,                                          // äº¤æ˜“é‡‘é¢ (ç¾å…ƒ)
  currency: 'USD',
  items: [
    {
      item_id: 'lite_monthly' | 'lite_annual' | 'pro_monthly' | 'pro_annual' | 'premium_monthly' | 'premium_annual',
      item_name: 'LITE Plan - Monthly',                // å¥—é¤æ˜¾ç¤ºåç§°
      item_category: 'subscription',
      item_variant: 'monthly' | 'annual',              // è®¡è´¹å‘¨æœŸ
      price: 9.99,
      quantity: 1
    }
  ],
  // è‡ªå®šä¹‰ç»´åº¦
  plan_id: 'lite' | 'pro' | 'premium',
  billing_cycle: 'monthly' | 'annual'
}
```

#### å¥—é¤ä»·æ ¼å¯¹ç…§è¡¨

| å¥—é¤ | æœˆä»˜ä»·æ ¼ (USD) | å¹´ä»˜ä»·æ ¼ (USD) | å¹´ä»˜æœˆå‡ (USD) |
|-----|--------------|--------------|--------------|
| Lite | $9.99 | $95.88 | $7.99 |
| Pro | $29.99 | $289.99 | $24.17 |
| Premium | $59.99 | $659.88 | $54.99 |

#### è½¬åŒ–å€¼è¯´æ˜

- **`transaction_id`**: æ¯æ¬¡è´­ä¹°çš„å”¯ä¸€æ ‡è¯†ç¬¦
- **`value`**:
  - æœˆä»˜: ä½¿ç”¨æœˆä»˜ä»·æ ¼
  - å¹´ä»˜: ä½¿ç”¨å¹´ä»˜æ€»ä»· (ä¾‹å¦‚ Lite å¹´ä»˜ä¸º $95.88)
- **`item_id`**: å¥—é¤ + è®¡è´¹å‘¨æœŸç»„åˆï¼Œå…± 6 ç§å¯èƒ½

---

### 2. Sign Up (ç”¨æˆ·æ³¨å†Œ)

**äº‹ä»¶ç±»å‹**: GA4 æ ‡å‡†äº‹ä»¶
**è§¦å‘æ—¶æœº**: ç”¨æˆ·é¦–æ¬¡æ³¨å†ŒæˆåŠŸæ—¶
**ä»£ç ä½ç½®**: `components/auth/unified-auth-modal.tsx`

#### äº‹ä»¶å‚æ•°ç»“æ„

```javascript
{
  event: 'sign_up',
  method: 'email' | 'google',    // æ³¨å†Œæ–¹å¼
  user_id: 'user_xxx'            // ç”¨æˆ·ID (å¯é€‰)
}
```

#### è§¦å‘åœºæ™¯

1. **Email æ³¨å†Œ**: ç”¨æˆ·é€šè¿‡éªŒè¯ç å®Œæˆé¦–æ¬¡æ³¨å†Œ
2. **Google æ³¨å†Œ**: ç”¨æˆ·é€šè¿‡ Google OAuth é¦–æ¬¡æ³¨å†Œ (æ³¨: å½“å‰å®ç°ä¸­ Google ç™»å½•ç»Ÿä¸€è§¦å‘ `login` äº‹ä»¶)

---

### 3. Login (ç”¨æˆ·ç™»å½•)

**äº‹ä»¶ç±»å‹**: GA4 æ ‡å‡†äº‹ä»¶
**è§¦å‘æ—¶æœº**: å·²æœ‰ç”¨æˆ·ç™»å½•æˆåŠŸæ—¶
**ä»£ç ä½ç½®**:
- `components/auth/unified-auth-modal.tsx` (Email ç™»å½•)
- `components/auth/google-login-button.tsx` (Google ç™»å½•)

#### äº‹ä»¶å‚æ•°ç»“æ„

```javascript
{
  event: 'login',
  method: 'email' | 'google'     // ç™»å½•æ–¹å¼
}
```

---

### 4. Begin Checkout (å¼€å§‹ç»“è´¦)

**äº‹ä»¶ç±»å‹**: GA4 æ ‡å‡†ç”µå•†äº‹ä»¶
**è§¦å‘æ—¶æœº**: ç”¨æˆ·åœ¨ Pricing é¡µé¢ç‚¹å‡»ä»»æ„å¥—é¤çš„ "Get Started" æŒ‰é’®æ—¶
**ä»£ç ä½ç½®**: `app/(main)/pricing/pricing-client.tsx`

#### äº‹ä»¶å‚æ•°ç»“æ„

```javascript
{
  event: 'begin_checkout',
  currency: 'USD',
  value: 9.99,                   // é¢„è®¡äº¤æ˜“é‡‘é¢
  items: [
    {
      item_id: 'lite_monthly',
      item_name: 'LITE Plan - Monthly',
      item_category: 'subscription',
      price: 9.99,
      quantity: 1
    }
  ],
  // è‡ªå®šä¹‰ç»´åº¦
  plan_id: 'lite' | 'pro' | 'premium',
  billing_cycle: 'monthly' | 'annual'
}
```

#### ä½¿ç”¨åœºæ™¯

- æ„å»ºè½¬åŒ–æ¼æ–—: `begin_checkout` â†’ `purchase`
- åˆ†æå“ªäº›å¥—é¤è¢«ç‚¹å‡»æœ€å¤šä½†æœªå®Œæˆæ”¯ä»˜
- è®¡ç®—ç»“è´¦è½¬åŒ–ç‡

---

### 5. Billing Toggle (è®¡è´¹å‘¨æœŸåˆ‡æ¢)

**äº‹ä»¶ç±»å‹**: è‡ªå®šä¹‰äº‹ä»¶
**è§¦å‘æ—¶æœº**: ç”¨æˆ·åœ¨ Pricing é¡µé¢åˆ‡æ¢ "Monthly" å’Œ "Annual" å¼€å…³æ—¶
**ä»£ç ä½ç½®**: `app/(main)/pricing/pricing-client.tsx`

#### äº‹ä»¶å‚æ•°ç»“æ„

```javascript
{
  event: 'billing_toggle',
  billing_cycle: 'monthly' | 'annual'  // åˆ‡æ¢åçš„è®¡è´¹å‘¨æœŸ
}
```

#### ä½¿ç”¨åœºæ™¯

- åˆ†æç”¨æˆ·å¯¹å¹´ä»˜å¥—é¤çš„å…´è¶£
- ç»Ÿè®¡å¹´ä»˜ä¸æœˆä»˜çš„é€‰æ‹©åå¥½
- A/B æµ‹è¯•å¹´ä»˜æŠ˜æ‰£åŠ›åº¦

---

### 6. Cancel Subscription (å–æ¶ˆè®¢é˜…)

**äº‹ä»¶ç±»å‹**: è‡ªå®šä¹‰äº‹ä»¶
**è§¦å‘æ—¶æœº**: ç”¨æˆ·åœ¨ Pricing é¡µé¢ç‚¹å‡» "Cancel Subscription" æŒ‰é’®æ—¶
**ä»£ç ä½ç½®**: `app/(main)/pricing/pricing-client.tsx`

#### äº‹ä»¶å‚æ•°ç»“æ„

```javascript
{
  event: 'cancel_subscription',
  plan_id: 'lite' | 'pro' | 'premium'  // è¢«å–æ¶ˆçš„å¥—é¤
}
```

#### ä½¿ç”¨åœºæ™¯

- åˆ†æç”¨æˆ·æµå¤±ç‡
- ç»Ÿè®¡å“ªä¸ªå¥—é¤çš„å–æ¶ˆç‡æœ€é«˜
- ä¼˜åŒ–ç”¨æˆ·ç•™å­˜ç­–ç•¥

---

## GA4 åå°é…ç½®æ­¥éª¤

### æ­¥éª¤ 1: éªŒè¯äº‹ä»¶æ¥æ”¶

1. ç™»å½• [Google Analytics](https://analytics.google.com/)
2. é€‰æ‹©å±æ€§ `G-NYQGR827GS`
3. è¿›å…¥ **æŠ¥å‘Š** â†’ **å®æ—¶** æŸ¥çœ‹å®æ—¶äº‹ä»¶
4. è§¦å‘å„é¡¹æ“ä½œï¼Œç¡®è®¤äº‹ä»¶æ­£å¸¸ä¸ŠæŠ¥

### æ­¥éª¤ 2: è‡ªå®šä¹‰ç»´åº¦é…ç½®

ä¸ºäº†æ›´å¥½åœ°åˆ†ææ•°æ®ï¼Œå»ºè®®é…ç½®ä»¥ä¸‹è‡ªå®šä¹‰ç»´åº¦:

1. è¿›å…¥ **ç®¡ç†** â†’ **è‡ªå®šä¹‰å®šä¹‰** â†’ **åˆ›å»ºè‡ªå®šä¹‰ç»´åº¦**
2. æ·»åŠ ä»¥ä¸‹ç»´åº¦:

| ç»´åº¦åç§° | å‚æ•°åç§° | èŒƒå›´ | è¯´æ˜ |
|---------|---------|------|------|
| å¥—é¤ç±»å‹ | `plan_id` | äº‹ä»¶ | lite/pro/premium |
| è®¡è´¹å‘¨æœŸ | `billing_cycle` | äº‹ä»¶ | monthly/annual |
| å•†å“ID | `item_id` | å•†å“ | å¥—é¤+å‘¨æœŸç»„åˆ |

### æ­¥éª¤ 3: åˆ›å»ºè‡ªå®šä¹‰æŠ¥å‘Š

å»ºè®®åˆ›å»ºä»¥ä¸‹æŠ¥å‘Š:

#### è®¢é˜…è½¬åŒ–æŠ¥å‘Š
- **ç»´åº¦**: `plan_id`, `billing_cycle`
- **æŒ‡æ ‡**: è½¬åŒ–æ¬¡æ•°ã€è½¬åŒ–ä»·å€¼ã€å¹³å‡è®¢å•ä»·å€¼
- **ç­›é€‰å™¨**: `event_name = purchase`

#### æ³¨å†Œæ¥æºæŠ¥å‘Š
- **ç»´åº¦**: `method` (email/google)
- **æŒ‡æ ‡**: æ³¨å†Œæ•°ã€è½¬åŒ–ä¸ºä»˜è´¹ç”¨æˆ·æ•°
- **ç­›é€‰å™¨**: `event_name = sign_up`

#### ç»“è´¦æ¼æ–—æŠ¥å‘Š
- **äº‹ä»¶åºåˆ—**: `begin_checkout` â†’ `purchase`
- **åˆ†æ**: æ¯ä¸ªå¥—é¤çš„ç»“è´¦è½¬åŒ–ç‡

---

## è½¬åŒ–äº‹ä»¶è®¾ç½®

### æ¨èè®¾ç½®ä¸ºè½¬åŒ–çš„äº‹ä»¶

åœ¨ GA4 ä¸­å°†ä»¥ä¸‹äº‹ä»¶æ ‡è®°ä¸ºè½¬åŒ–:

#### 1. Purchase (ä¸»è¦è½¬åŒ–)

**è·¯å¾„**: ç®¡ç† â†’ è½¬åŒ– â†’ æ–°å»ºè½¬åŒ–äº‹ä»¶

- **äº‹ä»¶åç§°**: `purchase`
- **è½¬åŒ–ä»·å€¼**: ä½¿ç”¨äº‹ä»¶å‚æ•° `value`
- **è½¬åŒ–ç±»å‹**: è´­ä¹°

#### 2. æŒ‰å¥—é¤åˆ†åˆ«è®¾ç½®è½¬åŒ– (å¯é€‰)

ä¸ºæ¯ä¸ªå¥—é¤åˆ›å»ºå•ç‹¬çš„è½¬åŒ–ç›®æ ‡:

| è½¬åŒ–åç§° | äº‹ä»¶æ¡ä»¶ |
|---------|---------|
| Purchase - Lite Monthly | `event_name = purchase` AND `item_id = lite_monthly` |
| Purchase - Lite Annual | `event_name = purchase` AND `item_id = lite_annual` |
| Purchase - Pro Monthly | `event_name = purchase` AND `item_id = pro_monthly` |
| Purchase - Pro Annual | `event_name = purchase` AND `item_id = pro_annual` |
| Purchase - Premium Monthly | `event_name = purchase` AND `item_id = premium_monthly` |
| Purchase - Premium Annual | `event_name = purchase` AND `item_id = premium_annual` |

**è®¾ç½®æ–¹æ³•**:
1. è¿›å…¥ **ç®¡ç†** â†’ **è½¬åŒ–**
2. ç‚¹å‡» **æ–°å»ºè½¬åŒ–äº‹ä»¶**
3. é€‰æ‹© **åˆ›å»ºè‡ªå®šä¹‰äº‹ä»¶**
4. è®¾ç½®æ¡ä»¶åŒ¹é…è§„åˆ™

#### 3. Sign Up (æ¬¡è¦è½¬åŒ–)

- **äº‹ä»¶åç§°**: `sign_up`
- **è½¬åŒ–ç±»å‹**: æ³¨å†Œ
- **ç”¨é€”**: è¡¡é‡æ–°ç”¨æˆ·è·å–æˆæœ¬

---

## å—ä¼—ç¾¤ä½“é…ç½®å»ºè®®

### 1. é«˜ä»·å€¼ç”¨æˆ·

**æ¡ä»¶**:
- è§¦å‘è¿‡ `purchase` äº‹ä»¶
- `plan_id` = `pro` æˆ– `premium`

**ç”¨é€”**: å†è¥é”€ã€å¿ è¯šåº¦è®¡åˆ’

### 2. è´­ç‰©è½¦æ”¾å¼ƒç”¨æˆ·

**æ¡ä»¶**:
- è§¦å‘è¿‡ `begin_checkout` äº‹ä»¶
- ä½†æœªè§¦å‘ `purchase` äº‹ä»¶
- æ—¶é—´èŒƒå›´: æœ€è¿‘ 7 å¤©

**ç”¨é€”**: å†è¥é”€ã€ä¼˜æƒ åˆ¸æ¨é€

### 3. è¯•ç”¨è½¬åŒ–ç”¨æˆ·

**æ¡ä»¶**:
- è§¦å‘è¿‡ `sign_up` äº‹ä»¶
- ä¸”åœ¨ 30 å¤©å†…è§¦å‘ `purchase` äº‹ä»¶

**ç”¨é€”**: åˆ†æè¯•ç”¨è½¬åŒ–è·¯å¾„

### 4. å¹´ä»˜åå¥½ç”¨æˆ·

**æ¡ä»¶**:
- è§¦å‘è¿‡ `billing_toggle` äº‹ä»¶
- `billing_cycle` = `annual`
- ä½†æœªå®Œæˆè´­ä¹°

**ç”¨é€”**: é’ˆå¯¹æ€§æ¨å¹¿å¹´ä»˜ä¼˜æƒ 

### 5. æµå¤±é£é™©ç”¨æˆ·

**æ¡ä»¶**:
- è§¦å‘è¿‡ `cancel_subscription` äº‹ä»¶

**ç”¨é€”**: æŒ½ç•™è¥é”€ã€æ»¡æ„åº¦è°ƒæŸ¥

---

## æ•°æ®éªŒè¯æ¸…å•

é…ç½®å®Œæˆåï¼Œè¯·éªŒè¯ä»¥ä¸‹å†…å®¹:

- [ ] æ‰€æœ‰ 6 ä¸ªäº‹ä»¶éƒ½èƒ½åœ¨ GA4 å®æ—¶æŠ¥å‘Šä¸­çœ‹åˆ°
- [ ] `purchase` äº‹ä»¶çš„è½¬åŒ–ä»·å€¼æ­£ç¡®æ˜¾ç¤º
- [ ] è‡ªå®šä¹‰ç»´åº¦ `plan_id` å’Œ `billing_cycle` æ­£ç¡®å¡«å……
- [ ] ç”µå•†æŠ¥å‘Šä¸­èƒ½çœ‹åˆ°å„å¥—é¤çš„é”€å”®æ•°æ®
- [ ] è½¬åŒ–æ¼æ–— `begin_checkout` â†’ `purchase` æ•°æ®å®Œæ•´
- [ ] æŒ‰æ³¨å†Œæ–¹å¼ (email/google) çš„ç”¨æˆ·ç»†åˆ†æ­£å¸¸

---

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆ Google ç™»å½•åªè§¦å‘ login äº‹ä»¶è€Œä¸åŒºåˆ† sign_up?

A: å½“å‰å®ç°ä¸­,ç”±äº Google OAuth æµç¨‹æ— æ³•åœ¨å®¢æˆ·ç«¯ç›´æ¥åˆ¤æ–­ç”¨æˆ·æ˜¯é¦–æ¬¡æ³¨å†Œè¿˜æ˜¯é‡å¤ç™»å½•,å› æ­¤ç»Ÿä¸€è§¦å‘ `login` äº‹ä»¶ã€‚å¦‚éœ€åŒºåˆ†,éœ€è¦åœ¨åç«¯è¿”å› `isNewUser` æ ‡è¯†ã€‚

### Q: Purchase äº‹ä»¶ä»€ä¹ˆæ—¶å€™è§¦å‘?

A: åœ¨ç”¨æˆ·å®Œæˆ Stripe æ”¯ä»˜å¹¶è·³è½¬åˆ°è®¢é˜…æˆåŠŸé¡µé¢ (`/subscription/success`) å,ä¼šå»¶è¿Ÿ 3 ç§’è·å–è®¢é˜…çŠ¶æ€,ç¡®è®¤æˆåŠŸåè§¦å‘ purchase äº‹ä»¶ã€‚

### Q: å¦‚ä½•æµ‹è¯•äº‹ä»¶æ˜¯å¦æ­£å¸¸ä¸ŠæŠ¥?

A:
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
2. åˆ‡æ¢åˆ° Console æ ‡ç­¾
3. æ‰§è¡Œç›¸åº”æ“ä½œ (å¦‚æ³¨å†Œã€è´­ä¹°ç­‰)
4. æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º `âœ… GTM xxx Event Tracked` æ—¥å¿—
5. åŒæ—¶åœ¨ GA4 å®æ—¶æŠ¥å‘Šä¸­éªŒè¯

### Q: è½¬åŒ–ä»·å€¼æ˜¾ç¤ºä¸º 0 æ€ä¹ˆåŠ?

A: æ£€æŸ¥ `trackPurchase()` å‡½æ•°ä¸­çš„ `value` å‚æ•°æ˜¯å¦æ­£ç¡®ä¼ é€’,ç¡®ä¿ä¼ å…¥çš„æ˜¯ç¾å…ƒé‡‘é¢ (æ•°å­—ç±»å‹),è€Œä¸æ˜¯ç¾åˆ†ã€‚

---

## è”ç³»æ–¹å¼

å¦‚æœ‰é…ç½®é—®é¢˜,è¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–å‚è€ƒ:
- [GA4 å®˜æ–¹æ–‡æ¡£](https://support.google.com/analytics/answer/9267735)
- [GA4 ç”µå•†äº‹ä»¶å‚è€ƒ](https://developers.google.com/analytics/devguides/collection/ga4/ecommerce)
- é¡¹ç›®ä»£ç : `lib/analytics/gtm.ts`

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-14
**ç»´æŠ¤è€…**: VidFab å¼€å‘å›¢é˜Ÿ

# è§†é¢‘ç¼©ç•¥å›¾é—®é¢˜è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

åœ¨ Phase 2 è¿ç§»è¿‡ç¨‹ä¸­,å‘ç°è§†é¢‘ç¼©ç•¥å›¾åŠŸèƒ½å­˜åœ¨é—®é¢˜:
- âœ… **æœ¬åœ°**: ä½¿ç”¨ ffmpeg å¯ä»¥æ­£å¸¸ç”Ÿæˆç¼©ç•¥å›¾
- âŒ **Vercel**: serverless ç¯å¢ƒæ²¡æœ‰ ffmpeg,æ— æ³•æå–è§†é¢‘å¸§

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### æ—§æ–¹æ¡ˆ (å¤±è´¥)
```typescript
// ä½¿ç”¨ ffmpeg æå–è§†é¢‘ç¬¬ä¸€å¸§
const thumbnailResult = await extractVideoThumbnail(videoBuffer, {
  timestamp: 0.1,
  format: 'webp',
  maxWidth: 1280,
  maxHeight: 720,
})
```

**é—®é¢˜**:
- âŒ Vercel serverless ç¯å¢ƒæ²¡æœ‰ ffmpeg
- âŒ éœ€è¦ä¸‹è½½æ•´ä¸ªè§†é¢‘(è€—æ—¶ã€è€—æµé‡)
- âŒ å¤„ç†å¤§è§†é¢‘æ—¶å¯èƒ½è¶…æ—¶

### å°è¯•æ–¹æ¡ˆ 1: Cloudinary Fetch (å¤±è´¥)
```typescript
// ä½¿ç”¨ Cloudinary çš„ fetch åŠŸèƒ½ç›´æ¥ä» URL ç”Ÿæˆç¼©ç•¥å›¾
const thumbnailUrl = CloudinaryThumbnailService.generateFromUrl(originalUrl, {
  width: 1280,
  height: 720,
  timeOffset: 0.1,
})
```

**é—®é¢˜**:
- âŒ Cloudinary è¿”å› 404 - "Resource not found"
- âŒ å…è´¹å¥—é¤å¯èƒ½æœªå¯ç”¨ fetch åŠŸèƒ½
- âŒ æˆ–æºè§†é¢‘ URL æ— æ³•è¢« Cloudinary è®¿é—®

### å½“å‰æ–¹æ¡ˆ: ä½¿ç”¨è§†é¢‘ URL (ä¸´æ—¶)

**ä»£ç **: `app/api/video/store/route.ts:141-150`

```typescript
// æ–¹æ¡ˆ B: ç›´æ¥ä½¿ç”¨è§†é¢‘ URL ä½œä¸ºç¼©ç•¥å›¾è·¯å¾„
// å‰ç«¯ä¼šä½¿ç”¨ <video> æ ‡ç­¾è‡ªåŠ¨æ˜¾ç¤ºç¬¬ä¸€å¸§ä½œä¸ºå°é¢
let thumbnailPath: string | null = originalUrl

console.log('â„¹ï¸  Using video URL as thumbnail (browser renders first frame)')
```

**ä¼˜åŠ¿**:
- âœ… ç®€å•å¯é ,ç«‹å³å¯ç”¨
- âœ… æ— éœ€é¢å¤–å¤„ç†æˆ–ç¬¬ä¸‰æ–¹æœåŠ¡
- âœ… Vercel éƒ¨ç½²åä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ
- âœ… æµè§ˆå™¨è‡ªåŠ¨å¤„ç†è§†é¢‘ç¬¬ä¸€å¸§æ˜¾ç¤º

**é™åˆ¶**:
- âš ï¸  ç”¨æˆ·éœ€è¦ä¸‹è½½éƒ¨åˆ†è§†é¢‘æ‰èƒ½çœ‹åˆ°å°é¢
- âš ï¸  ç½‘é€Ÿæ…¢æ—¶å¯èƒ½æ˜¾ç¤ºç©ºç™½
- âš ï¸  æ— æ³•è‡ªå®šä¹‰ç¼©ç•¥å›¾æ—¶é—´ç‚¹

## ğŸ¯ æœªæ¥è§£å†³æ–¹æ¡ˆ

### Phase 3 æ–¹æ¡ˆ (æ¨è)

**ä½¿ç”¨ Supabase Edge Functions + ffmpeg**

```typescript
// Supabase Edge Function (Deno runtime,æ”¯æŒ Docker å®¹å™¨)
import { serve } from 'https://deno.land/std/http/server.ts'

serve(async (req) => {
  // 1. ä¸‹è½½è§†é¢‘
  // 2. ä½¿ç”¨ ffmpeg æå–å¸§
  // 3. ä¸Šä¼ åˆ° Supabase Storage
  // 4. è¿”å›ç¼©ç•¥å›¾ URL
})
```

**ä¼˜åŠ¿**:
- âœ… å®Œå…¨æ§åˆ¶,æ— éœ€ç¬¬ä¸‰æ–¹æœåŠ¡
- âœ… Supabase Edge Functions æ”¯æŒ Docker,å¯å®‰è£… ffmpeg
- âœ… ä¸ç°æœ‰ Supabase åŸºç¡€è®¾æ–½é›†æˆ
- âœ… æˆæœ¬å¯æ§

### å¤‡é€‰æ–¹æ¡ˆ

#### 1. ç¬¬ä¸‰æ–¹æˆªå›¾æœåŠ¡

**ApiFlash** (æ¨è)
- ä»·æ ¼: $9/æœˆ (1000 æˆªå›¾)
- API: `https://api.apiflash.com/v1/urltoimage?url=VIDEO_URL&time=1`
- æ–‡æ¡£: https://apiflash.com/

**ScreenshotOne**
- ä»·æ ¼: $12/æœˆ (1000 æˆªå›¾)
- æ”¯æŒè§†é¢‘æˆªå›¾
- æ–‡æ¡£: https://screenshotone.com/

#### 2. Cloudinary Upload æ–¹æ¡ˆ

```typescript
// ä¸Šä¼ è§†é¢‘åˆ° Cloudinary,ç„¶åç”Ÿæˆç¼©ç•¥å›¾
const result = await CloudinaryThumbnailService.uploadVideo(
  videoBuffer,
  videoId,
  'vidfab-videos'
)

// Cloudinary è‡ªåŠ¨ç”Ÿæˆç¼©ç•¥å›¾
const thumbnailUrl = result.thumbnailUrl
```

**æˆæœ¬**:
- å…è´¹å¥—é¤: 25GB å­˜å‚¨, 25GB å¸¦å®½
- ä»˜è´¹å¥—é¤: $89/æœˆèµ·
- âš ï¸  æˆæœ¬è¾ƒé«˜,ä¸æ¨è

#### 3. AWS Lambda + ffmpeg Layer

```typescript
// éƒ¨ç½²ç‹¬ç«‹çš„ Lambda å‡½æ•°,ä½¿ç”¨ ffmpeg layer
// è§¦å‘: S3 äº‹ä»¶æˆ– API Gateway
// è¾“å‡º: ä¸Šä¼ ç¼©ç•¥å›¾åˆ° S3/Supabase
```

**å¤æ‚åº¦**: ä¸­ç­‰
**æˆæœ¬**: ä½ (~$1/æœˆ)
**ç»´æŠ¤**: éœ€è¦ç®¡ç† Lambda å‡½æ•°

## ğŸ“… å®æ–½è®¡åˆ’

### å½“å‰ (Phase 2)
- âœ… ä½¿ç”¨è§†é¢‘ URL ä½œä¸ºç¼©ç•¥å›¾
- âœ… ç¡®ä¿åŠŸèƒ½å¯ç”¨,ä¼˜å…ˆéƒ¨ç½²

### Phase 3 (Supabase è¿ç§»)
- [ ] è¯„ä¼° Supabase Edge Functions + ffmpeg
- [ ] å®ç°ç¼©ç•¥å›¾ç”Ÿæˆå‡½æ•°
- [ ] æ›´æ–° Inngest ä»»åŠ¡è°ƒç”¨ Edge Function
- [ ] æµ‹è¯•å’Œéƒ¨ç½²

### å¤‡é€‰ (å¦‚æœ Edge Functions ä¸å¯è¡Œ)
- [ ] é€‰æ‹©ç¬¬ä¸‰æ–¹æœåŠ¡ (æ¨è ApiFlash)
- [ ] é›†æˆ API
- [ ] æ›´æ–°ä»£ç è°ƒç”¨ç¬¬ä¸‰æ–¹æœåŠ¡

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `app/api/video/store/route.ts` - è§†é¢‘ä¿å­˜ API
- `lib/discover/extract-thumbnail.ts` - æ—§çš„ ffmpeg å®ç°
- `lib/cloudinary.ts` - Cloudinary é…ç½®
- `lib/inngest/functions/video-processing.ts` - Inngest ç¼©ç•¥å›¾ä»»åŠ¡

## ğŸ“Š æˆæœ¬å¯¹æ¯”

| æ–¹æ¡ˆ | æœˆæˆæœ¬ | å¤æ‚åº¦ | å¯é æ€§ | æ¨èåº¦ |
|------|--------|--------|--------|---------|
| **è§†é¢‘ URL** | $0 | æä½ | é«˜ | â­â­â­ (ä¸´æ—¶) |
| **Supabase Edge Functions** | ~$5 | ä¸­ | é«˜ | â­â­â­â­â­ (é•¿æœŸ) |
| **ApiFlash** | $9 | ä½ | é«˜ | â­â­â­â­ |
| **Cloudinary Upload** | $89+ | ä½ | æé«˜ | â­â­ (è´µ) |
| **AWS Lambda** | ~$1 | ä¸­é«˜ | é«˜ | â­â­â­ |

## âœ… æ€»ç»“

**å½“å‰çŠ¶æ€**:
- ä½¿ç”¨è§†é¢‘ URL ä½œä¸ºç¼©ç•¥å›¾,åŠŸèƒ½æ­£å¸¸
- ç”¨æˆ·ä½“éªŒç•¥æœ‰å½±å“,ä½†å¯æ¥å—

**ä¸‹ä¸€æ­¥**:
- Phase 3 è¿ç§»æ—¶å®æ–½ Supabase Edge Functions æ–¹æ¡ˆ
- æˆ–é€‰æ‹© ApiFlash ä½œä¸ºå¿«é€Ÿè§£å†³æ–¹æ¡ˆ

**ä¼˜å…ˆçº§**: ä¸­ç­‰ (ä¸é˜»å¡éƒ¨ç½²,å¯åœ¨ Phase 3 ä¼˜åŒ–)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¶é—´**: 2025-12-05
**ä½œè€…**: Claude (AI Assistant)

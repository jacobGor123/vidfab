# è°ƒè¯• "ç”¨æˆ·æœ‰ 10 ç§¯åˆ†ä½†æç¤º Insufficient credits" é—®é¢˜

## é—®é¢˜æè¿°
ç”¨æˆ·å‰©ä½™ 10 ç§¯åˆ†,åˆ›å»ºè§†é¢‘ä»»åŠ¡éœ€è¦ 10 ç§¯åˆ†,ä½†ç³»ç»Ÿæç¤º "Insufficient credits"ã€‚

## ä»£ç é€»è¾‘éªŒè¯ç»“æœ
âœ… æ‰€æœ‰æ¯”è¾ƒé€»è¾‘éƒ½æ˜¯æ­£ç¡®çš„ (`>=` å’Œ `<` åˆ¤æ–­æ­£ç¡®)
âœ… ç§¯åˆ†è®¡ç®—é€»è¾‘æ­£ç¡® (480p-5s = 10 ç§¯åˆ†)
âœ… 10 ç§¯åˆ†ç†è®ºä¸Šåº”è¯¥å¯ä»¥ç”Ÿæˆ 10 ç§¯åˆ†çš„è§†é¢‘

## éœ€è¦æ’æŸ¥çš„å¯èƒ½åŸå› 

### 1ï¸âƒ£ å®é™…æ‰€éœ€ç§¯åˆ†ä¸æ˜¯ 10
**æ£€æŸ¥æ­¥éª¤:**
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
2. åˆ‡æ¢åˆ° Network æ ‡ç­¾é¡µ
3. å°è¯•ç”Ÿæˆè§†é¢‘
4. æ‰¾åˆ°å¤±è´¥çš„ API è¯·æ±‚ (å¯èƒ½æ˜¯ `/api/video/generate` æˆ– `/api/video/generate-image-to-video`)
5. æŸ¥çœ‹è¯·æ±‚å‚æ•°å’Œå“åº”

**éœ€è¦ç¡®è®¤çš„å‚æ•°:**
- `model`: åº”è¯¥æ˜¯ `vidfab-q1` æˆ– `vidfab-pro`
- `resolution`: åº”è¯¥æ˜¯ `480p`ã€`720p` æˆ– `1080p`
- `duration`: åº”è¯¥æ˜¯æ•°å­— `5` æˆ– `10`

**è®¡ç®—å…¬å¼:**
```
vidfab-q1 (seedanceæ¨¡å‹):
- 480p-5s = 10 ç§¯åˆ† âœ…
- 480p-10s = 20 ç§¯åˆ†
- 720p-5s = 20 ç§¯åˆ†
- 720p-10s = 40 ç§¯åˆ†
- 1080p-5s = 40 ç§¯åˆ†
- 1080p-10s = 80 ç§¯åˆ†

vidfab-pro (veo3æ¨¡å‹):
- 720p-5s = 70 ç§¯åˆ†
- 720p-8s = 100 ç§¯åˆ†
- 1080p-5s = 90 ç§¯åˆ†
- 1080p-8s = 130 ç§¯åˆ†
```

**å¦‚æœ API è¿”å›çš„ `requiredCredits` ä¸æ˜¯ 10,é‚£å°±æ˜¯å‚æ•°ä¼ é€’æœ‰é—®é¢˜ã€‚**

---

### 2ï¸âƒ£ æ•°æ®åº“ä¸­çš„å®é™…ç§¯åˆ†ä¸æ˜¯ 10
**æ£€æŸ¥æ­¥éª¤:**
1. æŸ¥çœ‹å‰ç«¯æ˜¾ç¤ºçš„ç§¯åˆ†ä½™é¢
2. æ‰“å¼€æ•°æ®åº“ç®¡ç†å·¥å…·
3. æŸ¥è¯¢ç”¨æˆ·è¡¨:
   ```sql
   SELECT uuid, email, credits_remaining
   FROM users
   WHERE email = 'ä½ çš„é‚®ç®±åœ°å€';
   ```
4. ç¡®è®¤ `credits_remaining` å­—æ®µçš„å€¼

**å¯èƒ½çš„é—®é¢˜:**
- å‰ç«¯ç¼“å­˜çš„ç§¯åˆ†æ•°æ®è¿‡æœŸ
- å…¶ä»–é¡µé¢/æ ‡ç­¾é¡µå·²ç»æ¶ˆè´¹äº†ç§¯åˆ†
- æœ‰éšè—çš„ç§¯åˆ†æ‰£é™¤é€»è¾‘

---

### 3ï¸âƒ£ å‰ç«¯é¢„æ£€é˜¶æ®µå°±è¢«æ‹¦æˆª
**æ£€æŸ¥æ­¥éª¤:**
1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å° (F12 -> Console æ ‡ç­¾)
2. å°è¯•ç”Ÿæˆè§†é¢‘
3. æŸ¥çœ‹æ˜¯å¦æœ‰ä»¥ä¸‹æ—¥å¿—:
   - `"æƒé™æ£€æŸ¥å¤±è´¥"` (å‰ç«¯é¢„æ£€)
   - `"ç§¯åˆ†æ£€æŸ¥å¤±è´¥"` (åç«¯æ£€æŸ¥)
   - `"ç§¯åˆ†æ‰£é™¤å¤±è´¥"` (åç«¯æ‰£é™¤)

**å¦‚æœæ˜¯å‰ç«¯é¢„æ£€å¤±è´¥:**
- ä½ç½®: `image-to-video-panel.tsx:322-344` æˆ–ç±»ä¼¼ä½ç½®
- åŸå› : `checkCreditsAvailability` è¿”å› `can_afford: false`
- è§£å†³: éœ€è¦æŸ¥çœ‹å‰ç«¯ç¼“å­˜çš„ `creditsInfo.credits` å€¼

**å¦‚æœæ˜¯åç«¯æ£€æŸ¥å¤±è´¥:**
- ä½ç½®: `app/api/video/generate/route.ts:127-139`
- åŸå› : `checkUserCredits` è¿”å› `canAfford: false`
- è§£å†³: éœ€è¦æ£€æŸ¥æ•°æ®åº“ä¸­çš„å®é™…ç§¯åˆ†

---

### 4ï¸âƒ£ å¹¶å‘è¯·æ±‚å¯¼è‡´ç§¯åˆ†è¢«é‡å¤æ£€æŸ¥
**æ£€æŸ¥æ­¥éª¤:**
1. æŸ¥çœ‹ Network æ ‡ç­¾é¡µ
2. ç¡®è®¤æ˜¯å¦æœ‰å¤šä¸ªåŒæ—¶è¿›è¡Œçš„ API è¯·æ±‚
3. æŸ¥çœ‹åç«¯æ—¥å¿—,æ˜¯å¦æœ‰å¤šæ¬¡ç§¯åˆ†æ£€æŸ¥

**å¯èƒ½çš„é—®é¢˜:**
- ç”¨æˆ·å¿«é€Ÿç‚¹å‡»äº†å¤šæ¬¡ç”ŸæˆæŒ‰é’®
- æµè§ˆå™¨é‡å¤å‘é€äº†è¯·æ±‚
- æœ‰å…¶ä»–è‡ªåŠ¨è§¦å‘çš„ç§¯åˆ†æ£€æŸ¥

---

## è¯¦ç»†è°ƒè¯•æ­¥éª¤

### Step 1: æŸ¥çœ‹ API å“åº”
åœ¨æµè§ˆå™¨ Network æ ‡ç­¾é¡µä¸­,æ‰¾åˆ°å¤±è´¥çš„è¯·æ±‚,åº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„å“åº”:

```json
{
  "error": "Insufficient credits",
  "code": "INSUFFICIENT_CREDITS",
  "message": "You need 20 credits but only have 10. Please upgrade your plan.",
  "requiredCredits": 20,  // âš ï¸ å…³é”®!æŸ¥çœ‹è¿™ä¸ªå€¼æ˜¯ä¸æ˜¯çœŸçš„ 10
  "userCredits": 10
}
```

**å¦‚æœ `requiredCredits` æ˜¯ 20 è€Œä¸æ˜¯ 10:**
â†’ è¯´æ˜ä½ é€‰æ‹©çš„å‚æ•°ç»„åˆéœ€è¦ 20 ç§¯åˆ†,å¯èƒ½æ˜¯:
- resolution æ˜¯ `720p` è€Œä¸æ˜¯ `480p`
- duration æ˜¯ `10s` è€Œä¸æ˜¯ `5s`
- æˆ–è€…å…¶ä»–å‚æ•°

### Step 2: æ£€æŸ¥è¯·æ±‚å‚æ•°
åœ¨åŒä¸€ä¸ª API è¯·æ±‚ä¸­,æŸ¥çœ‹ Request Payload:

```json
{
  "prompt": "...",
  "model": "vidfab-q1",      // âš ï¸ ç¡®è®¤æ˜¯ vidfab-q1
  "resolution": "480p",      // âš ï¸ ç¡®è®¤æ˜¯ 480p
  "duration": 5,             // âš ï¸ ç¡®è®¤æ˜¯ 5
  "aspectRatio": "16:9"
}
```

### Step 3: æŸ¥çœ‹å‰ç«¯ç§¯åˆ†æ˜¾ç¤º
åœ¨ `/create` é¡µé¢,åº”è¯¥æœ‰ç§¯åˆ†ä½™é¢æ˜¾ç¤ºã€‚ç¡®è®¤:
1. æ˜¾ç¤ºçš„ç§¯åˆ†æ•°æ˜¯ä¸æ˜¯ 10
2. ç”ŸæˆæŒ‰é’®æ—è¾¹æ˜¾ç¤ºçš„æ‰€éœ€ç§¯åˆ†æ˜¯ä¸æ˜¯ 10

### Step 4: åˆ·æ–°ç§¯åˆ†ç¼“å­˜
å°è¯•ä»¥ä¸‹æ“ä½œ:
1. åˆ·æ–°æµè§ˆå™¨é¡µé¢ (F5)
2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
3. é‡æ–°ç™»å½•è´¦å·

---

## å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: å‰ç«¯å¼ºåˆ¶åˆ·æ–°ç§¯åˆ†
ä¿®æ”¹ `handleGenerate` å‡½æ•°,åœ¨ç”Ÿæˆå‰å¼ºåˆ¶åˆ·æ–°ç§¯åˆ†:

```typescript
const handleGenerate = useCallback(async () => {
  // âœ… å¼ºåˆ¶åˆ·æ–°ç§¯åˆ†
  await refreshCredits()

  // ç„¶åç»§ç»­åŸæœ‰é€»è¾‘...
}, [...])
```

### æ–¹æ¡ˆ 2: æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
åœ¨å‰ç«¯æ·»åŠ æ›´å¤šæ—¥å¿—,å¸®åŠ©å®šä½é—®é¢˜:

```typescript
// åœ¨å‰ç«¯é¢„æ£€éƒ¨åˆ†
const budgetInfo = await checkCreditsAvailability(params.model, params.resolution, params.duration)
console.log('ğŸ” ç§¯åˆ†é¢„æ£€ç»“æœ:', {
  model: params.model,
  resolution: params.resolution,
  duration: params.duration,
  current_balance: budgetInfo.current_balance,
  required_credits: budgetInfo.required_credits,
  can_afford: budgetInfo.can_afford
})

if (!budgetInfo.can_afford) {
  console.error('âŒ ç§¯åˆ†ä¸è¶³!', {
    éœ€è¦: budgetInfo.required_credits,
    å½“å‰: budgetInfo.current_balance,
    å·®é¢: budgetInfo.required_credits - budgetInfo.current_balance
  })
}
```

### æ–¹æ¡ˆ 3: æ˜¾ç¤ºè¯¦ç»†çš„ç§¯åˆ†ä¿¡æ¯
ä¿®æ”¹ç”ŸæˆæŒ‰é’®,æ˜¾ç¤ºè¯¦ç»†çš„ç§¯åˆ†ä¿¡æ¯:

```typescript
<Button onClick={handleGenerate} disabled={...}>
  {!budgetInfo ? (
    "Loading..."
  ) : (
    <div className="flex items-center gap-2">
      <span>Generate Video</span>
      <span className="text-xs opacity-80">
        (Cost: {budgetInfo.required_credits}, You have: {budgetInfo.current_balance})
      </span>
    </div>
  )}
</Button>
```

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

è¯·æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ’æŸ¥:

1. âœ… **æ‰“å¼€å¼€å‘è€…å·¥å…·,æŸ¥çœ‹ API å“åº”ä¸­çš„ `requiredCredits` å’Œ `userCredits`**
2. âœ… **ç¡®è®¤ä½ é€‰æ‹©çš„å‚æ•° (model, resolution, duration)**
3. âœ… **æŸ¥çœ‹å‰ç«¯æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—**
4. âœ… **æ£€æŸ¥æ•°æ®åº“ä¸­çš„å®é™…ç§¯åˆ†å€¼**
5. âœ… **åˆ·æ–°é¡µé¢åé‡è¯•**

å®Œæˆä»¥ä¸Šæ­¥éª¤å,è¯·å‘Šè¯‰æˆ‘:
- API å“åº”ä¸­æ˜¾ç¤ºçš„ `requiredCredits` æ˜¯å¤šå°‘?
- API å“åº”ä¸­æ˜¾ç¤ºçš„ `userCredits` æ˜¯å¤šå°‘?
- ä½ é€‰æ‹©çš„å‚æ•°æ˜¯ä»€ä¹ˆ? (model, resolution, duration)
- æ•°æ®åº“ä¸­æŸ¥è¯¢åˆ°çš„ `credits_remaining` æ˜¯å¤šå°‘?

è¿™æ ·æˆ‘å°±èƒ½ç²¾ç¡®å®šä½é—®é¢˜æ‰€åœ¨å¹¶æä¾›ä¿®å¤æ–¹æ¡ˆ!

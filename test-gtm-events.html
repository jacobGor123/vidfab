<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTM Events Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .event-group {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
        }
        .event-group h3 {
            margin-top: 0;
            color: #007bff;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            margin-top: 20px;
            padding: 15px;
            background: #1e1e1e;
            color: #00ff00;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #333;
        }
        .log-time {
            color: #888;
        }
        .log-event {
            color: #ffeb3b;
            font-weight: bold;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” GTM äº‹ä»¶æµ‹è¯•å·¥å…·</h1>

        <div id="gtag-status"></div>

        <div class="event-group">
            <h3>1ï¸âƒ£ æ–‡ç”Ÿè§†é¢‘ (Text-to-Video)</h3>
            <button onclick="testEvent('input_prompt', 'text-to-video')">input_prompt</button>
            <button onclick="testEvent('click_generate', 'text-to-video')">click_generate</button>
            <button onclick="testEvent('generation_started', 'text-to-video')">generation_started</button>
            <button onclick="testEvent('generation_success', 'text-to-video')">generation_success</button>
            <button onclick="testEvent('generation_failed', 'text-to-video')">generation_failed</button>
            <button onclick="testEvent('change_model', 'text-to-video')">change_model</button>
            <button onclick="testEvent('change_duration', 'text-to-video')">change_duration</button>
            <button onclick="testEvent('change_ratio', 'text-to-video')">change_ratio</button>
        </div>

        <div class="event-group">
            <h3>2ï¸âƒ£ å›¾ç”Ÿè§†é¢‘ (Image-to-Video)</h3>
            <button onclick="testEvent('upload_image', 'image-to-video')">upload_image</button>
            <button onclick="testEvent('click_generate', 'image-to-video')">click_generate</button>
            <button onclick="testEvent('generation_started', 'image-to-video')">generation_started</button>
        </div>

        <div class="event-group">
            <h3>3ï¸âƒ£ æ–‡ç”Ÿå›¾ (Text-to-Image)</h3>
            <button onclick="testEvent('click_generate', 'text-to-image')">click_generate</button>
            <button onclick="testEvent('change_model', 'text-to-image')">change_model</button>
            <button onclick="testEvent('change_ratio', 'text-to-image')">change_ratio</button>
        </div>

        <div class="event-group">
            <h3>4ï¸âƒ£ å›¾ç”Ÿå›¾ (Image-to-Image)</h3>
            <button onclick="testEvent('upload_image', 'image-to-image')">upload_image</button>
            <button onclick="testEvent('click_generate', 'image-to-image')">click_generate</button>
            <button onclick="testEvent('change_model', 'image-to-image')">change_model</button>
        </div>

        <div class="event-group">
            <h3>5ï¸âƒ£ è§†é¢‘ç‰¹æ•ˆ (Video-Effects)</h3>
            <button onclick="testEvent('upload_image', 'video-effects')">upload_image</button>
            <button onclick="testEvent('click_generate', 'video-effects')">click_generate</button>
        </div>

        <div class="event-group">
            <h3>ğŸ§ª æ‰¹é‡æµ‹è¯•</h3>
            <button onclick="testAllEvents()">æµ‹è¯•æ‰€æœ‰äº‹ä»¶</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <h2>ğŸ“ äº‹ä»¶æ—¥å¿—</h2>
        <div id="log" class="log"></div>
    </div>

    <script>
        // æ£€æŸ¥ gtag æ˜¯å¦å¯ç”¨
        function checkGtag() {
            const statusDiv = document.getElementById('gtag-status');
            if (typeof window.gtag === 'function') {
                statusDiv.innerHTML = '<div class="status success">âœ… gtag å·²åŠ è½½ï¼Œå¯ä»¥æ­£å¸¸æµ‹è¯•</div>';
                return true;
            } else if (typeof window.dataLayer !== 'undefined') {
                statusDiv.innerHTML = '<div class="status warning">âš ï¸ dataLayer å­˜åœ¨ä½† gtag æœªå®šä¹‰ï¼Œè¯·æ£€æŸ¥ GTM é…ç½®</div>';
                return false;
            } else {
                statusDiv.innerHTML = '<div class="status error">âŒ GTM æœªåŠ è½½ï¼Œè¯·åœ¨å®é™…ç½‘ç«™ç¯å¢ƒä¸­æµ‹è¯•</div>';
                return false;
            }
        }

        // è®°å½•æ—¥å¿—
        function log(message, data = null) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';

            let logContent = `<span class="log-time">[${time}]</span> ${message}`;
            if (data) {
                logContent += `\n${JSON.stringify(data, null, 2)}`;
            }

            entry.innerHTML = logContent;
            logDiv.insertBefore(entry, logDiv.firstChild);

            // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
            console.log(`[GTM Test] ${message}`, data);
        }

        // æµ‹è¯•å•ä¸ªäº‹ä»¶
        function testEvent(eventName, generationType) {
            if (!checkGtag()) {
                log(`âŒ æ— æ³•æµ‹è¯•äº‹ä»¶: gtag æœªåŠ è½½`);
                return;
            }

            // æ„é€ æµ‹è¯•æ•°æ®
            const eventData = {
                generation_type: generationType,
                model_type: 'test-model',
                duration: '5s',
                ratio: '16:9',
                resolution: '720p',
                has_prompt: true,
                prompt_length: 50,
                credits_required: 10,
            };

            // æ·»åŠ ç‰¹å®šäº‹ä»¶çš„é¢å¤–å‚æ•°
            if (eventName === 'generation_started' || eventName === 'generation_success' || eventName === 'generation_failed') {
                eventData.job_id = 'test-job-' + Date.now();
                eventData.request_id = 'test-req-' + Date.now();
            }

            if (eventName === 'upload_image') {
                eventData.upload_mode = 'local';
                eventData.image_count = 1;
            }

            if (eventName.startsWith('change_')) {
                eventData.old_value = 'old-value';
                eventData.new_value = 'new-value';
            }

            if (eventName === 'generation_failed') {
                eventData.error_type = 'TEST_ERROR';
                eventData.error_message = 'This is a test error';
            }

            // å‘é€äº‹ä»¶
            try {
                window.gtag('event', eventName, eventData);
                log(`<span class="log-event">âœ… ${eventName}</span> (${generationType})`, eventData);
            } catch (error) {
                log(`âŒ å‘é€äº‹ä»¶å¤±è´¥: ${eventName}`, error.message);
            }
        }

        // æµ‹è¯•æ‰€æœ‰äº‹ä»¶
        function testAllEvents() {
            const events = [
                { name: 'click_generate', type: 'text-to-video' },
                { name: 'generation_started', type: 'text-to-video' },
                { name: 'generation_success', type: 'text-to-video' },
                { name: 'generation_failed', type: 'text-to-video' },
                { name: 'input_prompt', type: 'text-to-video' },
                { name: 'change_model', type: 'text-to-video' },
                { name: 'change_duration', type: 'text-to-video' },
                { name: 'change_ratio', type: 'text-to-video' },
                { name: 'upload_image', type: 'image-to-video' },
            ];

            log('ğŸš€ å¼€å§‹æ‰¹é‡æµ‹è¯•...');
            events.forEach((event, index) => {
                setTimeout(() => {
                    testEvent(event.name, event.type);
                }, index * 500);
            });
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('ğŸ“‹ æ—¥å¿—å·²æ¸…ç©º');
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
        window.addEventListener('load', () => {
            checkGtag();
            log('ğŸ”§ GTM äº‹ä»¶æµ‹è¯•å·¥å…·å·²åŠ è½½');

            // å¦‚æœåœ¨æ§åˆ¶å°
            if (typeof window.gtag === 'function') {
                log('ğŸ’¡ æç¤º: æ‰“å¼€ GTM é¢„è§ˆæ¨¡å¼ä»¥æŸ¥çœ‹äº‹ä»¶è§¦å‘æƒ…å†µ');
            }
        });

        // ç›‘å¬ dataLayer å˜åŒ–
        if (typeof window.dataLayer !== 'undefined') {
            const originalPush = window.dataLayer.push;
            window.dataLayer.push = function() {
                const args = Array.from(arguments);
                log('ğŸ“¤ dataLayer.push', args);
                return originalPush.apply(this, arguments);
            };
        }
    </script>
</body>
</html>

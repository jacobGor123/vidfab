# å‘˜å·¥ç§¯åˆ†èµ é€å®æ–½æ–¹æ¡ˆ

> **åœºæ™¯**ï¼šä¸º 30-40 ä½å…¬å¸å†…éƒ¨å‘˜å·¥èµ é€ç§¯åˆ†ï¼ˆä¸€æ¬¡æ€§æ“ä½œï¼‰
> **éœ€æ±‚**ï¼šæ”¯æŒæœªæ³¨å†Œé‚®ç®±çš„ç§¯åˆ†é¢„åˆ†é…ï¼Œå‘˜å·¥æ³¨å†Œæ—¶è‡ªåŠ¨åˆ°è´¦
> **è®¾è®¡æ—¥æœŸ**ï¼š2025-11-13

---

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

### æ ¸å¿ƒæ€è·¯

é‡‡ç”¨**æœ€å°æ”¹åŠ¨ + æœ€å¤§çµæ´»æ€§**çš„è®¾è®¡ï¼š

1. **æ–°å»º `pending_credits` è¡¨**ï¼šå­˜å‚¨å¾…é¢†å–çš„ç§¯åˆ†
2. **æ‰¹é‡å¯¼å…¥è„šæœ¬**ï¼šè¯»å–å‘˜å·¥é‚®ç®±åˆ—è¡¨ï¼Œæ™ºèƒ½å¤„ç†å·²æ³¨å†Œ/æœªæ³¨å†Œç”¨æˆ·
3. **ä¿®æ”¹æ³¨å†Œæµç¨‹**ï¼šç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨æ£€æŸ¥å¹¶é¢†å– pending ç§¯åˆ†
4. **ä¿ç•™å®¡è®¡è¿½è¸ª**ï¼šæ‰€æœ‰æ“ä½œéƒ½æœ‰å®Œæ•´çš„æ—¥å¿—è®°å½•

### ä¼˜åŠ¿

| ä¼˜ç‚¹ | è¯´æ˜ |
|------|------|
| âœ… **é›¶ç ´åæ€§** | ä¸å½±å“ç°æœ‰ç§¯åˆ†ç³»ç»Ÿï¼Œç‹¬ç«‹è¡¨ç»“æ„ |
| âœ… **è‡ªåŠ¨åŒ–** | å‘˜å·¥æ³¨å†Œæ—¶æ— æ„ŸçŸ¥é¢†å–ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ |
| âœ… **å¯è¿½æº¯** | æ¸…æ¥šè®°å½•è°åˆ†é…çš„ã€ä½•æ—¶é¢†å–çš„ |
| âœ… **æ˜“å›æ»š** | å¦‚éœ€æ’¤é”€ï¼Œç›´æ¥åˆ é™¤è®°å½•å³å¯ |
| âœ… **å¯æ‰©å±•** | æœªæ¥å¯ç”¨äºæ¨èå¥–åŠ±ã€ä¿ƒé”€æ´»åŠ¨ç­‰åœºæ™¯ |

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### `pending_credits` è¡¨ç»“æ„

```sql
CREATE TABLE IF NOT EXISTS pending_credits (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    -- å¾…é¢†å–ç”¨æˆ·ä¿¡æ¯
    email VARCHAR(255) NOT NULL,
    credits_amount INTEGER NOT NULL CHECK (credits_amount > 0),

    -- æ¥æºè¿½è¸ª
    source VARCHAR(100) NOT NULL,  -- ä¾‹å¦‚: 'å‘˜å·¥ç¦åˆ©2025Q1', 'æ¨èå¥–åŠ±', 'ä¿ƒé”€æ´»åŠ¨'
    description TEXT,              -- è¯¦ç»†è¯´æ˜
    assigned_by VARCHAR(255),      -- æ“ä½œäººå‘˜ï¼ˆé‚®ç®±æˆ–IDï¼‰

    -- é¢†å–çŠ¶æ€
    is_claimed BOOLEAN DEFAULT FALSE,
    claimed_by_uuid UUID REFERENCES users(uuid),
    claimed_at TIMESTAMPTZ,

    -- è¿‡æœŸæ§åˆ¶ï¼ˆå¯é€‰ï¼‰
    expires_at TIMESTAMPTZ,

    -- æ—¶é—´æˆ³
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),

    -- çº¦æŸï¼šåŒä¸€é‚®ç®±å¯ä»¥æœ‰å¤šæ¡è®°å½•ï¼ˆæ”¯æŒå¤šæ¬¡èµ é€ï¼‰
    CONSTRAINT valid_email CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
);

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_pending_credits_email ON pending_credits(email);
CREATE INDEX idx_pending_credits_claimed ON pending_credits(is_claimed);
CREATE INDEX idx_pending_credits_expires ON pending_credits(expires_at);
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `email` | VARCHAR(255) | å‘˜å·¥é‚®ç®±ï¼Œæ”¯æŒæœªæ³¨å†Œç”¨æˆ· |
| `credits_amount` | INTEGER | èµ é€çš„ç§¯åˆ†æ•°é‡ |
| `source` | VARCHAR(100) | æ¥æºæ ‡è¯†ï¼Œå¦‚ "å‘˜å·¥ç¦åˆ©2025Q1" |
| `description` | TEXT | è¯¦ç»†æè¿°ï¼Œå¦‚ "å…¬å¸å‘¨å¹´åº†èµ é€" |
| `assigned_by` | VARCHAR(255) | æ“ä½œäººå‘˜ï¼Œä¾¿äºå®¡è®¡ |
| `is_claimed` | BOOLEAN | æ˜¯å¦å·²é¢†å– |
| `claimed_by_uuid` | UUID | é¢†å–è€…çš„ user_uuid |
| `claimed_at` | TIMESTAMPTZ | é¢†å–æ—¶é—´ |
| `expires_at` | TIMESTAMPTZ | è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼Œæœ¬æ¬¡ä¸ç”¨ï¼‰ |

---

## ğŸ“ SQL è„šæœ¬

### 1. åˆ›å»ºè¡¨ï¼ˆ`scripts/sql/create_pending_credits.sql`ï¼‰

```sql
-- ===================================
-- åˆ›å»º pending_credits è¡¨
-- ===================================

BEGIN;

-- åˆ›å»ºè¡¨
CREATE TABLE IF NOT EXISTS pending_credits (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email VARCHAR(255) NOT NULL,
    credits_amount INTEGER NOT NULL CHECK (credits_amount > 0),
    source VARCHAR(100) NOT NULL,
    description TEXT,
    assigned_by VARCHAR(255),
    is_claimed BOOLEAN DEFAULT FALSE,
    claimed_by_uuid UUID REFERENCES users(uuid),
    claimed_at TIMESTAMPTZ,
    expires_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT valid_email CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_pending_credits_email ON pending_credits(email);
CREATE INDEX idx_pending_credits_claimed ON pending_credits(is_claimed);
CREATE INDEX idx_pending_credits_expires ON pending_credits(expires_at);

-- åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_pending_credits_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_pending_credits_updated_at
    BEFORE UPDATE ON pending_credits
    FOR EACH ROW
    EXECUTE FUNCTION update_pending_credits_updated_at();

COMMIT;

-- éªŒè¯
SELECT 'pending_credits è¡¨åˆ›å»ºæˆåŠŸ' AS status;
```

### 2. æ‰¹é‡æ’å…¥æ¨¡æ¿ï¼ˆ`scripts/sql/insert_employee_credits.sql`ï¼‰

```sql
-- ===================================
-- æ‰¹é‡æ’å…¥å‘˜å·¥ç§¯åˆ†
-- ===================================
-- æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶ç”± TypeScript è„šæœ¬è‡ªåŠ¨ç”Ÿæˆ

BEGIN;

INSERT INTO pending_credits (email, credits_amount, source, description, assigned_by)
VALUES
    ('employee1@company.com', 100, 'å‘˜å·¥ç¦åˆ©2025Q1', 'å…¬å¸å†…éƒ¨å‘˜å·¥ç§¯åˆ†èµ é€', 'admin@company.com'),
    ('employee2@company.com', 100, 'å‘˜å·¥ç¦åˆ©2025Q1', 'å…¬å¸å†…éƒ¨å‘˜å·¥ç§¯åˆ†èµ é€', 'admin@company.com'),
    ('employee3@company.com', 100, 'å‘˜å·¥ç¦åˆ©2025Q1', 'å…¬å¸å†…éƒ¨å‘˜å·¥ç§¯åˆ†èµ é€', 'admin@company.com');
    -- ... æ›´å¤šå‘˜å·¥

COMMIT;

-- éªŒè¯
SELECT
    COUNT(*) as total_assigned,
    SUM(credits_amount) as total_credits
FROM pending_credits
WHERE source = 'å‘˜å·¥ç¦åˆ©2025Q1' AND is_claimed = FALSE;
```

### 3. æŸ¥è¯¢ç»Ÿè®¡è„šæœ¬ï¼ˆ`scripts/sql/query_pending_credits.sql`ï¼‰

```sql
-- ===================================
-- æŸ¥è¯¢ pending_credits ç»Ÿè®¡ä¿¡æ¯
-- ===================================

-- 1. æŸ¥çœ‹æ‰€æœ‰å¾…é¢†å–ç§¯åˆ†
SELECT
    email,
    credits_amount,
    source,
    description,
    created_at,
    expires_at
FROM pending_credits
WHERE is_claimed = FALSE
ORDER BY created_at DESC;

-- 2. æŸ¥çœ‹å·²é¢†å–ç§¯åˆ†
SELECT
    pc.email,
    pc.credits_amount,
    pc.source,
    pc.claimed_at,
    u.nickname as claimed_by_nickname
FROM pending_credits pc
LEFT JOIN users u ON pc.claimed_by_uuid = u.uuid
WHERE pc.is_claimed = TRUE
ORDER BY pc.claimed_at DESC;

-- 3. ç»Ÿè®¡æ±‡æ€»
SELECT
    source,
    COUNT(*) as total_count,
    SUM(credits_amount) as total_credits,
    COUNT(*) FILTER (WHERE is_claimed = TRUE) as claimed_count,
    COUNT(*) FILTER (WHERE is_claimed = FALSE) as pending_count
FROM pending_credits
GROUP BY source
ORDER BY created_at DESC;

-- 4. æ£€æŸ¥æŸä¸ªå‘˜å·¥çš„ç§¯åˆ†
SELECT * FROM pending_credits
WHERE email = 'employee@company.com'
ORDER BY created_at DESC;
```

---

## ğŸ’» ç®¡ç†è„šæœ¬

### TypeScript è„šæœ¬ï¼ˆ`scripts/assign-employee-credits.ts`ï¼‰

```typescript
/**
 * æ‰¹é‡ä¸ºå‘˜å·¥åˆ†é…ç§¯åˆ†
 *
 * ç”¨æ³•ï¼š
 * 1. å‡†å¤‡å‘˜å·¥é‚®ç®±åˆ—è¡¨æ–‡ä»¶ employees.json
 * 2. è¿è¡Œ: pnpm tsx scripts/assign-employee-credits.ts
 */

import { supabaseAdmin } from '@/lib/supabase';
import { CreditsManager } from '@/lib/subscription/credits-manager';
import * as fs from 'fs';
import * as path from 'path';

// ===================================
// é…ç½®
// ===================================
const CONFIG = {
  // å‘˜å·¥é‚®ç®±åˆ—è¡¨æ–‡ä»¶è·¯å¾„
  EMPLOYEE_LIST_FILE: path.join(__dirname, 'employees.json'),

  // æ¯äººèµ é€çš„ç§¯åˆ†æ•°é‡
  CREDITS_AMOUNT: 100,

  // æ¥æºæ ‡è¯†
  SOURCE: 'å‘˜å·¥ç¦åˆ©2025Q1',

  // è¯¦ç»†æè¿°
  DESCRIPTION: 'å…¬å¸å†…éƒ¨å‘˜å·¥ç§¯åˆ†èµ é€',

  // æ“ä½œäººå‘˜ï¼ˆä½ çš„é‚®ç®±ï¼‰
  ASSIGNED_BY: 'admin@company.com',
};

// ===================================
// å‘˜å·¥é‚®ç®±åˆ—è¡¨æ ¼å¼ï¼ˆemployees.jsonï¼‰
// ===================================
/*
[
  "employee1@company.com",
  "employee2@company.com",
  "employee3@company.com"
]
*/

interface AssignmentResult {
  email: string;
  status: 'already_registered' | 'pending_assigned' | 'error';
  creditsAdded?: number;
  currentBalance?: number;
  error?: string;
}

async function assignEmployeeCredits(): Promise<void> {
  console.log('ğŸš€ å¼€å§‹æ‰¹é‡åˆ†é…å‘˜å·¥ç§¯åˆ†...\n');

  // 1. è¯»å–å‘˜å·¥é‚®ç®±åˆ—è¡¨
  if (!fs.existsSync(CONFIG.EMPLOYEE_LIST_FILE)) {
    console.error(`âŒ é”™è¯¯: æ‰¾ä¸åˆ°å‘˜å·¥é‚®ç®±åˆ—è¡¨æ–‡ä»¶: ${CONFIG.EMPLOYEE_LIST_FILE}`);
    console.log(`\nğŸ“ è¯·åˆ›å»º ${CONFIG.EMPLOYEE_LIST_FILE} æ–‡ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹:`);
    console.log(JSON.stringify(['employee1@company.com', 'employee2@company.com'], null, 2));
    process.exit(1);
  }

  const employeeEmails: string[] = JSON.parse(
    fs.readFileSync(CONFIG.EMPLOYEE_LIST_FILE, 'utf-8')
  );

  console.log(`ğŸ“‹ è¯»å–åˆ° ${employeeEmails.length} ä¸ªå‘˜å·¥é‚®ç®±\n`);

  const results: AssignmentResult[] = [];
  const creditsManager = CreditsManager.getInstance();

  // 2. é€ä¸ªå¤„ç†å‘˜å·¥
  for (let i = 0; i < employeeEmails.length; i++) {
    const email = employeeEmails[i].toLowerCase().trim();
    console.log(`[${i + 1}/${employeeEmails.length}] å¤„ç†: ${email}`);

    try {
      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æ³¨å†Œ
      const { data: existingUser } = await supabaseAdmin
        .from('users')
        .select('uuid, credits_remaining, nickname')
        .eq('email', email)
        .single();

      if (existingUser) {
        // ç”¨æˆ·å·²æ³¨å†Œ -> ç›´æ¥å¢åŠ ç§¯åˆ†
        console.log(`  âœ… ç”¨æˆ·å·²æ³¨å†Œï¼Œç›´æ¥å¢åŠ ç§¯åˆ†...`);

        await creditsManager.addBonusCredits(
          existingUser.uuid,
          CONFIG.CREDITS_AMOUNT,
          CONFIG.DESCRIPTION
        );

        const newBalance = existingUser.credits_remaining + CONFIG.CREDITS_AMOUNT;

        results.push({
          email,
          status: 'already_registered',
          creditsAdded: CONFIG.CREDITS_AMOUNT,
          currentBalance: newBalance,
        });

        console.log(`  ğŸ’° ç§¯åˆ†å·²åˆ°è´¦: ${CONFIG.CREDITS_AMOUNT} (ä½™é¢: ${newBalance})`);
      } else {
        // ç”¨æˆ·æœªæ³¨å†Œ -> æ’å…¥ pending_credits
        console.log(`  ğŸ“Œ ç”¨æˆ·æœªæ³¨å†Œï¼Œåˆ›å»ºå¾…é¢†å–è®°å½•...`);

        const { error } = await supabaseAdmin
          .from('pending_credits')
          .insert({
            email,
            credits_amount: CONFIG.CREDITS_AMOUNT,
            source: CONFIG.SOURCE,
            description: CONFIG.DESCRIPTION,
            assigned_by: CONFIG.ASSIGNED_BY,
          });

        if (error) throw error;

        results.push({
          email,
          status: 'pending_assigned',
          creditsAdded: CONFIG.CREDITS_AMOUNT,
        });

        console.log(`  â³ å¾…é¢†å–ç§¯åˆ†: ${CONFIG.CREDITS_AMOUNT} (æ³¨å†Œåè‡ªåŠ¨åˆ°è´¦)`);
      }
    } catch (error: any) {
      console.error(`  âŒ é”™è¯¯: ${error.message}`);
      results.push({
        email,
        status: 'error',
        error: error.message,
      });
    }

    console.log('');
  }

  // 3. è¾“å‡ºæ±‡æ€»æŠ¥å‘Š
  console.log('\n' + '='.repeat(60));
  console.log('ğŸ“Š åˆ†é…å®Œæˆï¼Œæ±‡æ€»æŠ¥å‘Š:\n');

  const alreadyRegistered = results.filter(r => r.status === 'already_registered');
  const pendingAssigned = results.filter(r => r.status === 'pending_assigned');
  const errors = results.filter(r => r.status === 'error');

  console.log(`âœ… å·²æ³¨å†Œç”¨æˆ·ï¼ˆç«‹å³åˆ°è´¦ï¼‰: ${alreadyRegistered.length} äºº`);
  console.log(`ğŸ“Œ æœªæ³¨å†Œç”¨æˆ·ï¼ˆå¾…é¢†å–ï¼‰  : ${pendingAssigned.length} äºº`);
  console.log(`âŒ å¤„ç†å¤±è´¥              : ${errors.length} äºº`);
  console.log(`ğŸ’° æ€»è®¡èµ é€ç§¯åˆ†          : ${(alreadyRegistered.length + pendingAssigned.length) * CONFIG.CREDITS_AMOUNT}`);

  if (errors.length > 0) {
    console.log('\nâŒ å¤±è´¥åˆ—è¡¨:');
    errors.forEach(e => {
      console.log(`  - ${e.email}: ${e.error}`);
    });
  }

  // 4. ä¿å­˜è¯¦ç»†æŠ¥å‘Š
  const reportFile = path.join(__dirname, `assignment-report-${Date.now()}.json`);
  fs.writeFileSync(reportFile, JSON.stringify(results, null, 2));
  console.log(`\nğŸ“„ è¯¦ç»†æŠ¥å‘Šå·²ä¿å­˜: ${reportFile}`);

  console.log('\nâœ¨ ä»»åŠ¡å®Œæˆï¼');
}

// æ‰§è¡Œ
assignEmployeeCredits().catch(console.error);
```

---

## ğŸ”§ ä»£ç ä¿®æ”¹

### ä¿®æ”¹ `services/user.ts` çš„ `saveUser` å‡½æ•°

åœ¨æ–°ç”¨æˆ·æ³¨å†Œæ—¶ï¼Œè‡ªåŠ¨æ£€æŸ¥å¹¶é¢†å– pending_creditsï¼š

```typescript
// æ–‡ä»¶: services/user.ts
// ä½ç½®: saveUser å‡½æ•°ä¸­ï¼Œæ–°ç”¨æˆ·åˆ›å»ºåï¼ˆç¬¬74è¡Œä¹‹åï¼‰

} else {
  // âœ… æ–°ç”¨æˆ·ï¼šä½¿ç”¨é»˜è®¤å€¼
  console.log(`âœ¨ åˆ›å»ºæ–°ç”¨æˆ·: ${userUuid}`);

  // ğŸ†• æ£€æŸ¥æ˜¯å¦æœ‰å¾…é¢†å–çš„ç§¯åˆ†
  const { data: pendingCredits } = await supabaseAdmin
    .from('pending_credits')
    .select('id, credits_amount, source')
    .eq('email', userData.email.toLowerCase().trim())
    .eq('is_claimed', false)
    .order('created_at', { ascending: true }); // æŒ‰åˆ›å»ºæ—¶é—´é¢†å–

  let totalPendingCredits = 50; // é»˜è®¤åˆå§‹ç§¯åˆ†
  const pendingCreditIds: string[] = [];

  if (pendingCredits && pendingCredits.length > 0) {
    // ç´¯åŠ æ‰€æœ‰å¾…é¢†å–ç§¯åˆ†
    totalPendingCredits += pendingCredits.reduce((sum, pc) => sum + pc.credits_amount, 0);
    pendingCreditIds.push(...pendingCredits.map(pc => pc.id));

    console.log(`ğŸ æ£€æµ‹åˆ° ${pendingCredits.length} æ¡å¾…é¢†å–ç§¯åˆ†ï¼Œæ€»è®¡: ${pendingCredits.reduce((sum, pc) => sum + pc.credits_amount, 0)} ç§¯åˆ†`);
  }

  userToSave = {
    uuid: userUuid,
    email: userData.email.toLowerCase().trim(),
    nickname: userData.nickname || userData.email.split('@')[0],
    avatar_url: userData.avatar_url || '',
    signin_type: userData.signin_type,
    signin_provider: userData.signin_provider,
    signin_openid: userData.signin_openid,
    signin_ip: userData.signin_ip,
    email_verified: userData.email_verified ?? false,
    last_login: now,
    created_at: now,
    updated_at: now,
    is_active: true,
    subscription_status: 'active',
    subscription_plan: 'free',
    credits_remaining: totalPendingCredits, // ğŸ†• ä½¿ç”¨ç´¯åŠ åçš„ç§¯åˆ†
    total_videos_processed: 0,
    storage_used_mb: 0,
    max_storage_mb: 1024,
  };

  // ğŸ†• ç”¨æˆ·åˆ›å»ºæˆåŠŸåï¼Œæ ‡è®° pending_credits ä¸ºå·²é¢†å–
  if (pendingCreditIds.length > 0) {
    const { error: claimError } = await supabaseAdmin
      .from('pending_credits')
      .update({
        is_claimed: true,
        claimed_by_uuid: userUuid,
        claimed_at: now,
      })
      .in('id', pendingCreditIds);

    if (claimError) {
      console.error('âš ï¸ æ ‡è®° pending_credits å¤±è´¥:', claimError);
      // ä¸æŠ›å‡ºé”™è¯¯ï¼Œé¿å…å½±å“ç”¨æˆ·æ³¨å†Œæµç¨‹
    } else {
      console.log(`âœ… æˆåŠŸé¢†å– ${pendingCreditIds.length} æ¡ç§¯åˆ†è®°å½•`);
    }
  }
}
```

---

## ğŸš€ å®æ–½æ­¥éª¤

### Step 1: å‡†å¤‡æ•°æ®åº“

```bash
# 1. åœ¨ Supabase SQL Editor æ‰§è¡Œ
# å¤åˆ¶ scripts/sql/create_pending_credits.sql çš„å†…å®¹å¹¶æ‰§è¡Œ

# 2. éªŒè¯è¡¨åˆ›å»ºæˆåŠŸ
SELECT * FROM pending_credits LIMIT 1;
```

### Step 2: å‡†å¤‡å‘˜å·¥é‚®ç®±åˆ—è¡¨

åœ¨ `scripts/` ç›®å½•åˆ›å»º `employees.json`ï¼š

```json
[
  "employee1@company.com",
  "employee2@company.com",
  "employee3@company.com"
]
```

### Step 3: è¿è¡Œåˆ†é…è„šæœ¬

```bash
# å®‰è£…ä¾èµ–ï¼ˆå¦‚æœè¿˜æ²¡è£… tsxï¼‰
pnpm add -D tsx

# è¿è¡Œè„šæœ¬
pnpm tsx scripts/assign-employee-credits.ts
```

**è„šæœ¬ä¼šè‡ªåŠ¨**ï¼š
- âœ… æ£€æŸ¥æ¯ä¸ªé‚®ç®±æ˜¯å¦å·²æ³¨å†Œ
- âœ… å·²æ³¨å†Œç”¨æˆ·ï¼šç«‹å³å¢åŠ ç§¯åˆ† + è®°å½•äº¤æ˜“æ—¥å¿—
- âœ… æœªæ³¨å†Œç”¨æˆ·ï¼šæ’å…¥ pending_credits è¡¨
- âœ… ç”Ÿæˆè¯¦ç»†æŠ¥å‘Šï¼ˆJSON æ–‡ä»¶ï¼‰

### Step 4: ä¿®æ”¹æ³¨å†Œæµç¨‹

```bash
# ä¿®æ”¹ services/user.ts çš„ saveUser å‡½æ•°
# å¤åˆ¶ä¸Šé¢"ä»£ç ä¿®æ”¹"éƒ¨åˆ†çš„ä»£ç 
```

### Step 5: æµ‹è¯•éªŒè¯

```bash
# 1. æµ‹è¯•å·²æ³¨å†Œç”¨æˆ·
# åœ¨æ•°æ®åº“æŸ¥è¯¢æŸä¸ªå·²æ³¨å†Œå‘˜å·¥çš„ç§¯åˆ†ï¼Œç¡®è®¤å·²å¢åŠ 

# 2. æµ‹è¯•æœªæ³¨å†Œç”¨æˆ·
# (1) åœ¨ pending_credits è¡¨æŸ¥è¯¢ï¼Œç¡®è®¤è®°å½•å·²åˆ›å»º
SELECT * FROM pending_credits WHERE email = 'employee@company.com';

# (2) è®©è¯¥å‘˜å·¥æ³¨å†Œè´¦å·
# (3) æ³¨å†ŒåæŸ¥è¯¢ users è¡¨ï¼Œç¡®è®¤ç§¯åˆ†è‡ªåŠ¨åˆ°è´¦ï¼ˆé»˜è®¤50 + pendingç§¯åˆ†ï¼‰
SELECT uuid, email, credits_remaining FROM users WHERE email = 'employee@company.com';

# (4) æŸ¥è¯¢ pending_credits è¡¨ï¼Œç¡®è®¤ is_claimed = TRUE
SELECT * FROM pending_credits WHERE email = 'employee@company.com';
```

### Step 6: ç›‘æ§ç»Ÿè®¡

```bash
# åœ¨ Supabase SQL Editor æ‰§è¡Œç»Ÿè®¡æŸ¥è¯¢
# å¤åˆ¶ scripts/sql/query_pending_credits.sql çš„å†…å®¹
```

---

## ğŸ“Š é¢„æœŸç»“æœ

### åœºæ™¯1ï¼šå‘˜å·¥å·²æ³¨å†Œ

```
å‘˜å·¥é‚®ç®±: employee1@company.com
æ“ä½œå‰ç§¯åˆ†: 120
æ“ä½œåç§¯åˆ†: 220 âœ…
äº¤æ˜“è®°å½•: å·²å†™å…¥ credits_transactions è¡¨
```

### åœºæ™¯2ï¼šå‘˜å·¥æœªæ³¨å†Œ

```
å‘˜å·¥é‚®ç®±: employee2@company.com
pending_credits è¡¨:
  - email: employee2@company.com
  - credits_amount: 100
  - is_claimed: FALSE âœ…

å‘˜å·¥æ³¨å†Œå:
  - users è¡¨ credits_remaining: 150 (é»˜è®¤50 + pending100) âœ…
  - pending_credits è¡¨ is_claimed: TRUE âœ…
  - pending_credits è¡¨ claimed_by_uuid: {user_uuid} âœ…
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. é‡å¤åˆ†é…é—®é¢˜

**é—®é¢˜**ï¼šå¦‚æœä¸å°å¿ƒè¿è¡Œäº†ä¸¤æ¬¡è„šæœ¬æ€ä¹ˆåŠï¼Ÿ

**ç­”æ¡ˆ**ï¼š
- å·²æ³¨å†Œç”¨æˆ·ï¼šä¼šå¢åŠ ä¸¤æ¬¡ç§¯åˆ†ï¼ˆ100 + 100 = 200ï¼‰âš ï¸
- æœªæ³¨å†Œç”¨æˆ·ï¼šä¼šåˆ›å»ºä¸¤æ¡ pending è®°å½•ï¼Œæ³¨å†Œæ—¶ä¼šç´¯åŠ é¢†å– âš ï¸

**å»ºè®®**ï¼š
- è¿è¡Œè„šæœ¬å‰å…ˆå¤‡ä»½æ•°æ®åº“
- æˆ–è€…åœ¨è„šæœ¬ä¸­å¢åŠ å¹‚ç­‰æ€§æ£€æŸ¥ï¼ˆæ£€æŸ¥ source å­—æ®µæ˜¯å¦å·²å­˜åœ¨ï¼‰

### 2. é‚®ç®±å¤§å°å†™é—®é¢˜

**å·²å¤„ç†**ï¼šè„šæœ¬è‡ªåŠ¨è½¬å°å†™ + trimï¼Œä¸æ•°æ®åº“ä¿æŒä¸€è‡´

### 3. è¿‡æœŸæ—¶é—´

**æœ¬æ¬¡ä¸ä½¿ç”¨**ï¼šå‘˜å·¥ç¦åˆ©ç§¯åˆ†æ°¸ä¹…æœ‰æ•ˆï¼Œexpires_at å­—æ®µç•™ç©º

å¦‚éœ€è®¾ç½®è¿‡æœŸæ—¶é—´ï¼š
```sql
expires_at: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000) -- 90å¤©åè¿‡æœŸ
```

### 4. å®¡è®¡è¿½è¸ª

æ‰€æœ‰æ“ä½œéƒ½æœ‰å®Œæ•´è®°å½•ï¼š
- âœ… å·²æ³¨å†Œç”¨æˆ·ï¼š`credits_transactions` è¡¨
- âœ… æœªæ³¨å†Œç”¨æˆ·ï¼š`pending_credits` è¡¨

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1: è„šæœ¬æŠ¥é”™ "Table does not exist"

**åŸå› **: pending_credits è¡¨æœªåˆ›å»º

**è§£å†³**: æ‰§è¡Œ Step 1 çš„ SQL è„šæœ¬

### é—®é¢˜2: å‘˜å·¥æ³¨å†Œåç§¯åˆ†æœªåˆ°è´¦

**æ£€æŸ¥**:
```sql
-- 1. æ£€æŸ¥ pending_credits æ˜¯å¦æœ‰è®°å½•
SELECT * FROM pending_credits WHERE email = 'employee@company.com';

-- 2. æ£€æŸ¥ä»£ç ä¿®æ”¹æ˜¯å¦ç”Ÿæ•ˆ
-- æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼Œæœç´¢ "æ£€æµ‹åˆ°å¾…é¢†å–ç§¯åˆ†"
```

### é—®é¢˜3: å·²æ³¨å†Œç”¨æˆ·ç§¯åˆ†æœªå¢åŠ 

**æ£€æŸ¥**:
```sql
-- æŸ¥è¯¢ credits_transactions è¡¨
SELECT * FROM credits_transactions
WHERE user_uuid = 'xxx' AND transaction_type = 'bonus'
ORDER BY created_at DESC;
```

---

## ğŸ“… åç»­ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

å¦‚æœæœªæ¥éœ€è¦é¢‘ç¹æ“ä½œï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **Web ç®¡ç†ç•Œé¢**ï¼šå¯è§†åŒ–ç®¡ç† pending_credits
2. **æ‰¹é‡å¯¼å…¥ CSV**ï¼šæ”¯æŒä» Excel å¯¼å…¥å‘˜å·¥åˆ—è¡¨
3. **é‚®ä»¶é€šçŸ¥**ï¼šç§¯åˆ†åˆ°è´¦åè‡ªåŠ¨å‘é€é‚®ä»¶
4. **è¿‡æœŸå›æ”¶**ï¼šå®šæœŸæ¸…ç†è¿‡æœŸæœªé¢†å–çš„ç§¯åˆ†

---

## âœ… æ€»ç»“

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **æ•°æ®åº“æ”¹åŠ¨** | æ–°å»º 1 å¼ è¡¨ `pending_credits` |
| **ä»£ç æ”¹åŠ¨** | ä¿®æ”¹ `services/user.ts` çº¦ 30 è¡Œ |
| **æ‰§è¡Œæ—¶é—´** | çº¦ 30 åˆ†é’Ÿï¼ˆå«æµ‹è¯•ï¼‰ |
| **é£é™©ç­‰çº§** | ğŸŸ¢ ä½ï¼ˆç‹¬ç«‹è¡¨ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼‰ |
| **å›æ»šæ–¹æ¡ˆ** | åˆ é™¤ `pending_credits` è¡¨ï¼Œè¿˜åŸ `user.ts` |

---

**ğŸ¯ å‡†å¤‡å¥½äº†å—ï¼Ÿç¡®è®¤æ–¹æ¡ˆåæˆ‘å¯ä»¥å¸®ä½ ï¼š**

1. âœ… ç”Ÿæˆ SQL è„šæœ¬æ–‡ä»¶
2. âœ… ç”Ÿæˆ TypeScript ç®¡ç†è„šæœ¬
3. âœ… ä¿®æ”¹ user.ts ä»£ç 
4. âœ… æä¾›æµ‹è¯•æ­¥éª¤

**ç›´æ¥å‘Šè¯‰æˆ‘ï¼šå¼€å§‹æ‰§è¡Œï¼** ğŸš€

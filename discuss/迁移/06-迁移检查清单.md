# VidFab 云原生迁移检查清单

本文档提供完整的迁移任务检查清单,用于跟踪迁移进度。

---

## ✅ 阶段 1: 准备阶段

### 云服务注册

- [ ] Vercel Pro 账户注册
  - [ ] 使用 GitHub/GitLab OAuth 登录
  - [ ] 升级到 Pro 套餐 ($20/月)
  - [ ] 绑定项目仓库
  - [ ] 添加团队成员 (如需要)

- [ ] Inngest 账户注册
  - [ ] 创建账户 (https://www.inngest.com/)
  - [ ] 创建项目 "vidfab-production"
  - [ ] 复制 Event Key: `___________`
  - [ ] 复制 Signing Key: `___________`

- [ ] Upstash Redis 注册
  - [ ] 创建账户 (https://upstash.com/)
  - [ ] 创建 Redis 数据库
  - [ ] 选择 Free 套餐
  - [ ] 选择区域: Asia/Pacific (Singapore)
  - [ ] 复制 REST URL: `___________`
  - [ ] 复制 REST Token: `___________`

- [ ] Cloudinary 注册
  - [ ] 创建账户 (https://cloudinary.com/)
  - [ ] 选择 Free 套餐
  - [ ] 复制 Cloud Name: `___________`
  - [ ] 复制 API Key: `___________`
  - [ ] 复制 API Secret: `___________`

- [ ] Axiom 注册
  - [ ] 创建账户 (https://axiom.co/)
  - [ ] 创建 Dataset "vidfab-logs"
  - [ ] 复制 API Token: `___________`

---

### 环境配置

- [ ] 创建 `.env.vercel` 文件
  ```bash
  cp .env.local .env.vercel
  ```

- [ ] 添加新的环境变量到 `.env.vercel`
  ```env
  # Upstash Redis
  UPSTASH_REDIS_REST_URL=https://xxx.upstash.io
  UPSTASH_REDIS_REST_TOKEN=xxx

  # Inngest
  INNGEST_EVENT_KEY=xxx
  INNGEST_SIGNING_KEY=signkey-xxx

  # Cloudinary
  CLOUDINARY_CLOUD_NAME=xxx
  CLOUDINARY_API_KEY=xxx
  CLOUDINARY_API_SECRET=xxx

  # Axiom
  NEXT_PUBLIC_AXIOM_DATASET=vidfab-logs
  AXIOM_TOKEN=xxx
  ```

- [ ] 安装 Vercel CLI
  ```bash
  npm install -g vercel
  vercel login
  ```

- [ ] 关联 Vercel 项目
  ```bash
  vercel link
  ```

- [ ] 推送环境变量到 Vercel
  ```bash
  vercel env add UPSTASH_REDIS_REST_URL
  vercel env add UPSTASH_REDIS_REST_TOKEN
  vercel env add INNGEST_EVENT_KEY
  vercel env add INNGEST_SIGNING_KEY
  vercel env add CLOUDINARY_CLOUD_NAME
  vercel env add CLOUDINARY_API_KEY
  vercel env add CLOUDINARY_API_SECRET
  vercel env add NEXT_PUBLIC_AXIOM_DATASET
  vercel env add AXIOM_TOKEN
  ```

---

### 团队准备

- [ ] 团队培训会议 (2 小时)
  - [ ] 讲解云原生架构
  - [ ] 演示 Vercel Dashboard
  - [ ] 演示 Inngest 监控
  - [ ] Q&A 环节

- [ ] 创建迁移分支
  ```bash
  git checkout -b migration/cloud-native
  git push origin migration/cloud-native
  ```

- [ ] 备份当前环境
  - [ ] 备份 Docker 镜像
  - [ ] 备份 .env.local 文件
  - [ ] 导出 Supabase 数据库 (自动备份)
  - [ ] 文档化当前部署流程

---

## ✅ 阶段 2: 前端迁移

### Vercel 部署

- [ ] 创建 `vercel.json` 配置文件
  ```json
  {
    "buildCommand": "npm run build",
    "devCommand": "npm run dev",
    "installCommand": "npm install",
    "framework": "nextjs",
    "regions": ["hkg1", "sin1"],
    "crons": [
      {
        "path": "/api/cron/generate-blog",
        "schedule": "0 10 * * *"
      }
    ]
  }
  ```

- [ ] 首次部署到 Vercel
  ```bash
  vercel --prod
  ```

- [ ] 验证部署
  - [ ] 访问 Vercel URL
  - [ ] 测试首页加载
  - [ ] 测试 `/api/health` 端点
  - [ ] 测试用户注册/登录
  - [ ] 测试 API 路由

- [ ] 配置自定义域名
  - [ ] 在 Vercel Dashboard 添加测试域名 `test.vidfab.ai`
  - [ ] 更新 DNS 记录
  - [ ] 等待 SSL 证书生成
  - [ ] 验证 HTTPS 访问

- [ ] 测试 Preview 部署
  - [ ] 创建测试 PR
  - [ ] 验证 Preview URL 自动生成
  - [ ] 测试 Preview 环境功能

---

### Redis 迁移

- [ ] 安装 Upstash SDK
  ```bash
  npm install @upstash/redis
  ```

- [ ] 改造 `/lib/redis.ts`
  ```typescript
  import { Redis } from '@upstash/redis'

  export const redis = new Redis({
    url: process.env.UPSTASH_REDIS_REST_URL!,
    token: process.env.UPSTASH_REDIS_REST_TOKEN!,
  })
  ```

- [ ] 迁移现有 Redis 数据 (如需要)
  - [ ] 导出当前 Redis 数据
  - [ ] 导入到 Upstash
  - [ ] 或手动清空缓存 (如果数据不重要)

- [ ] 测试 Redis 功能
  - [ ] 测试缓存读写
  - [ ] 测试 Session 存储
  - [ ] 测试用户登录 (Session)
  - [ ] 性能对比测试

---

### Cron 任务迁移

- [ ] 创建 `/app/api/cron/generate-blog/route.ts`
  ```typescript
  import { generateAndPublishArticle } from '@/lib/blog/article-generator'

  export const runtime = 'nodejs'
  export const maxDuration = 300

  export async function GET(request: Request) {
    try {
      const result = await generateAndPublishArticle()
      return Response.json({ success: true, data: result })
    } catch (error) {
      console.error('Cron job failed:', error)
      return Response.json(
        { success: false, error: String(error) },
        { status: 500 }
      )
    }
  }
  ```

- [ ] 禁用 node-cron
  - [ ] 注释 `/instrumentation.ts` 中的 `initializeCronJobs()`

- [ ] 测试 Cron 路由
  ```bash
  curl http://localhost:3000/api/cron/generate-blog
  ```

- [ ] 验证 Vercel Cron 配置
  - [ ] 部署后在 Dashboard 查看 Cron 设置
  - [ ] 手动触发测试 (如支持)
  - [ ] 等待自动执行 (第二天 10:00)

---

## ✅ 阶段 3: 后台迁移

### Inngest 任务队列

- [ ] 安装 Inngest SDK
  ```bash
  npm install inngest
  ```

- [ ] 创建 `/lib/inngest/client.ts`
  ```typescript
  import { Inngest } from 'inngest'

  export const inngest = new Inngest({
    id: 'vidfab',
    name: 'VidFab AI Video Platform',
    eventKey: process.env.INNGEST_EVENT_KEY!,
  })
  ```

- [ ] 创建 Inngest Functions
  - [ ] `/lib/inngest/functions/video-processing.ts`
    - [ ] `downloadVideo` function
    - [ ] `generateThumbnail` function
    - [ ] `cleanupTempFiles` function
    - [ ] `updateQuota` function

- [ ] 创建 `/app/api/inngest/route.ts`
  ```typescript
  import { serve } from 'inngest/next'
  import { inngest } from '@/lib/inngest/client'
  import * as functions from '@/lib/inngest/functions/video-processing'

  export const { GET, POST, PUT } = serve({
    client: inngest,
    functions: [
      functions.downloadVideo,
      functions.generateThumbnail,
      functions.cleanupTempFiles,
      functions.updateQuota,
    ],
    signingKey: process.env.INNGEST_SIGNING_KEY!,
  })
  ```

- [ ] 改造任务触发逻辑
  - [ ] 修改 `/app/api/video/generate/route.ts`
  - [ ] 修改 `/app/api/video/store/route.ts`
  - [ ] 修改其他任务触发点

- [ ] 测试 Inngest 功能
  - [ ] 触发视频生成
  - [ ] 在 Inngest Dashboard 查看任务执行
  - [ ] 验证任务成功完成
  - [ ] 验证重试机制
  - [ ] 验证延迟任务 (24h 清理)

- [ ] 保留 BullMQ 作为备份 (暂不删除)
  - [ ] 新任务用 Inngest
  - [ ] 旧任务继续用 BullMQ (可选)

---

### Cloudinary 视频处理

- [ ] 安装 Cloudinary SDK
  ```bash
  npm install cloudinary
  ```

- [ ] 创建 `/lib/cloudinary.ts`
  ```typescript
  import { v2 as cloudinary } from 'cloudinary'

  cloudinary.config({
    cloud_name: process.env.CLOUDINARY_CLOUD_NAME!,
    api_key: process.env.CLOUDINARY_API_KEY!,
    api_secret: process.env.CLOUDINARY_API_SECRET!,
  })

  export { cloudinary }
  ```

- [ ] 创建 `/lib/services/thumbnail-service.ts`
  - [ ] `generateFromVideo()` 方法
  - [ ] `uploadAndGenerate()` 方法 (可选)

- [ ] 替换 ffmpeg 逻辑
  - [ ] 修改缩略图生成任务
  - [ ] 使用 Cloudinary Fetch API
  - [ ] 或上传到 Cloudinary

- [ ] 测试缩略图生成
  - [ ] 上传测试视频
  - [ ] 验证缩略图生成
  - [ ] 验证缩略图画质
  - [ ] 对比加载速度

---

### Axiom 日志系统

- [ ] 安装 Axiom SDK
  ```bash
  npm install next-axiom
  ```

- [ ] 配置 `next.config.mjs`
  ```javascript
  import { withAxiom } from 'next-axiom'

  const nextConfig = { /* 你的配置 */ }

  export default withAxiom(nextConfig)
  ```

- [ ] 创建 `/lib/logger.ts`
  ```typescript
  import { log as axiomLog } from 'next-axiom'

  export const logger = {
    info: (message: string, data?: any) => {
      console.log(message, data)
      axiomLog.info(message, data)
    },
    error: (message: string, error?: any) => {
      console.error(message, error)
      axiomLog.error(message, { error })
    },
    warn: (message: string, data?: any) => {
      console.warn(message, data)
      axiomLog.warn(message, data)
    },
  }
  ```

- [ ] 替换 console.log
  - [ ] 全局搜索替换 `console.log` → `logger.info`
  - [ ] 全局搜索替换 `console.error` → `logger.error`
  - [ ] 全局搜索替换 `console.warn` → `logger.warn`

- [ ] 测试日志收集
  - [ ] 触发各种操作
  - [ ] 在 Axiom Dashboard 查看日志
  - [ ] 测试日志搜索
  - [ ] 设置告警规则 (可选)

---

## ✅ 阶段 4: 测试验证

### 功能测试

- [ ] 用户认证
  - [ ] 邮箱注册
  - [ ] 邮箱登录
  - [ ] Google OAuth 登录
  - [ ] Google One-Tap 登录
  - [ ] 验证码登录
  - [ ] 退出登录
  - [ ] Session 持久化

- [ ] 视频生成
  - [ ] 文本转视频
  - [ ] 图像转视频
  - [ ] 状态轮询
  - [ ] 积分扣除
  - [ ] 视频下载到 Supabase
  - [ ] 缩略图生成
  - [ ] 存储配额更新

- [ ] 后台任务
  - [ ] Inngest 任务执行
  - [ ] 任务重试机制
  - [ ] 延迟任务 (24h 清理)
  - [ ] 任务失败处理

- [ ] 支付流程
  - [ ] Stripe Checkout
  - [ ] Webhook 处理
  - [ ] 订阅创建
  - [ ] 积分充值
  - [ ] 订阅取消

- [ ] 定时任务
  - [ ] Vercel Cron 执行
  - [ ] 博客文章生成
  - [ ] 日志记录

- [ ] 日志和监控
  - [ ] Axiom 日志收集
  - [ ] 错误追踪
  - [ ] 性能监控

---

### 性能测试

- [ ] 首屏加载速度
  - [ ] 使用 Lighthouse 测试
  - [ ] 对比 Docker vs Vercel
  - [ ] 目标: <1 秒
  - [ ] 测试结果: `_______` 秒

- [ ] API 响应时间
  - [ ] 测试 `/api/video/generate`
  - [ ] 测试 `/api/user/profile`
  - [ ] 测试 `/api/subscription/orders`
  - [ ] 目标: P95 < 500ms
  - [ ] 测试结果: `_______` ms

- [ ] 任务执行时间
  - [ ] 视频下载任务
  - [ ] 缩略图生成任务
  - [ ] 对比 BullMQ vs Inngest

- [ ] 缓存性能
  - [ ] Redis 响应时间
  - [ ] 缓存命中率
  - [ ] 目标: >80%

---

### 压力测试

- [ ] 并发用户测试
  - [ ] 使用 k6 或 Artillery
  - [ ] 模拟 100 并发用户
  - [ ] 监控错误率
  - [ ] 监控响应时间

- [ ] 视频生成压力
  - [ ] 同时生成 50 个视频
  - [ ] 验证 Inngest 处理能力
  - [ ] 验证 Vercel 自动扩容

- [ ] 数据库压力
  - [ ] 高并发查询
  - [ ] 验证 Supabase 连接池
  - [ ] 验证 Upstash Redis

- [ ] 稳定性测试
  - [ ] 运行 24 小时
  - [ ] 监控内存使用
  - [ ] 监控错误率

---

## ✅ 阶段 5: 正式上线

### 灰度发布 (10% 流量)

- [ ] 配置测试域名
  - [ ] `test.vidfab.ai` 指向 Vercel

- [ ] 导流 10% 用户
  - [ ] 通过 DNS 或 CDN 分流

- [ ] 监控 24 小时
  - [ ] 错误率监控
  - [ ] 性能监控
  - [ ] 用户反馈

- [ ] 问题修复
  - [ ] 记录发现的问题
  - [ ] 快速修复并部署

---

### 扩大灰度 (50% 流量)

- [ ] 分析 10% 灰度数据
  - [ ] 错误率对比
  - [ ] 性能对比
  - [ ] 成本对比

- [ ] 扩大到 50% 流量

- [ ] 继续监控 48 小时

---

### 全量上线 (100% 流量)

- [ ] 最终检查
  - [ ] 所有测试通过
  - [ ] 性能达标
  - [ ] 成本在预算内

- [ ] 更新主域名 DNS
  - [ ] `vidfab.ai` 指向 Vercel
  - [ ] 保留旧域名作为备份

- [ ] 验证全量流量
  - [ ] 监控 Vercel Dashboard
  - [ ] 监控 Inngest Dashboard
  - [ ] 监控 Axiom 日志

- [ ] 关闭 Docker 环境
  - [ ] 停止 Docker Compose
  - [ ] 保留镜像 2 周作为备份
  - [ ] 计划取消 VPS (1个月后)

---

### 后续优化

- [ ] 性能优化
  - [ ] 分析慢查询
  - [ ] 优化缓存策略
  - [ ] 优化图片加载

- [ ] 成本优化
  - [ ] 分析实际用量
  - [ ] 调整套餐等级
  - [ ] 设置用量告警

- [ ] 文档更新
  - [ ] 更新部署文档
  - [ ] 更新运维手册
  - [ ] 团队知识分享

---

## 📋 最终验收标准

### 必须达成 (Must Have)

- [ ] ✅ 所有功能正常运行
- [ ] ✅ 数据零丢失
- [ ] ✅ 性能不低于当前
- [ ] ✅ 错误率 <0.1%
- [ ] ✅ 初期成本 ≤ $30/月

### 期望达成 (Should Have)

- [ ] ✅ 首屏加载 <1秒
- [ ] ✅ API P95 <500ms
- [ ] ✅ 部署时间 <1分钟
- [ ] ✅ 自动扩容正常

### 最好达成 (Nice to Have)

- [ ] ✅ 全球延迟 <100ms
- [ ] ✅ Preview 环境自动创建
- [ ] ✅ 日志查询体验优秀

---

## 🎉 迁移完成

- [ ] 团队庆祝 🎉
- [ ] 项目总结会议
- [ ] 经验文档化
- [ ] 归档迁移文档

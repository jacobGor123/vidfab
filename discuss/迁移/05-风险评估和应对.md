# VidFab 云原生迁移风险评估和应对方案

## 📊 风险总览

| 风险等级 | 风险数量 | 严重程度 |
|---------|---------|---------|
| 🔴 高风险 | 3 | 需重点关注 |
| 🟡 中风险 | 5 | 需要准备 |
| 🟢 低风险 | 4 | 可接受 |

---

## 🔴 高风险项

### 风险 1: 任务队列迁移失败,导致视频处理中断

**风险描述**:
- BullMQ → Inngest 迁移过程中,可能导致任务丢失
- 正在处理的任务可能被中断
- 新旧系统切换时可能有空窗期

**影响范围**:
- ⚠️ 用户体验: 视频生成失败
- ⚠️ 业务影响: 用户投诉,积分退款
- ⚠️ 数据完整性: 未完成的任务记录

**发生概率**: 中 (30%)

**影响程度**: 高

**应对策略**:

#### 1. 分阶段迁移

```typescript
// Phase 1: 双写模式 (新任务同时写入 BullMQ 和 Inngest)
async function addVideoTask(data: VideoJobData) {
  // 旧系统
  await bullMQQueue.add('download_video', data)

  // 新系统 (测试)
  await inngest.send({
    name: 'video/download.requested',
    data
  })

  // 两个系统并行运行,观察 Inngest 是否正常
}

// Phase 2: 只用 Inngest (1周后,确认稳定)
async function addVideoTask(data: VideoJobData) {
  await inngest.send({
    name: 'video/download.requested',
    data
  })
}
```

#### 2. 任务状态监控

```typescript
// 在数据库中记录任务状态
await supabase
  .from('video_processing_tasks')
  .insert({
    video_id: videoId,
    status: 'pending',
    queue_system: 'inngest',  // 标记使用的队列系统
    created_at: new Date()
  })

// 定期检查未完成任务 (超过 30 分钟)
const stuckTasks = await supabase
  .from('video_processing_tasks')
  .select('*')
  .eq('status', 'pending')
  .lt('created_at', new Date(Date.now() - 30 * 60 * 1000))

// 手动重试或告警
```

#### 3. 回滚方案

```typescript
// 保留 BullMQ 代码 2 周
// 如果 Inngest 出问题,立即切回 BullMQ

if (process.env.USE_LEGACY_QUEUE === 'true') {
  // 使用 BullMQ
  await bullMQQueue.add('download_video', data)
} else {
  // 使用 Inngest
  await inngest.send({ name: 'video/download.requested', data })
}
```

#### 4. 用户通知机制

```typescript
// 如果任务失败,通知用户并退款
async function handleTaskFailure(videoId: string, userId: string) {
  // 1. 退还积分
  await refundCredits(userId, videoId)

  // 2. 发送邮件通知
  await sendEmail(userId, {
    subject: 'Video generation failed - Credits refunded',
    body: 'We encountered a technical issue...'
  })

  // 3. 记录日志
  logger.error('Task failed', { videoId, userId })
}
```

**验收标准**:
- ✅ 任务成功率 >99%
- ✅ 平均处理时间与 BullMQ 相当
- ✅ 零任务丢失

---

### 风险 2: Vercel 部署失败,导致服务不可用

**风险描述**:
- 首次部署可能因配置错误失败
- 构建过程中可能遇到依赖问题
- 环境变量配置错误导致功能异常

**影响范围**:
- ⚠️ 用户体验: 网站无法访问
- ⚠️ 业务影响: 服务完全中断
- ⚠️ 声誉影响: 用户信任度下降

**发生概率**: 低 (15%)

**影响程度**: 高

**应对策略**:

#### 1. 充分的本地测试

```bash
# 本地模拟 Vercel 环境
vercel dev

# 测试所有功能
- 用户注册/登录
- 视频生成
- 支付流程
- API 路由
```

#### 2. 使用 Preview 部署

```bash
# 先部署到 Preview 环境
git checkout -b test/vercel-migration
git push origin test/vercel-migration

# Vercel 自动生成 Preview URL
# 在 Preview 环境充分测试
```

#### 3. 灰度发布策略

```
Week 1: 只在测试域名部署 (test.vidfab.ai)
Week 2: 导流 10% 用户 → 观察 24 小时
Week 3: 导流 50% 用户 → 观察 48 小时
Week 4: 全量上线 (100%)
```

#### 4. 保留 Docker 备份

```bash
# Docker 容器继续运行 2 周
# 如果 Vercel 出问题,立即切回 Docker

# 通过 DNS 快速切换
vidfab.ai A 记录:
- Vercel IP (主)
- Docker VPS IP (备)

# 5 分钟内可以切回
```

#### 5. 健康检查端点

```typescript
// /app/api/health/route.ts
export async function GET() {
  try {
    // 检查数据库连接
    const { data, error } = await supabase.from('users').select('count').single()
    if (error) throw error

    // 检查 Redis 连接
    await redis.ping()

    // 检查 Inngest 连接 (可选)

    return Response.json({
      status: 'healthy',
      timestamp: new Date().toISOString(),
      services: {
        database: 'ok',
        redis: 'ok'
      }
    })
  } catch (error) {
    return Response.json(
      { status: 'unhealthy', error: String(error) },
      { status: 503 }
    )
  }
}
```

**验收标准**:
- ✅ 首次部署成功
- ✅ 健康检查通过
- ✅ 所有功能正常

---

### 风险 3: 成本超预算

**风险描述**:
- 流量突增导致 Vercel 成本暴涨
- Inngest 步骤数超过免费套餐
- Cloudinary 带宽超过免费额度

**影响范围**:
- ⚠️ 财务影响: 月度成本超预算
- ⚠️ 现金流: 意外支出

**发生概率**: 中 (25%)

**影响程度**: 中

**应对策略**:

#### 1. 设置用量告警

```javascript
// Vercel: 在 Dashboard 设置告警
Bandwidth: 80% of 1TB → 发送邮件
Functions: 80% of 1000h → 发送邮件

// Inngest: 在 Dashboard 设置告警
Steps: 20,000 / 25,000 → 发送邮件

// Upstash: 在 Dashboard 设置告警
Commands: 8,000 / 10,000 per day → 发送邮件
```

#### 2. 成本监控脚本

```typescript
// /scripts/monitor-costs.ts
import { inngest } from '@/lib/inngest/client'

// 每天检查用量
export async function checkDailyCosts() {
  // 1. 查询 Inngest 用量
  const inngestUsage = await getInngestUsage()
  console.log(`Inngest steps used: ${inngestUsage.steps} / 25,000`)

  // 2. 查询 Vercel 用量 (通过 API)
  const vercelUsage = await getVercelUsage()
  console.log(`Vercel bandwidth: ${vercelUsage.bandwidth}GB / 1TB`)

  // 3. 如果超过 80%,发送告警
  if (inngestUsage.steps > 20000) {
    await sendAlert('Inngest usage high', inngestUsage)
  }
}
```

#### 3. 优化策略

```typescript
// 如果成本超标,立即优化:

// 优化 1: 减少不必要的任务
// 例如: 缩略图生成失败不重试 3 次,改为 1 次

// 优化 2: 合并任务步骤
// 原来: download (1步) + upload (1步) = 2步
// 优化: downloadAndUpload (1步) = 1步

// 优化 3: 使用更便宜的替代方案
// 如果 Cloudinary 太贵,切换到自建方案
```

#### 4. 预算控制

```
第1个月: 严格控制在 $30 以内
第2个月: 根据实际业务增长,最高 $50
第3个月: 根据营收情况,最高 $100
```

**验收标准**:
- ✅ 第1个月成本 ≤ $30
- ✅ 所有服务用量 <80%
- ✅ 用量告警正常工作

---

## 🟡 中风险项

### 风险 4: 缓存数据丢失

**风险描述**:
- Redis 迁移过程中,缓存数据可能丢失
- 用户 Session 可能失效
- 需要重新登录

**影响范围**:
- ⚠️ 用户体验: 需要重新登录
- ⚠️ 性能: 缓存未命中,查询变慢

**发生概率**: 中 (40%)

**影响程度**: 中

**应对策略**:

1. **提前通知用户**
   ```
   在网站顶部显示横幅:
   "系统升级中,可能需要重新登录,敬请谅解"
   ```

2. **选择低峰期迁移**
   ```
   选择凌晨 2:00-4:00 进行迁移
   此时用户最少,影响最小
   ```

3. **缓存预热**
   ```typescript
   // 迁移后,预热热点数据
   async function warmupCache() {
     // 预热用户数据
     const activeUsers = await supabase
       .from('users')
       .select('*')
       .limit(1000)

     for (const user of activeUsers) {
       await redis.set(`user:${user.id}`, JSON.stringify(user), { ex: 3600 })
     }

     // 预热其他热点数据...
   }
   ```

4. **Session 持久化**
   ```typescript
   // 使用 Supabase 持久化 Session (已有)
   // 即使 Redis 清空,Session 也不会丢失
   ```

---

### 风险 5: 第三方服务不稳定

**风险描述**:
- Inngest 服务宕机
- Upstash Redis 不可用
- Cloudinary API 限流

**影响范围**:
- ⚠️ 服务可用性: 部分功能不可用
- ⚠️ 用户体验: 操作失败

**发生概率**: 低 (10%)

**影响程度**: 中

**应对策略**:

1. **降级方案**
   ```typescript
   // Inngest 不可用时,降级到本地处理
   async function addVideoTask(data: VideoJobData) {
     try {
       await inngest.send({ name: 'video/download.requested', data })
     } catch (error) {
       // Inngest 不可用,降级到同步处理
       console.warn('Inngest unavailable, using sync processing')
       await downloadVideoSync(data)
     }
   }
   ```

2. **重试机制**
   ```typescript
   // 自动重试 3 次
   async function callInngestWithRetry(data: any) {
     for (let i = 0; i < 3; i++) {
       try {
         return await inngest.send(data)
       } catch (error) {
         if (i === 2) throw error
         await sleep(1000 * Math.pow(2, i))  // 指数退避
       }
     }
   }
   ```

3. **服务监控**
   ```typescript
   // 监控第三方服务状态
   async function checkServiceHealth() {
     const services = {
       inngest: await checkInngest(),
       upstash: await checkUpstash(),
       cloudinary: await checkCloudinary()
     }

     // 如果有服务不可用,发送告警
     const unhealthy = Object.entries(services)
       .filter(([_, healthy]) => !healthy)

     if (unhealthy.length > 0) {
       await sendAlert('Services unhealthy', unhealthy)
     }
   }
   ```

---

### 风险 6: 性能下降

**风险描述**:
- Upstash Redis 比自建慢
- Serverless 冷启动延迟
- API 响应时间变长

**影响范围**:
- ⚠️ 用户体验: 页面加载慢
- ⚠️ SEO: 影响搜索排名

**发生概率**: 中 (30%)

**影响程度**: 低

**应对策略**:

1. **性能基准测试**
   ```bash
   # 迁移前后性能对比
   lighthouse http://localhost:3000  # Before
   lighthouse https://vidfab.ai      # After

   # 目标: 性能分数不降低
   ```

2. **缓存优化**
   ```typescript
   // 增加缓存时间
   await redis.set('key', value, { ex: 7200 })  // 2小时

   // 使用 Vercel Edge Caching
   export const revalidate = 3600  // ISR 缓存 1 小时
   ```

3. **预渲染优化**
   ```typescript
   // 使用 Static Generation
   export async function generateStaticParams() {
     return [/* ... */]
   }

   // 关键页面使用 SSG
   ```

4. **冷启动优化**
   ```typescript
   // 使用 Vercel Edge Functions (更快)
   export const runtime = 'edge'

   // 或使用 Keep-Warm 策略
   ```

---

### 风险 7: 团队学习曲线

**风险描述**:
- 团队不熟悉 Vercel/Inngest
- 调试困难
- 开发效率下降

**影响范围**:
- ⚠️ 开发效率: 短期下降
- ⚠️ 问题修复: 响应变慢

**发生概率**: 高 (60%)

**影响程度**: 低

**应对策略**:

1. **提前培训**
   ```
   Week -1: 团队培训会议 (2小时)
   - Vercel Dashboard 使用
   - Inngest 监控
   - Axiom 日志查询
   ```

2. **文档完善**
   ```
   创建内部知识库:
   - Vercel 部署流程
   - Inngest 调试指南
   - 常见问题 FAQ
   ```

3. **技术支持**
   ```
   指定专人负责:
   - Vercel: 张三
   - Inngest: 李四
   - 整体协调: 王五
   ```

---

### 风险 8: 数据迁移问题

**风险描述**:
- 环境变量配置错误
- 密钥泄露风险
- 数据不一致

**影响范围**:
- ⚠️ 安全: 密钥泄露
- ⚠️ 功能: 配置错误导致异常

**发生概率**: 中 (25%)

**影响程度**: 中

**应对策略**:

1. **使用环境变量管理工具**
   ```bash
   # 使用 Vercel CLI 管理
   vercel env pull .env.vercel.local
   vercel env add SECRET_KEY production

   # 不在代码中硬编码密钥
   ```

2. **密钥轮换**
   ```
   迁移后立即轮换所有密钥:
   - NEXTAUTH_SECRET
   - Stripe Webhook Secret
   - 等等
   ```

3. **配置验证**
   ```typescript
   // /lib/config-validator.ts
   export function validateConfig() {
     const required = [
       'NEXT_PUBLIC_SUPABASE_URL',
       'SUPABASE_SERVICE_ROLE_KEY',
       'INNGEST_EVENT_KEY',
       'UPSTASH_REDIS_REST_URL',
       // ... 所有必需的变量
     ]

     for (const key of required) {
       if (!process.env[key]) {
         throw new Error(`Missing required env var: ${key}`)
       }
     }
   }

   // 在启动时调用
   validateConfig()
   ```

---

## 🟢 低风险项

### 风险 9-12: (略)

低风险项包括:
- 域名迁移失败 (可快速回滚)
- 文档过时 (影响小)
- 监控告警配置错误 (易修复)
- 团队沟通不畅 (可管理)

---

## 📊 风险总结

### 风险矩阵

```
影响程度
  高 │ R1    R2
     │ R5         R3
  中 │      R4 R6 R7
     │           R8
  低 │ R9-R12
     └─────────────────
       低  中  高
         发生概率
```

### 关键风险应对优先级

1. **P0 (最高优先级)**
   - 风险 2: Vercel 部署失败 → 保留 Docker 备份
   - 风险 1: 任务队列迁移 → 分阶段迁移 + 双写模式

2. **P1 (高优先级)**
   - 风险 3: 成本超预算 → 设置告警 + 优化策略
   - 风险 5: 第三方服务不稳定 → 降级方案 + 监控

3. **P2 (中优先级)**
   - 风险 4, 6, 7, 8 → 按计划执行应对策略

---

## 🚨 应急响应流程

### 发生严重问题时:

```
1. 立即评估影响范围
   ├─ 影响所有用户? → 切换回 Docker
   └─ 影响部分功能? → 降级处理

2. 通知相关人员
   ├─ 技术团队: Slack/钉钉
   └─ 用户: 网站公告

3. 执行回滚
   ├─ DNS 切换 (5分钟)
   ├─ 或 Vercel Rollback (1分钟)
   └─ 验证服务恢复

4. 问题分析
   ├─ 查看日志 (Axiom)
   ├─ 查看监控 (Vercel Dashboard)
   └─ 定位根因

5. 修复和验证
   ├─ 修复问题
   ├─ Preview 环境测试
   └─ 重新上线
```

---

## 📞 联系人和升级路径

### 技术支持联系人

| 角色 | 姓名 | 联系方式 | 负责范围 |
|------|------|---------|---------|
| 项目负责人 | [待填写] | [电话/邮箱] | 整体协调 |
| 前端工程师 | [待填写] | [电话/邮箱] | Vercel部署 |
| 后端工程师 | [待填写] | [电话/邮箱] | Inngest/API |
| DevOps | [待填写] | [电话/邮箱] | 监控/告警 |

### 第三方支持

| 服务 | 支持渠道 | 响应时间 |
|------|---------|---------|
| Vercel | support@vercel.com | 24h (Pro) |
| Inngest | Discord/Email | 12h |
| Upstash | support@upstash.com | 24h |
| Cloudinary | support@cloudinary.com | 24h |

---

## 🔗 相关文档

- [01-迁移总览.md](./01-迁移总览.md)
- [04-分阶段执行计划.md](./04-分阶段执行计划.md)
- [10-回滚预案.md](./10-回滚预案.md)

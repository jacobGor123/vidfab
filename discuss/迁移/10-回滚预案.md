# VidFab 云原生迁移回滚预案

## 📋 概述

本文档描述在迁移过程中遇到严重问题时的回滚方案，确保能够快速恢复到 Docker 环境。

---

## 🚨 何时需要回滚

### 立即回滚场景 (P0)

1. **服务完全不可用**
   - Vercel 部署失败，网站无法访问
   - 所有 API 请求返回 500 错误
   - 数据库连接完全断开

2. **严重数据丢失**
   - 用户数据丢失
   - 支付记录丢失
   - 视频文件丢失

3. **安全问题**
   - 密钥泄露
   - 未授权访问
   - 数据泄露

### 考虑回滚场景 (P1)

1. **功能严重异常**
   - 视频生成成功率 <80%
   - 支付流程完全失败
   - 任务队列处理失败率 >20%

2. **性能严重下降**
   - 首屏加载时间 >5秒
   - API 响应时间 >3秒
   - 大量用户投诉

3. **成本失控**
   - 单日成本超过 $100
   - 预计月成本 >$500

---

## ⏱️ 回滚时间估算

| 回滚方式 | 时间 | 难度 | 推荐场景 |
|---------|------|------|---------|
| **DNS 切换** | 5-10 分钟 | 低 | Vercel 可用,只是有问题 |
| **Vercel Rollback** | 1-2 分钟 | 极低 | 部署版本有问题 |
| **完全回滚到 Docker** | 15-30 分钟 | 中 | Vercel 完全不可用 |

---

## 🔄 回滚方案 1: Vercel 版本回滚 (最快)

### 适用场景
- 最新部署有 Bug
- Vercel 平台正常
- 之前的版本可用

### 执行步骤

#### 1. 在 Vercel Dashboard 回滚

```
1. 访问 https://vercel.com/dashboard
2. 进入 VidFab 项目
3. 点击 "Deployments"
4. 找到上一个稳定版本
5. 点击 "..." → "Promote to Production"
6. 确认回滚
```

**预计时间**: 1-2 分钟

#### 2. 验证回滚

```bash
# 访问生产环境
curl https://vidfab.ai/api/health

# 检查响应
# 应该返回 200 和健康状态
```

#### 3. 通知团队

```
Slack/钉钉通知:
"已紧急回滚到上一个稳定版本 (xxx),请验证功能"
```

---

## 🔄 回滚方案 2: DNS 切换到 Docker (推荐)

### 适用场景
- Vercel 有严重问题
- Docker 环境仍在运行
- 需要完全切换回旧环境

### 前提条件

**重要**: 在正式切换到 Vercel 后的 **2 周内**，保持 Docker 环境运行！

```bash
# ✅ 保持 Docker 容器运行
docker-compose ps
# 应该看到 vidfab-app 和 vidfab-redis 在运行

# ✅ 确保 Docker 环境可访问
curl http://<docker-vps-ip>:3000/api/health
```

### 执行步骤

#### Step 1: 验证 Docker 环境 (2 分钟)

```bash
# 1. SSH 登录 VPS
ssh user@<vps-ip>

# 2. 检查 Docker 状态
docker-compose ps

# 3. 如果容器已停止,启动它们
docker-compose up -d

# 4. 检查日志
docker-compose logs --tail=50

# 5. 验证健康状态
curl http://localhost:3000/api/health
```

#### Step 2: 更新 DNS 记录 (5 分钟)

**DNS 提供商**: [填写你的 DNS 提供商]

```
1. 登录 DNS 管理后台
2. 找到 vidfab.ai 的 A 记录
3. 修改 A 记录:
   从: <Vercel IP>
   到: <Docker VPS IP>
4. 设置 TTL = 300 (5分钟)
5. 保存更改
```

**预计 DNS 生效时间**: 5-30 分钟 (取决于 TTL)

#### Step 3: 监控 DNS 传播 (5-30 分钟)

```bash
# 检查 DNS 是否已切换
dig vidfab.ai +short

# 应该返回 Docker VPS 的 IP
# 如果还是 Vercel IP,等待 5 分钟后再检查

# 从不同地区检查
https://dnschecker.org/#A/vidfab.ai
```

#### Step 4: 验证服务 (2 分钟)

```bash
# 访问生产域名
curl https://vidfab.ai/api/health

# 测试关键功能
- 用户登录
- 视频生成
- 支付流程
```

#### Step 5: 通知用户 (可选)

```html
<!-- 在网站顶部显示横幅 -->
<div style="background: #fef3c7; padding: 12px; text-align: center;">
  系统已切换到备用环境，部分用户可能需要重新登录
</div>
```

**总耗时**: 15-40 分钟

---

## 🔄 回滚方案 3: 完全重建 Docker 环境 (最后手段)

### 适用场景
- Docker 容器已经停止/删除
- 需要从零重建
- 备份数据可用

### 前提条件

```bash
# 需要的备份文件:
- Docker 镜像或 Dockerfile
- .env.local 文件
- docker-compose.yml
- 代码仓库访问权限
```

### 执行步骤

#### Step 1: 准备 VPS 环境 (5 分钟)

```bash
# SSH 登录 VPS
ssh user@<vps-ip>

# 安装 Docker (如果未安装)
curl -fsSL https://get.docker.com | sh
sudo systemctl start docker
sudo systemctl enable docker

# 安装 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

#### Step 2: 拉取代码 (3 分钟)

```bash
# 克隆仓库
git clone <repo-url> vidfab
cd vidfab

# 切换到迁移前的稳定分支
git checkout <stable-branch>  # 例如: main or stable
```

#### Step 3: 恢复配置 (3 分钟)

```bash
# 恢复 .env.local
# 从备份复制或手动创建

# 恢复 docker-compose.yml
# 应该已经在代码仓库中

# 启动独立 Redis (如果需要)
./scripts/redis-start.sh
```

#### Step 4: 构建和启动 (10 分钟)

```bash
# 构建 Docker 镜像
docker-compose build

# 启动容器
docker-compose up -d

# 查看日志
docker-compose logs -f
```

#### Step 5: 验证服务 (2 分钟)

```bash
# 检查容器状态
docker-compose ps

# 健康检查
curl http://localhost:3000/api/health

# 测试关键功能
```

#### Step 6: 更新 DNS (同方案 2)

```
更新 DNS A 记录指向 VPS IP
等待 DNS 传播
```

**总耗时**: 30-60 分钟

---

## 📊 回滚决策流程图

```
发现严重问题
    ↓
问题是否可以快速修复? (< 5分钟)
    ├─ 是 → 尝试修复 → 修复成功?
    │           ├─ 是 → 继续监控
    │           └─ 否 → 继续下一步
    └─ 否 → 继续下一步
    ↓
是否只是最新部署有问题?
    ├─ 是 → 方案 1: Vercel 版本回滚 (1-2分钟)
    └─ 否 → 继续下一步
    ↓
Docker 环境是否正在运行?
    ├─ 是 → 方案 2: DNS 切换 (15-40分钟)
    └─ 否 → 方案 3: 重建 Docker (30-60分钟)
```

---

## 🔍 回滚后检查清单

### 必须验证的功能

- [ ] **用户认证**
  - [ ] 邮箱登录
  - [ ] Google OAuth
  - [ ] Session 持久化

- [ ] **核心业务**
  - [ ] 视频生成 (文本转视频)
  - [ ] 视频生成 (图像转视频)
  - [ ] 视频下载
  - [ ] 缩略图显示

- [ ] **支付流程**
  - [ ] Stripe Checkout
  - [ ] Webhook 处理
  - [ ] 积分充值

- [ ] **后台任务**
  - [ ] 视频下载任务
  - [ ] 缩略图生成
  - [ ] 定时任务 (博客生成)

- [ ] **性能指标**
  - [ ] 首屏加载 < 3秒
  - [ ] API 响应 < 1秒

---

## 📝 回滚后的后续步骤

### 1. 问题分析 (当天完成)

```markdown
创建事故报告文档:

## 事故时间
- 发生时间: [yyyy-mm-dd HH:mm]
- 发现时间: [yyyy-mm-dd HH:mm]
- 回滚时间: [yyyy-mm-dd HH:mm]
- 恢复时间: [yyyy-mm-dd HH:mm]

## 影响范围
- 受影响用户数: [数量]
- 受影响功能: [列表]
- 数据丢失: [有/无]

## 根本原因
[详细描述]

## 已采取措施
[列表]

## 待改进项
[列表]
```

### 2. 技术总结 (3 天内)

- [ ] 团队复盘会议
- [ ] 更新迁移计划
- [ ] 修复发现的问题
- [ ] 加强测试用例

### 3. 用户沟通 (如需要)

```
主题: 系统升级问题说明

尊敬的用户:

我们在系统升级过程中遇到了技术问题,已紧急回滚到稳定版本。
期间可能影响了您的使用,我们深表歉意。

作为补偿:
- 所有用户赠送 XXX 积分
- 会员用户延长 X 天有效期

感谢您的理解和支持!

VidFab 团队
```

### 4. 重新规划迁移 (1 周内)

- [ ] 评估是否继续迁移
- [ ] 如果继续,修订迁移计划
- [ ] 增加测试覆盖
- [ ] 降低风险措施

---

## 🛡️ 预防性措施

### 迁移期间的保护措施

#### 1. 保持 Docker 备份 (必须!)

```bash
# 迁移后 2 周内,保持 Docker 环境运行
# 每天检查 Docker 状态

# 定时任务 (crontab)
0 */6 * * * docker-compose ps | mail -s "Docker Status" admin@vidfab.ai
```

#### 2. 数据库备份

```bash
# 迁移前备份
pg_dump -h <supabase-host> -U postgres vidfab > backup-$(date +%Y%m%d).sql

# 迁移后继续自动备份 (Supabase 自带)
```

#### 3. 监控告警

```javascript
// 设置关键指标告警
- 错误率 > 1% → 立即告警
- 响应时间 > 3秒 → 立即告警
- 任务失败率 > 10% → 立即告警
```

#### 4. 灰度发布

```
不要一次性切换所有流量!

Day 1-3:  10% 流量
Day 4-7:  50% 流量
Day 8+:   100% 流量

每个阶段监控 48 小时无问题再继续
```

---

## 📞 紧急联系人

### 发现问题时的升级路径

```
Level 1: 开发人员
  ├─ 5分钟内无法解决
  └─ 上报 Level 2

Level 2: 技术负责人
  ├─ 15分钟内无法解决
  └─ 上报 Level 3

Level 3: 项目负责人
  └─ 决定是否回滚
```

### 联系方式

| 级别 | 姓名 | 角色 | 电话 | 邮箱 |
|------|------|------|------|------|
| L1 | [待填写] | 后端开发 | [手机] | [邮箱] |
| L1 | [待填写] | 前端开发 | [手机] | [邮箱] |
| L2 | [待填写] | 技术负责人 | [手机] | [邮箱] |
| L3 | [待填写] | 项目负责人 | [手机] | [邮箱] |

---

## 📚 相关文档

- [01-迁移总览.md](./01-迁移总览.md) - 迁移背景
- [04-分阶段执行计划.md](./04-分阶段执行计划.md) - 执行步骤
- [05-风险评估和应对.md](./05-风险评估和应对.md) - 风险管理

---

## ✅ 回滚演练

**建议**: 在正式迁移前,进行一次回滚演练

```
Day -7: 在测试环境模拟回滚
  1. 部署到 Vercel 测试环境
  2. 模拟 DNS 切换
  3. 验证 Docker 环境可用
  4. 计时整个回滚过程
  5. 记录遇到的问题
  6. 优化回滚流程
```

**目标**: 确保团队熟悉回滚流程,能在 15 分钟内完成回滚。

# VidFab 积分系统代码快速参考

**用途**: 快速查找积分系统相关代码位置和使用方法  
**更新日期**: 2025-11-13

---

## 目录

1. [文件位置地图](#文件位置地图)
2. [核心类和方法](#核心类和方法)
3. [常见操作代码片段](#常见操作代码片段)
4. [数据库表结构速查](#数据库表结构速查)
5. [API 端点速查](#api-端点速查)

---

## 文件位置地图

### 核心业务逻辑

```
lib/subscription/
├── credits-manager.ts              ⭐ 主要服务类（602行）
│   ├── reserveCredits()            预扣积分
│   ├── consumeCredits()            消费积分
│   ├── releaseCredits()            释放积分
│   ├── checkCreditsAvailability()  检查可用性
│   ├── checkModelAccess()          检查模型访问
│   ├── checkConcurrentJobs()       检查并发限制
│   ├── addBonusCredits()           添加奖励积分
│   ├── batchCreditsOperation()     批量操作
│   └── getCreditsHistory()         获取交易历史
│
├── subscription-service.ts         订阅服务
├── pricing-config.ts               定价配置
├── types.ts                        类型定义
└── stripe-config.ts                Stripe 集成
```

### 数据库层

```
lib/database/
├── subscription-schema.sql         ⭐ 扩展 Schema（289行）
│   ├── credits_transactions        交易记录表
│   ├── credits_reservations        预扣记录表
│   ├── subscription_orders         订阅订单表
│   ├── subscription_changes        套餐变更表
│   ├── reserve_user_credits()      RPC 函数
│   ├── consume_reserved_credits()  RPC 函数
│   ├── update_user_credits_balance()  RPC 函数
│   └── batch_credits_update()      RPC 函数
│
├── credits-functions.sql           ⭐ 核心 RPC 函数（456行）
├── user-quota-functions.sql        用户配额函数
└── database-schema.sql             基础表结构
```

### 用户服务

```
services/
└── user.ts                         ⭐ 用户管理服务（474行）
    ├── saveUser()                  注册/更新用户
    ├── getUserByUuid()             查询用户
    ├── updateUser()                更新用户
    ├── updateUserCredits()         扣除积分
    ├── addUserCredits()            增加积分
    └── getUserProfile()            获取用户资料

types/
└── user.ts                         用户类型定义
```

### API 路由

```
app/api/
├── subscription/
│   ├── credits/
│   │   ├── check/route.ts          ⭐ 积分检查 API
│   │   ├── reserve/route.ts        预扣 API
│   │   ├── consume/route.ts        消费 API
│   │   └── release/route.ts        释放 API
│   └── ...
│
├── user/
│   └── credits/route.ts            ⭐ 用户积分查询 API
│
└── admin/
    └── update-credits-direct/route.ts  ⭐ 管理员积分更新
```

---

## 核心类和方法

### CreditsManager 类

**文件**: `/Users/jacob/Desktop/vidfab/lib/subscription/credits-manager.ts`

#### 方法签名速查表

| 方法 | 参数 | 返回值 | 用途 |
|------|------|--------|------|
| `reserveCredits()` | userUuid, model, resolution, duration, videoJobId?, userEmail? | string (预扣ID) | 预扣积分 |
| `consumeCredits()` | reservationId, actualCreditsUsed? | CreditsUsageResponse | 消费预扣积分 |
| `releaseCredits()` | reservationId, reason? | boolean | 释放预扣积分 |
| `checkCreditsAvailability()` | userUuid, model, resolution, duration, userEmail? | CreditsBudgetInfo | 检查积分可用性 |
| `checkModelAccess()` | userUuid, model, resolution?, userEmail? | ModelAccessCheck | 检查模型访问权限 |
| `checkConcurrentJobs()` | userUuid, userEmail? | ConcurrentJobsCheck | 检查并发限制 |
| `updateConcurrentJobsCount()` | userUuid, increment | number | 更新并发计数 |
| `getCreditsHistory()` | userUuid, limit=50, offset=0 | CreditsTransaction[] | 获取交易历史 |
| `getActiveReservations()` | userUuid | CreditsReservation[] | 获取活跃预扣记录 |
| `cleanupExpiredReservations()` | - | number | 清理过期预扣 |
| `addBonusCredits()` | userUuid, credits, reason, adminUuid? | number (新余额) | 添加奖励积分 |
| `batchCreditsOperation()` | operations[] | boolean | 批量操作 |

#### 常用类型定义

```typescript
// 预算信息
interface CreditsBudgetInfo {
  current_balance: number;        // 当前余额
  required_credits: number;       // 所需积分
  can_afford: boolean;            // 是否足够
  warning_level: 'none' | 'low' | 'critical';  // 警告级别
  remaining_jobs: number;         // 还能做多少个相同任务
}

// 模型访问检查结果
interface ModelAccessCheck {
  model: string;
  user_plan: PlanId;
  resolution?: string;
  can_access: boolean;
  reason?: string;
}

// 并发任务检查结果
interface ConcurrentJobsCheck {
  user_plan: PlanId;
  current_running: number;        // 当前运行数
  max_allowed: number;            // 最大并发数
  can_start: boolean;             // 能否开始新任务
}

// 积分交易
interface CreditsTransaction {
  id: string;
  user_uuid: string;
  transaction_type: 'earned' | 'spent' | 'refunded' | 'expired' | 'bonus';
  credits_amount: number;
  balance_before: number;
  balance_after: number;
  video_job_id?: string;
  model_used?: string;
  created_at: string;
  metadata: Record<string, any>;
}

// 预扣记录
interface CreditsReservation {
  id: string;
  user_uuid: string;
  reserved_credits: number;
  model_name: string;
  estimated_cost: number;
  status: 'active' | 'consumed' | 'released' | 'expired';
  created_at: string;
  expires_at: string;             // 10分钟后过期
  metadata: Record<string, any>;
}
```

---

## 常见操作代码片段

### 1. 预扣积分（任务开始）

```typescript
import { CreditsManager } from '@/lib/subscription/credits-manager';

const creditsManager = new CreditsManager();

try {
  const reservationId = await creditsManager.reserveCredits(
    userUuid,
    'seedance-v1-pro-t2v',  // model
    '720p',                  // resolution
    '10s',                   // duration
    videoJobId,              // optional
    userEmail                // optional, 备用查询方式
  );
  
  // 保存 reservationId，后续消费或释放时需要用
  console.log('预扣成功:', reservationId);
} catch (error) {
  console.error('预扣失败:', error.message);
  // "Insufficient credits..."
  // "Concurrent job limit exceeded..."
}
```

**异常情况**:
- `Insufficient credits` - 积分不足
- `Concurrent job limit exceeded` - 并发任务达到上限
- `User not found` - 用户不存在

---

### 2. 消费预扣积分（任务完成）

```typescript
const result = await creditsManager.consumeCredits(
  reservationId,        // 预扣时返回的 ID
  actualCreditsUsed     // 实际消费的积分（可选）
);

if (result.success) {
  console.log('消费成功', {
    consumed: result.credits_consumed,
    remaining: result.credits_remaining
  });
} else {
  console.error('消费失败:', result.error);
}
```

**返回值**:
```typescript
interface CreditsUsageResponse {
  success: boolean;
  credits_consumed?: number;   // 实际消费
  credits_remaining?: number;  // 消费后的余额
  error?: string;
}
```

---

### 3. 释放预扣积分（任务失败）

```typescript
const released = await creditsManager.releaseCredits(
  reservationId,
  '视频生成超时'  // 释放原因
);

if (released) {
  console.log('积分已返还给用户');
} else {
  console.log('释放失败，预扣记录可能不存在');
}
```

---

### 4. 检查积分可用性

```typescript
const budgetInfo = await creditsManager.checkCreditsAvailability(
  userUuid,
  'seedance-v1-pro-t2v',
  '720p',
  '10s',
  userEmail  // optional
);

console.log({
  canAfford: budgetInfo.can_afford,
  currentBalance: budgetInfo.current_balance,
  requiredCredits: budgetInfo.required_credits,
  remainingJobs: budgetInfo.remaining_jobs,
  warningLevel: budgetInfo.warning_level  // 'none' | 'low' | 'critical'
});

// 用法示例
if (!budgetInfo.can_afford) {
  // 提示用户升级或购买积分
}

if (budgetInfo.warning_level === 'critical') {
  // 显示警告：积分即将耗尽
}
```

---

### 5. 检查模型访问权限

```typescript
const access = await creditsManager.checkModelAccess(
  userUuid,
  'veo3-fast',    // Lite/Pro/Premium 用户可访问
  '1080p',        // optional
  userEmail       // optional
);

if (!access.can_access) {
  console.log('无法访问:', access.reason);
  // "veo3-fast requires a paid subscription"  (Free 用户)
  // "Free users can only use 480p/720p resolution"
}
```

---

### 6. 检查并发任务限制

```typescript
const concurrent = await creditsManager.checkConcurrentJobs(
  userUuid,
  userEmail  // optional
);

console.log({
  userPlan: concurrent.user_plan,           // 'free'
  currentRunning: concurrent.current_running, // 1
  maxAllowed: concurrent.max_allowed,        // 1 (free用户) 或 4 (付费)
  canStart: concurrent.can_start             // true/false
});

if (!concurrent.can_start) {
  // 拒绝新任务请求
  return { error: '已达到最大并发任务数' };
}
```

---

### 7. 批量添加奖励积分

```typescript
// 单个用户
const newBalance = await creditsManager.addBonusCredits(
  userUuid,
  100,                    // 积分数
  '推荐奖励',             // 原因
  adminUuid               // optional, 执行者
);

console.log('新余额:', newBalance);
```

---

### 8. 批量操作积分

```typescript
const success = await creditsManager.batchCreditsOperation([
  {
    userUuid: 'user-1-uuid',
    creditsChange: 100,
    transactionType: 'bonus',
    description: '邀请朋友奖励',
    metadata: {
      campaign_id: 'referral-2025-01',
      referred_user: 'user-2-uuid'
    }
  },
  {
    userUuid: 'user-2-uuid',
    creditsChange: 50,
    transactionType: 'bonus',
    description: '新用户奖励',
    metadata: {
      campaign_id: 'new-user-2025-01'
    }
  }
]);

if (success) {
  console.log('批量操作成功');
} else {
  console.log('批量操作失败');
}
```

---

### 9. 获取用户交易历史

```typescript
const transactions = await creditsManager.getCreditsHistory(
  userUuid,
  50,   // limit
  0     // offset
);

transactions.forEach(tx => {
  console.log({
    type: tx.transaction_type,        // 'spent'
    amount: tx.credits_amount,        // -50
    balanceAfter: tx.balance_after,   // 250
    model: tx.model_used,             // 'seedance-v1-pro-t2v'
    date: tx.created_at
  });
});
```

---

### 10. 获取活跃预扣记录

```typescript
const activeReservations = await creditsManager.getActiveReservations(userUuid);

activeReservations.forEach(reservation => {
  console.log({
    id: reservation.id,
    model: reservation.model_name,
    reserved: reservation.reserved_credits,
    expiresAt: reservation.expires_at,
    createdAt: reservation.created_at
  });
});
```

---

### 11. 清理过期预扣记录

```typescript
const cleaned = await creditsManager.cleanupExpiredReservations();
console.log(`清理了 ${cleaned} 条过期记录`);
```

这通常在定时任务中调用（如每分钟一次）。

---

### 12. 在用户注册时初始化积分

```typescript
import { saveUser } from '@/services/user';

const newUser = await saveUser({
  email: 'user@example.com',
  nickname: 'John Doe',
  signin_type: 'oauth',
  signin_provider: 'google',
  // ... 其他字段
});

// 新用户会自动获得 50 积分（硬编码）
console.log('初始积分:', newUser.credits_remaining);  // 50
```

---

### 13. 更新用户积分（简化方式）

```typescript
import { updateUserCredits, addUserCredits } from '@/services/user';

// 扣除积分
const remaining = await updateUserCredits(userUuid, 50);

// 增加积分
const newBalance = await addUserCredits(userUuid, 100);
```

⚠️ **注意**: 这些函数没有创建预扣记录和交易日志，只适用于简单场景。生产环境应使用 `CreditsManager`。

---

## 数据库表结构速查

### 1. users 表（关键字段）

```sql
CREATE TABLE users (
    uuid UUID PRIMARY KEY,
    email VARCHAR(255) UNIQUE,
    
    -- 积分相关字段
    credits_remaining INTEGER DEFAULT 10,        -- 当前余额
    subscription_plan VARCHAR(20) DEFAULT 'free',  -- 套餐类型
    subscription_status VARCHAR(20),             -- 'active'
    
    -- 扩展字段（来自 subscription-schema.sql）
    concurrent_jobs_running INTEGER DEFAULT 0,  -- 当前运行的任务数
    credits_last_reset_date TIMESTAMPTZ,        -- 上次月度重置时间
    total_credits_earned INTEGER DEFAULT 0,     -- 历史总收入
    total_credits_spent INTEGER DEFAULT 0,      -- 历史总支出
    
    created_at TIMESTAMPTZ,
    updated_at TIMESTAMPTZ
);
```

**索引**:
```sql
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_subscription_status ON users(subscription_status);
```

---

### 2. credits_transactions 表（交易日志）

```sql
CREATE TABLE credits_transactions (
    id UUID PRIMARY KEY,
    user_uuid UUID NOT NULL REFERENCES users(uuid),
    
    -- 交易类型
    transaction_type VARCHAR(20),  -- 'earned'|'spent'|'refunded'|'bonus'|'expired'
    credits_amount INTEGER,        -- 正数为收入，负数为支出
    
    -- 上下文信息
    balance_before INTEGER,
    balance_after INTEGER,
    
    -- 消费详情
    consumed_by VARCHAR(50),
    video_job_id UUID,
    model_used VARCHAR(50),
    
    created_at TIMESTAMPTZ,
    metadata JSONB,
    description TEXT
);

-- 关键索引
CREATE INDEX idx_credits_transactions_user_uuid ON credits_transactions(user_uuid);
CREATE INDEX idx_credits_transactions_type ON credits_transactions(transaction_type);
CREATE INDEX idx_credits_transactions_created_at ON credits_transactions(created_at);
```

**查询示例**:
```sql
-- 获取用户的所有消费交易
SELECT * FROM credits_transactions
WHERE user_uuid = $1
  AND transaction_type = 'spent'
ORDER BY created_at DESC
LIMIT 50;

-- 获取指定模型的消费统计
SELECT 
    model_used,
    COUNT(*) as usage_count,
    SUM(ABS(credits_amount)) as total_spent
FROM credits_transactions
WHERE user_uuid = $1 AND transaction_type = 'spent'
GROUP BY model_used
ORDER BY total_spent DESC;
```

---

### 3. credits_reservations 表（预扣记录）

```sql
CREATE TABLE credits_reservations (
    id UUID PRIMARY KEY,
    user_uuid UUID NOT NULL REFERENCES users(uuid),
    
    -- 预扣信息
    reserved_credits INTEGER NOT NULL,
    model_name VARCHAR(50),
    estimated_cost INTEGER,
    
    -- 状态管理
    status VARCHAR(20) DEFAULT 'active',  -- 'active'|'consumed'|'released'|'expired'
    
    -- 生命周期管理
    created_at TIMESTAMPTZ,
    expires_at TIMESTAMPTZ,      -- 通常是 NOW() + 10 minutes
    consumed_at TIMESTAMPTZ,
    
    metadata JSONB
);

-- 关键索引
CREATE INDEX idx_credits_reservations_user_uuid ON credits_reservations(user_uuid);
CREATE INDEX idx_credits_reservations_status ON credits_reservations(status);
CREATE INDEX idx_credits_reservations_expires_at ON credits_reservations(expires_at);
```

**查询示例**:
```sql
-- 获取用户的活跃预扣记录
SELECT * FROM credits_reservations
WHERE user_uuid = $1 AND status = 'active'
ORDER BY created_at DESC;

-- 获取已过期的预扣记录（用于清理）
SELECT * FROM credits_reservations
WHERE status = 'active' AND expires_at < NOW();
```

---

### 4. subscription_orders 表（订阅订单）

```sql
CREATE TABLE subscription_orders (
    id UUID PRIMARY KEY,
    user_uuid UUID NOT NULL,
    
    order_type VARCHAR(20),        -- 'subscription'|'upgrade'|'downgrade'
    plan_id VARCHAR(20),           -- 'free'|'lite'|'pro'|'premium'
    billing_cycle VARCHAR(10),     -- 'monthly'|'annual'
    
    amount_cents INTEGER,          -- 价格（分）
    credits_included INTEGER,      -- 随订阅包含的积分
    
    status VARCHAR(20),            -- 'pending'|'completed'|'failed'
    
    -- Stripe 字段
    stripe_payment_intent_id VARCHAR(255),
    stripe_subscription_id VARCHAR(255),
    
    created_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ
);
```

---

## API 端点速查

### 1. 积分检查 API

**端点**: `POST /api/subscription/credits/check`

**请求**:
```json
{
  "model": "seedance-v1-pro-t2v",
  "resolution": "720p",
  "duration": "10s"
}
```

**响应**:
```json
{
  "success": true,
  "can_afford": true,
  "current_balance": 300,
  "required_credits": 50,
  "remaining_jobs": 6,
  "warning_level": "none",
  "concurrent_info": {
    "current_running": 1,
    "max_allowed": 4,
    "can_start_new": true
  },
  "model_access": {
    "model": "seedance-v1-pro-t2v",
    "user_plan": "free",
    "can_access": true
  }
}
```

**文件**: `/Users/jacob/Desktop/vidfab/app/api/subscription/credits/check/route.ts`

---

### 2. 用户积分查询 API

**端点**: `GET /api/user/credits`

**响应**:
```json
{
  "success": true,
  "data": {
    "credits": 300,
    "is_pro": false,
    "is_recharged": true,
    "plan_type": "free",
    "subscription": null
  }
}
```

**文件**: `/Users/jacob/Desktop/vidfab/app/api/user/credits/route.ts`

---

### 3. 管理员积分更新 API（开发环境）

**端点**: `POST /api/admin/update-credits-direct`

**请求**:
```json
{
  "email": "user@example.com",
  "credits": 1000,
  "plan": "pro"
}
```

**响应**:
```json
{
  "success": true,
  "message": "积分和套餐更新成功",
  "before": {
    "credits": 100,
    "plan": "free"
  },
  "after": {
    "credits": 1000,
    "plan": "pro"
  }
}
```

**文件**: `/Users/jacob/Desktop/vidfab/app/api/admin/update-credits-direct/route.ts`

⚠️ **限制**: 仅在开发环境可用

---

### 4. 预扣 API（如果存在）

**端点**: `POST /api/subscription/credits/reserve`

**请求**:
```json
{
  "model": "seedance-v1-pro-t2v",
  "resolution": "720p",
  "duration": "10s",
  "video_job_id": "job-uuid"
}
```

**响应**:
```json
{
  "success": true,
  "reservation_id": "reservation-uuid",
  "credits_reserved": 50,
  "expires_at": "2025-11-13T12:15:00Z"
}
```

---

### 5. 消费 API（如果存在）

**端点**: `POST /api/subscription/credits/consume`

**请求**:
```json
{
  "reservation_id": "reservation-uuid",
  "actual_credits_used": 45
}
```

**响应**:
```json
{
  "success": true,
  "credits_consumed": 45,
  "credits_remaining": 255
}
```

---

## 积分计算规则

### 不同模型的积分成本

**文件**: `/Users/jacob/Desktop/vidfab/lib/subscription/pricing-config.ts`

```typescript
// 示例（根据实际配置）
const CREDITS_COST = {
  'seedance-v1-pro-t2v': {
    '480p': { 5: 10, 10: 15 },
    '720p': { 5: 20, 10: 30 },
    '1080p': { 5: 40, 10: 60 }
  },
  'veo3-fast': {
    '480p': { 5: 25, 10: 45 },
    '720p': { 5: 50, 10: 85 },
    '1080p': { 5: 100, 10: 170 }
  },
  'video-effects': {
    'any': { 'any': 5 }  // 固定5积分
  }
};

// 查询成本
const cost = calculateCreditsRequired('seedance-v1-pro-t2v', '720p', '10s');
// 返回 30
```

---

## 常见数据库查询

### 查看用户的积分统计

```sql
SELECT 
    uuid,
    email,
    subscription_plan,
    credits_remaining,
    total_credits_earned,
    total_credits_spent,
    concurrent_jobs_running,
    credits_last_reset_date
FROM users
WHERE uuid = $1;
```

### 查看某个时间段的交易

```sql
SELECT *
FROM credits_transactions
WHERE user_uuid = $1
  AND created_at >= NOW() - INTERVAL '30 days'
ORDER BY created_at DESC;
```

### 获取所有活跃的预扣记录

```sql
SELECT 
    r.id,
    r.user_uuid,
    r.reserved_credits,
    r.model_name,
    r.expires_at,
    EXTRACT(EPOCH FROM (r.expires_at - NOW())) as seconds_until_expire
FROM credits_reservations r
WHERE r.status = 'active'
ORDER BY r.expires_at ASC;
```

### 统计每个模型的消费

```sql
SELECT 
    model_used,
    COUNT(*) as usage_count,
    SUM(ABS(credits_amount)) as total_credits_spent,
    AVG(ABS(credits_amount)) as avg_credits_per_job
FROM credits_transactions
WHERE transaction_type = 'spent'
GROUP BY model_used
ORDER BY total_credits_spent DESC;
```

---

## 快速调试

### 检查用户是否存在

```typescript
import { getUserByEmail } from '@/services/user';

const user = await getUserByEmail('user@example.com');
if (!user) {
  console.log('用户不存在');
} else {
  console.log(`用户: ${user.nickname}, 积分: ${user.credits_remaining}`);
}
```

### 查看原始用户数据

```typescript
import { supabaseAdmin, TABLES } from '@/lib/supabase';

const { data: user, error } = await supabaseAdmin
  .from(TABLES.USERS)
  .select('*')
  .eq('email', 'user@example.com')
  .single();

console.log(JSON.stringify(user, null, 2));
```

### 查看数据库函数

```sql
-- 列出所有函数
SELECT routine_name, routine_definition
FROM information_schema.routines
WHERE routine_type = 'FUNCTION'
  AND routine_schema = 'public'
  AND routine_name ILIKE '%credit%';
```

---

**快速参考完成** | 版本: 1.0

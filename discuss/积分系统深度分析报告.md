# VidFab ç§¯åˆ†ç³»ç»Ÿæ·±åº¦åˆ†ææŠ¥å‘Š

**ç”Ÿæˆæ—¥æœŸ**: 2025-11-13  
**åˆ†æèŒƒå›´**: ç§¯åˆ†æ•°æ®æ¨¡å‹ã€ä¸šåŠ¡é€»è¾‘ã€APIã€ç”¨æˆ·æ³¨å†Œæµç¨‹  
**çŠ¶æ€**: å®Œæ•´åˆ†æ  

---

## ç›®å½•

1. [æ ¸å¿ƒå‘ç°](#æ ¸å¿ƒå‘ç°)
2. [æ•°æ®æ¨¡å‹è¯¦è§£](#æ•°æ®æ¨¡å‹è¯¦è§£)
3. [ç§¯åˆ†ä¸šåŠ¡é€»è¾‘](#ç§¯åˆ†ä¸šåŠ¡é€»è¾‘)
4. [ç”¨æˆ·æ³¨å†Œæµç¨‹](#ç”¨æˆ·æ³¨å†Œæµç¨‹)
5. [ç°æœ‰åŠŸèƒ½åˆ†æ](#ç°æœ‰åŠŸèƒ½åˆ†æ)
6. [å…³é”®é—®é¢˜ä¸å»ºè®®](#å…³é”®é—®é¢˜ä¸å»ºè®®)

---

## æ ¸å¿ƒå‘ç°

### ç§¯åˆ†ç³»ç»Ÿæ¦‚è§ˆ

VidFab å·²ç»å®ç°äº†**å®Œæ•´ã€æˆç†Ÿçš„ç§¯åˆ†ç³»ç»Ÿ**ï¼ŒåŒ…æ‹¬ä»¥ä¸‹æ ¸å¿ƒç‰¹æ€§ï¼š

| ç‰¹æ€§ | ç°çŠ¶ | è¯´æ˜ |
|------|------|------|
| ç§¯åˆ†ä¸ç”¨æˆ·è´¦æˆ·ç»‘å®š | âœ… å¼ºç»‘å®š | ç§¯åˆ†å­˜å‚¨åœ¨ `users` è¡¨çš„ `credits_remaining` å­—æ®µ |
| é¢„åˆ†é…ç§¯åˆ† | âŒ ä¸æ”¯æŒ | åªæœ‰æ³¨å†Œç”¨æˆ·æ‰èƒ½è·å¾—åˆå§‹ç§¯åˆ† |
| æ‰¹é‡æ“ä½œ | âœ… æ”¯æŒ | å­˜åœ¨ `batchCreditsOperation()` æ–¹æ³• |
| ç§¯åˆ†é¢„æ‰£ | âœ… æ”¯æŒ | `reserve_user_credits()` å‡½æ•°å®ç°åŸå­æ€§é¢„æ‰£ |
| äº¤æ˜“å†å²è¿½è¸ª | âœ… å®Œæ•´ | `credits_transactions` è¡¨è®°å½•æ‰€æœ‰äº¤æ˜“ |
| å¹¶å‘ä»»åŠ¡ç®¡ç† | âœ… å®Œæ•´ | ä¸ç§¯åˆ†é¢„æ‰£åŒæ—¶è¿›è¡Œçš„å¹¶å‘é™åˆ¶ |

---

## æ•°æ®æ¨¡å‹è¯¦è§£

### 1. users è¡¨ï¼ˆæ ¸å¿ƒè¡¨ï¼‰

**æ–‡ä»¶**: `/Users/jacob/Desktop/vidfab/lib/database-schema.sql`

```sql
CREATE TABLE IF NOT EXISTS users (
    uuid UUID PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    -- ... å…¶ä»–åŸºç¡€å­—æ®µ ...
    
    -- ç§¯åˆ†ç›¸å…³å­—æ®µ
    credits_remaining INTEGER DEFAULT 10,           -- å½“å‰ä½™é¢ï¼ˆæ–°ç”¨æˆ·é»˜è®¤10ï¼‰
    subscription_plan VARCHAR(20) DEFAULT 'free',  -- free/lite/pro/premium
    subscription_status VARCHAR(20),                -- active/inactive/cancelled
    
    -- æ‰©å±•å­—æ®µï¼ˆæ¥è‡ª subscription-schema.sqlï¼‰
    concurrent_jobs_running INTEGER DEFAULT 0,      -- å½“å‰è¿è¡Œçš„å¹¶å‘ä»»åŠ¡æ•°
    credits_last_reset_date TIMESTAMPTZ,            -- ä¸Šæ¬¡æœˆåº¦é‡ç½®çš„æ—¶é—´
    total_credits_earned INTEGER DEFAULT 0,         -- å†å²æ€»è·å¾—ç§¯åˆ†
    total_credits_spent INTEGER DEFAULT 0,          -- å†å²æ€»æ¶ˆè´¹ç§¯åˆ†
);
```

**å…³é”®ç‰¹æ€§**:
- ç§¯åˆ†ç›´æ¥å­˜å‚¨åœ¨ç”¨æˆ·è¡¨ï¼Œå¼ºåˆ¶ä¸€ä¸€å¯¹åº”
- æ”¯æŒä¸‰ç»´è·Ÿè¸ªï¼šå½“å‰ä½™é¢ã€å†å²æ”¶å…¥ã€å†å²æ”¯å‡º
- æ²¡æœ‰"ç§¯åˆ†é’±åŒ…"æ¦‚å¿µï¼Œæ²¡æœ‰é¢„åˆ†é…æœºåˆ¶

---

### 2. credits_transactions è¡¨ï¼ˆäº¤æ˜“è®°å½•ï¼‰

**æ–‡ä»¶**: `/Users/jacob/Desktop/vidfab/lib/database/subscription-schema.sql`

```sql
CREATE TABLE IF NOT EXISTS credits_transactions (
    id UUID PRIMARY KEY,
    user_uuid UUID NOT NULL REFERENCES users(uuid),
    
    -- äº¤æ˜“ç±»å‹å’Œæ•°é‡
    transaction_type VARCHAR(20) NOT NULL, -- 'earned'|'spent'|'refunded'|'expired'|'bonus'
    credits_amount INTEGER NOT NULL,       -- æ­£æ•°ä¸ºæ”¶å…¥ï¼Œè´Ÿæ•°ä¸ºæ¶ˆè´¹
    balance_before INTEGER,                 -- äº¤æ˜“å‰ä½™é¢
    balance_after INTEGER,                  -- äº¤æ˜“åä½™é¢
    
    -- æ¶ˆè´¹ç»†èŠ‚
    consumed_by VARCHAR(50),               -- æ¶ˆè´¹æ–¹å¼ï¼ˆå¦‚ 'seedance-v1-pro-t2v'ï¼‰
    video_job_id UUID,                     -- å…³è”çš„è§†é¢‘ä»»åŠ¡
    model_used VARCHAR(50),                -- ä½¿ç”¨çš„æ¨¡å‹
    
    -- æ—¶é—´å’Œå…ƒæ•°æ®
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB,
    description TEXT
);

-- ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX idx_credits_transactions_user_uuid ON credits_transactions(user_uuid);
CREATE INDEX idx_credits_transactions_type ON credits_transactions(transaction_type);
CREATE INDEX idx_credits_transactions_created_at ON credits_transactions(created_at);
```

**é‡è¦ç‰¹æ€§**:
- å®Œæ•´çš„å®¡è®¡æ—¥å¿—ï¼ˆæ¯ç¬”äº¤æ˜“éƒ½æœ‰è®°å½•ï¼‰
- æ”¯æŒå¤šç§äº¤æ˜“ç±»å‹ï¼šæ”¶å…¥ã€æ¶ˆè´¹ã€é€€æ¬¾ã€è¿‡æœŸã€å¥–åŠ±
- å…³è”è§†é¢‘ä»»åŠ¡å’Œæ¨¡å‹ä¿¡æ¯ï¼Œä¾¿äºæˆæœ¬åˆ†æ

---

### 3. credits_reservations è¡¨ï¼ˆé¢„æ‰£è®°å½•ï¼‰

**æ–‡ä»¶**: `/Users/jacob/Desktop/vidfab/lib/database/subscription-schema.sql`

```sql
CREATE TABLE IF NOT EXISTS credits_reservations (
    id UUID PRIMARY KEY,
    user_uuid UUID NOT NULL REFERENCES users(uuid),
    video_job_id UUID REFERENCES video_jobs(id),
    
    -- é¢„æ‰£ä¿¡æ¯
    reserved_credits INTEGER NOT NULL,    -- é¢„æ‰£æ•°é‡
    model_name VARCHAR(50) NOT NULL,      -- ä½¿ç”¨çš„æ¨¡å‹
    estimated_cost INTEGER NOT NULL,      -- é¢„ä¼°æˆæœ¬
    
    -- çŠ¶æ€ç®¡ç†
    status VARCHAR(20) DEFAULT 'active',  -- 'active'|'consumed'|'released'|'expired'
    
    -- æ—¶é—´ç®¡ç†
    created_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ NOT NULL DEFAULT (NOW() + INTERVAL '10 minutes'), -- 10åˆ†é’Ÿè¶…æ—¶
    consumed_at TIMESTAMPTZ,
    
    metadata JSONB
);
```

**è®¾è®¡æ„å›¾**:
- å®ç°"é¢„æ‰£-æ¶ˆè´¹-é‡Šæ”¾"ä¸‰æ€æ¨¡å‹ï¼Œè§£å†³å¹¶å‘å†²çª
- 10åˆ†é’Ÿè¿‡æœŸæ—¶é—´ç¡®ä¿èµ„æºåŠæ—¶é‡Šæ”¾
- æ”¯æŒä»»åŠ¡å¤±è´¥æ—¶ç§¯åˆ†è¿”è¿˜

---

### 4. å…¶ä»–ç›¸å…³è¡¨

#### subscription_ordersï¼ˆè®¢é˜…è®¢å•è¡¨ï¼‰
```sql
CREATE TABLE IF NOT EXISTS subscription_orders (
    id UUID PRIMARY KEY,
    user_uuid UUID NOT NULL,
    order_type VARCHAR(20),    -- 'subscription'|'upgrade'|'downgrade'|'renewal'
    plan_id VARCHAR(20),       -- 'free'|'lite'|'pro'|'premium'
    credits_included INTEGER,  -- éšè®¢é˜…åŒ…å«çš„ç§¯åˆ†æ•°é‡
    status VARCHAR(20),        -- 'pending'|'processing'|'completed'|'failed'
    stripe_subscription_id VARCHAR(255),
    -- ... Stripe ç›¸å…³å­—æ®µ ...
);
```

#### subscription_changesï¼ˆå¥—é¤å˜æ›´å†å²ï¼‰
```sql
CREATE TABLE IF NOT EXISTS subscription_changes (
    id UUID PRIMARY KEY,
    user_uuid UUID NOT NULL,
    from_plan VARCHAR(20),
    to_plan VARCHAR(20),
    credits_before INTEGER,    -- å˜æ›´å‰çš„ç§¯åˆ†
    credits_after INTEGER,     -- å˜æ›´åçš„ç§¯åˆ†
    credits_adjustment INTEGER, -- è°ƒæ•´æ•°é‡
    change_type VARCHAR(20),   -- 'upgrade'|'downgrade'|'new'|'cancel'|'renewal'
    effective_date TIMESTAMPTZ
);
```

---

## ç§¯åˆ†ä¸šåŠ¡é€»è¾‘

### 1. æ ¸å¿ƒæœåŠ¡ç±»ï¼šCreditsManager

**æ–‡ä»¶**: `/Users/jacob/Desktop/vidfab/lib/subscription/credits-manager.ts` (602 è¡Œ)

#### ä¸»è¦æ–¹æ³•

| æ–¹æ³• | åŠŸèƒ½ | è¿”å›å€¼ |
|------|------|--------|
| `reserveCredits()` | é¢„æ‰£ç§¯åˆ†ï¼ˆä»»åŠ¡å¼€å§‹ï¼‰ | é¢„æ‰£ID |
| `consumeCredits()` | æ¶ˆè´¹é¢„æ‰£ç§¯åˆ†ï¼ˆä»»åŠ¡å®Œæˆï¼‰ | æ¶ˆè´¹è¯¦æƒ… |
| `releaseCredits()` | é‡Šæ”¾ç§¯åˆ†ï¼ˆä»»åŠ¡å¤±è´¥ï¼‰ | boolean |
| `checkCreditsAvailability()` | æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ | CreditsBudgetInfo |
| `checkModelAccess()` | æ£€æŸ¥æ¨¡å‹è®¿é—®æƒé™ | ModelAccessCheck |
| `checkConcurrentJobs()` | æ£€æŸ¥å¹¶å‘é™åˆ¶ | ConcurrentJobsCheck |
| `getCreditsHistory()` | è·å–äº¤æ˜“å†å² | CreditsTransaction[] |
| `getActiveReservations()` | è·å–æ´»è·ƒé¢„æ‰£è®°å½• | CreditsReservation[] |
| `addBonusCredits()` | æ‰‹åŠ¨æ·»åŠ ç§¯åˆ†ï¼ˆç®¡ç†å‘˜ï¼‰ | æ–°ä½™é¢ |
| `batchCreditsOperation()` | æ‰¹é‡å¤„ç†ç§¯åˆ†æ“ä½œ | boolean |

#### ä»£ç ç¤ºä¾‹ï¼šé¢„æ‰£æµç¨‹

```typescript
async reserveCredits(
  userUuid: string,
  model: string,
  resolution: string,
  duration: string,
  videoJobId?: string,
  userEmail?: string
): Promise<string> {
  const requiredCredits = calculateCreditsRequired(model, resolution, duration);
  
  // 1. æŸ¥è¯¢ç”¨æˆ·å½“å‰ä½™é¢å’Œå¹¶å‘æ•°
  let { data: user } = await supabaseAdmin
    .from(TABLES.USERS)
    .select('uuid, credits_remaining, concurrent_jobs_running, subscription_plan')
    .eq('uuid', userUuid)
    .single();
  
  // 2. æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ
  if (currentBalance < requiredCredits) {
    throw new Error(`Insufficient credits. Required: ${requiredCredits}, Available: ${currentBalance}`);
  }
  
  // 3. æ£€æŸ¥å¹¶å‘é™åˆ¶ï¼ˆFree:1, å…¶ä»–:4ï¼‰
  const maxConcurrent = user.subscription_plan === 'free' ? 1 : 4;
  if (currentRunning >= maxConcurrent) {
    throw new Error(`Concurrent job limit exceeded`);
  }
  
  // 4. è°ƒç”¨RPCå‡½æ•°è¿›è¡ŒåŸå­æ€§æ“ä½œ
  const { data: reservationId } = await supabaseAdmin.rpc('reserve_user_credits', {
    p_user_uuid: userUuid,
    p_required_credits: requiredCredits,
    p_model_name: model,
    p_video_job_id: videoJobId,
    p_metadata: { resolution, duration, estimated_cost: requiredCredits }
  });
  
  // 5. è‹¥RPCå¤±è´¥ï¼Œé™çº§ä½¿ç”¨ç›´æ¥æ›´æ–°
  if (!reservationId) {
    await supabaseAdmin.from(TABLES.USERS).update({
      credits_remaining: currentBalance - requiredCredits,
      concurrent_jobs_running: currentRunning + 1,
      updated_at: new Date().toISOString()
    }).eq('uuid', userUuid);
  }
  
  return reservationId;
}
```

### 2. æ•°æ®åº“å‡½æ•°ï¼šç²¾ç»†åŒ–åŸå­æ€§æ“ä½œ

**æ–‡ä»¶**: `/Users/jacob/Desktop/vidfab/lib/database/credits-functions.sql`

#### å…³é”® RPC å‡½æ•°

##### â‘  reserve_user_creditsï¼ˆé¢„æ‰£ï¼‰
```sql
CREATE OR REPLACE FUNCTION reserve_user_credits(
    p_user_uuid UUID,
    p_required_credits INTEGER,
    p_model_name VARCHAR(50),
    p_video_job_id UUID DEFAULT NULL,
    p_metadata JSONB DEFAULT '{}'
) RETURNS UUID AS $$
BEGIN
    -- åœ¨å•ä¸ªäº‹åŠ¡ä¸­åŸå­æ€§å®Œæˆï¼š
    -- 1. æ£€æŸ¥ä½™é¢å’Œå¹¶å‘æ•°
    -- 2. åˆ›å»ºé¢„æ‰£è®°å½•
    -- 3. æ›´æ–°ç”¨æˆ·ä½™é¢å’Œå¹¶å‘æ•°
    
    INSERT INTO credits_reservations (...)
    VALUES (...) RETURNING id INTO reservation_id;
    
    UPDATE users
    SET credits_remaining = credits_remaining - p_required_credits,
        concurrent_jobs_running = concurrent_jobs_running + 1
    WHERE uuid = p_user_uuid;
    
    RETURN reservation_id;
END;
$$ LANGUAGE plpgsql;
```

**ç‰¹ç‚¹**: åœ¨æ•°æ®åº“å±‚é¢ä¿è¯åŸå­æ€§ï¼Œé¿å…å¹¶å‘å†²çª

##### â‘¡ consume_reserved_creditsï¼ˆæ¶ˆè´¹ï¼‰
```sql
CREATE OR REPLACE FUNCTION consume_reserved_credits(
    p_reservation_id UUID,
    p_actual_credits INTEGER
) RETURNS JSONB AS $$
BEGIN
    -- è·å–é¢„æ‰£è®°å½•
    SELECT * INTO reservation_record
    FROM credits_reservations
    WHERE id = p_reservation_id AND status = 'active';
    
    -- è®¡ç®—éœ€è¦è¿”è¿˜çš„ç§¯åˆ†
    refund_amount := reservation_record.reserved_credits - p_actual_credits;
    
    -- æ›´æ–°ç”¨æˆ·ä½™é¢ï¼ˆè¿”è¿˜æˆ–é¢å¤–æ‰£é™¤ï¼‰
    UPDATE users
    SET credits_remaining = credits_remaining + refund_amount,
        total_credits_spent = total_credits_spent + p_actual_credits,
        concurrent_jobs_running = GREATEST(0, concurrent_jobs_running - 1)
    WHERE uuid = user_uuid;
    
    -- è®°å½•æ¶ˆè´¹äº¤æ˜“
    INSERT INTO credits_transactions (...);
    
    -- è®°å½•è¿”è¿˜äº¤æ˜“ï¼ˆå¦‚æœæœ‰è¿”è¿˜ï¼‰
    IF refund_amount > 0 THEN
        INSERT INTO credits_transactions (...);
    END IF;
    
    RETURN jsonb_build_object('success', true, ...);
END;
$$ LANGUAGE plpgsql;
```

**ç‰¹ç‚¹**: æ”¯æŒè¿”è¿˜å¤šä½™ç§¯åˆ†ï¼Œç¡®ä¿ç²¾ç¡®æ¶ˆè´¹

##### â‘¢ batch_credits_updateï¼ˆæ‰¹é‡æ›´æ–°ï¼‰
```sql
CREATE OR REPLACE FUNCTION batch_credits_update(operations JSONB)
RETURNS BOOLEAN AS $$
DECLARE
    operation JSONB;
BEGIN
    -- éå†æ‰€æœ‰æ“ä½œ
    FOR operation IN SELECT * FROM jsonb_array_elements(operations)
    LOOP
        -- å¯¹æ¯ä¸ªç”¨æˆ·è¿›è¡Œç§¯åˆ†æ›´æ–°
        UPDATE users
        SET credits_remaining = credits_remaining + credits_change,
            total_credits_spent = ...,
            total_credits_earned = ...
        WHERE uuid = user_uuid;
        
        -- è®°å½•äº¤æ˜“
        INSERT INTO credits_transactions (...);
    END LOOP;
    
    RETURN TRUE;
END;
$$ LANGUAGE plpgsql;
```

**ç‰¹ç‚¹**: æ”¯æŒæ‰¹é‡æ“ä½œï¼Œæ¯ä¸ªæ“ä½œéƒ½æœ‰å®Œæ•´çš„å®¡è®¡æ—¥å¿—

---

## ç”¨æˆ·æ³¨å†Œæµç¨‹

### 1. æ³¨å†Œå…¥å£

**æ–‡ä»¶**: `/Users/jacob/Desktop/vidfab/services/user.ts` (474 è¡Œ)

#### saveUser() å‡½æ•°æµç¨‹

```typescript
export async function saveUser(userData: CreateUserData & { uuid?: string }): Promise<User> {
  const userUuid = userData.uuid || getUserUuidFromEmail(userData.email);
  
  // âœ… å…³é”®ä¿®å¤ï¼šå…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
  const { data: existingUser } = await supabaseAdmin
    .from(TABLES.USERS)
    .select('uuid, subscription_plan, credits_remaining, ...')
    .eq('uuid', userUuid)
    .single();
  
  let userToSave: Partial<DatabaseUser>;
  
  if (existingUser) {
    // === å·²å­˜åœ¨ç”¨æˆ·ï¼šåªæ›´æ–°ç™»å½•ä¿¡æ¯ ===
    console.log(`ğŸ”„ æ›´æ–°å·²å­˜åœ¨ç”¨æˆ·: ${userUuid}`);
    userToSave = {
      uuid: userUuid,
      email: userData.email.toLowerCase().trim(),
      nickname: userData.nickname || userData.email.split('@')[0],
      // ... å…¶ä»–å­—æ®µ ...
      // âœ… ä¿ç•™ç°æœ‰çš„è®¢é˜…å’Œç§¯åˆ†ä¿¡æ¯ï¼ˆä¸è¦†ç›–ï¼‰
      subscription_plan: existingUser.subscription_plan,
      subscription_status: existingUser.subscription_status,
      credits_remaining: existingUser.credits_remaining,
      total_videos_processed: existingUser.total_videos_processed,
    };
  } else {
    // === æ–°ç”¨æˆ·ï¼šåˆå§‹åŒ–é»˜è®¤å€¼ ===
    console.log(`âœ¨ åˆ›å»ºæ–°ç”¨æˆ·: ${userUuid}`);
    userToSave = {
      uuid: userUuid,
      email: userData.email.toLowerCase().trim(),
      // ... å…¶ä»–å­—æ®µ ...
      subscription_status: 'active',
      subscription_plan: 'free',
      credits_remaining: 50,           // â† æ–°ç”¨æˆ·åˆå§‹ç§¯åˆ†ï¼š50
      total_videos_processed: 0,
      storage_used_mb: 0,
      max_storage_mb: 1024,
    };
  }
  
  // ä½¿ç”¨ upsert æ“ä½œ
  const { data, error } = await supabaseAdmin
    .from(TABLES.USERS)
    .upsert(userToSave, {
      onConflict: 'uuid',
      ignoreDuplicates: false
    })
    .select()
    .single();
  
  // âœ… ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœå”¯ä¸€æ€§çº¦æŸå†²çªï¼Œç›´æ¥æŸ¥è¯¢è¿”å›ç°æœ‰ç”¨æˆ·
  if (error?.code === '23505') {
    const { data: existingData } = await supabaseAdmin
      .from(TABLES.USERS)
      .select('*')
      .eq('uuid', userUuid)
      .single();
    return existingData;
  }
  
  return data;
}
```

### 2. æ–°ç”¨æˆ·åˆå§‹ç§¯åˆ†åˆ†é…

| å› ç´  | å½“å‰å€¼ | å¤‡æ³¨ |
|------|-------|------|
| åˆå§‹ç§¯åˆ† | **50** | åœ¨ `saveUser()` ä¸­ç¡¬ç¼–ç  |
| åˆå§‹å¥—é¤ | **free** | åœ¨ `saveUser()` ä¸­ç¡¬ç¼–ç  |
| åˆå§‹çŠ¶æ€ | **active** | åœ¨ `saveUser()` ä¸­ç¡¬ç¼–ç  |
| åˆ†é…æ—¶æœº | **ç¬¬ä¸€æ¬¡æ³¨å†Œ** | ä¹‹åç™»å½•ä¸ä¼šæ”¹å˜ |

**é—®é¢˜**: æ–°ç”¨æˆ·ç§¯åˆ†è¢«ç¡¬ç¼–ç ä¸º 50ï¼Œæ— æ³•çµæ´»é…ç½®

### 3. ç§¯åˆ†é‡ç½®æœºåˆ¶

**æ–‡ä»¶**: `/Users/jacob/Desktop/vidfab/lib/database/subscription-schema.sql` (è¡Œ 189-231)

```sql
CREATE OR REPLACE FUNCTION reset_monthly_credits()
RETURNS void AS $$
DECLARE
    plan_credits INTEGER;
BEGIN
    -- éå†æ‰€æœ‰éœ€è¦é‡ç½®çš„ç”¨æˆ·ï¼ˆä¸Šæœˆæœªé‡ç½®çš„ç”¨æˆ·ï¼‰
    FOR user_record IN
        SELECT uuid, subscription_plan
        FROM users
        WHERE credits_last_reset_date < DATE_TRUNC('month', NOW())
    LOOP
        -- æ ¹æ®å¥—é¤åˆ†é…ç§¯åˆ†
        CASE user_record.subscription_plan
            WHEN 'free' THEN plan_credits := 50;
            WHEN 'lite' THEN plan_credits := 300;
            WHEN 'pro' THEN plan_credits := 1000;
            WHEN 'premium' THEN plan_credits := 2000;
            ELSE plan_credits := 50;
        END CASE;
        
        -- æ›´æ–°ç”¨æˆ·ç§¯åˆ†
        UPDATE users
        SET credits_remaining = plan_credits,
            credits_last_reset_date = NOW(),
            total_credits_earned = total_credits_earned + plan_credits
        WHERE uuid = user_record.uuid;
        
        -- è®°å½•äº¤æ˜“
        INSERT INTO credits_transactions (...)
        VALUES (user_record.uuid, 'earned', plan_credits, ...);
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

**ç‰¹ç‚¹**: 
- æ¯ä¸ªå¥—é¤æœ‰ä¸åŒçš„æœˆåº¦ç§¯åˆ†é…é¢
- åªæœ‰è·¨æœˆæ—¶æ‰ä¼šè§¦å‘é‡ç½®
- å®Œæ•´çš„äº¤æ˜“è®°å½•

---

## ç°æœ‰åŠŸèƒ½åˆ†æ

### 1. æ‰¹é‡æ“ä½œåŠŸèƒ½

**âœ… å·²å®ç°** `batchCreditsOperation()` æ–¹æ³•

```typescript
async batchCreditsOperation(
  operations: Array<{
    userUuid: string;
    creditsChange: number;
    transactionType: 'earned' | 'spent' | 'bonus' | 'refunded';
    description: string;
    metadata?: Record<string, any>;
  }>
): Promise<boolean> {
  try {
    await supabaseAdmin.rpc('batch_credits_update', { operations });
    return true;
  } catch (error) {
    console.error('Error in batch credits operation:', error);
    return false;
  }
}
```

**é™åˆ¶**: åªèƒ½æ“ä½œå·²æœ‰ç”¨æˆ·ï¼Œæ— æ³•ç»™æœªæ³¨å†Œç”¨æˆ·é¢„åˆ†é…

### 2. ç®¡ç†å‘˜ API

**æ–‡ä»¶**: `/Users/jacob/Desktop/vidfab/app/api/admin/update-credits-direct/route.ts`

```typescript
export async function POST(req: NextRequest) {
  // ä»…åœ¨å¼€å‘ç¯å¢ƒå¯ç”¨
  if (process.env.NODE_ENV !== 'development') {
    return NextResponse.json({ success: false }, { status: 403 });
  }
  
  const { email, credits, plan } = await req.json();
  
  // ç›´æ¥æ›´æ–°ç”¨æˆ·ç§¯åˆ†å’Œå¥—é¤
  const { error } = await supabaseAdmin
    .from('users')
    .update({
      credits_remaining: credits,
      subscription_plan: plan,
      subscription_status: 'active'
    })
    .eq('email', email);
  
  return NextResponse.json({ success: !error, ... });
}
```

**ç‰¹ç‚¹**:
- âœ… æ”¯æŒç›´æ¥æ›´æ–°ç§¯åˆ†
- âŒ ä»…åœ¨å¼€å‘ç¯å¢ƒå¯ç”¨
- âŒ æ²¡æœ‰å®¡è®¡æ—¥å¿—

### 3. ç§¯åˆ†æ£€æŸ¥ API

**æ–‡ä»¶**: `/Users/jacob/Desktop/vidfab/app/api/subscription/credits/check/route.ts`

æ”¯æŒä»¥ä¸‹æ£€æŸ¥ï¼š
1. **ç§¯åˆ†å¯ç”¨æ€§æ£€æŸ¥** - `checkCreditsAvailability()`
2. **æ¨¡å‹è®¿é—®æƒé™** - `checkModelAccess()`
3. **å¹¶å‘ä»»åŠ¡é™åˆ¶** - `checkConcurrentJobs()`

```typescript
POST /api/subscription/credits/check
{
  "model": "seedance-v1-pro-t2v",
  "resolution": "720p",
  "duration": "10s"
}

Response:
{
  "success": true,
  "can_afford": true,
  "current_balance": 300,
  "required_credits": 50,
  "remaining_jobs": 6,
  "warning_level": "none",
  "concurrent_info": {
    "current_running": 1,
    "max_allowed": 4,
    "can_start_new": true
  },
  "model_access": {
    "model": "seedance-v1-pro-t2v",
    "user_plan": "free",
    "can_access": true
  }
}
```

### 4. ç”¨æˆ·ç§¯åˆ†æŸ¥è¯¢ API

**æ–‡ä»¶**: `/Users/jacob/Desktop/vidfab/app/api/user/credits/route.ts`

```typescript
GET /api/user/credits

Response:
{
  "success": true,
  "data": {
    "credits": 300,
    "is_pro": false,
    "is_recharged": true,
    "plan_type": "free",
    "subscription": null
  }
}
```

---

## å…³é”®é—®é¢˜ä¸å»ºè®®

### é—®é¢˜ 1: ç§¯åˆ†ä¸ç”¨æˆ·è´¦æˆ·å¼ºç»‘å®š

**ç°çŠ¶**: ç§¯åˆ†å­˜å‚¨åœ¨ `users.credits_remaining` ä¸­ï¼Œæ¯ä¸ªç”¨æˆ·åªæœ‰ä¸€ä¸ªç§¯åˆ†ä½™é¢

**é—®é¢˜**:
- âŒ æ— æ³•ç»™æœªæ³¨å†Œç”¨æˆ·é¢„åˆ†é…ç§¯åˆ†
- âŒ æ— æ³•å®ç°"ç§¯åˆ†èµ é€"åŠŸèƒ½ï¼ˆåªèƒ½æ›´æ–°ä½™é¢ï¼Œæ— æ³•è¿½è¸ªæ¥æºï¼‰
- âŒ æ— æ³•æ”¯æŒå¤šé’±åŒ…æ¦‚å¿µï¼ˆå¦‚"æ¨èå¥–åŠ±ç§¯åˆ†"ä¸"è´­ä¹°ç§¯åˆ†"åˆ†åˆ«ç®¡ç†ï¼‰

**å»ºè®®**:
```typescript
// æ–¹æ¡ˆA: åˆ›å»ºç§¯åˆ†é’±åŒ…è¡¨ï¼ˆæ¨èï¼‰
CREATE TABLE IF NOT EXISTS credit_wallets (
    id UUID PRIMARY KEY,
    user_uuid UUID REFERENCES users(uuid),  -- å…è®¸NULLï¼Œæ”¯æŒæœªæ³¨å†Œç”¨æˆ·
    wallet_type VARCHAR(20),                -- 'free'|'purchased'|'bonus'|'referred'
    balance INTEGER DEFAULT 0,
    source VARCHAR(100),                    -- æ¥æºè¯´æ˜
    created_at TIMESTAMPTZ,
    expires_at TIMESTAMPTZ,                 -- æœ‰æ•ˆæœŸï¼ˆå¯é€‰ï¼‰
    metadata JSONB
);

// æ–¹æ¡ˆB: é¢„åˆ†é…è¡¨ï¼ˆä»…æ”¯æŒå·²æ³¨å†Œç”¨æˆ·ï¼‰
CREATE TABLE IF NOT EXISTS credit_allocations (
    id UUID PRIMARY KEY,
    email VARCHAR(255),                     -- é‚®ç®±ï¼Œå¯ç”¨äºæœªæ³¨å†Œç”¨æˆ·
    amount INTEGER NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',   -- 'pending'|'allocated'|'expired'
    allocation_code VARCHAR(50),            -- é‚‘åˆ†ç 
    created_at TIMESTAMPTZ,
    allocated_at TIMESTAMPTZ,
    user_uuid UUID REFERENCES users(uuid)   -- åˆ†é…åå¡«å……
);
```

### é—®é¢˜ 2: æ–°ç”¨æˆ·ç§¯åˆ†åˆå§‹åŒ–ç¡¬ç¼–ç 

**ç°çŠ¶**:
```typescript
// services/user.ts ä¸­ç¡¬ç¼–ç 
subscription_plan: 'free',
credits_remaining: 50,  // â† ç¡¬ç¼–ç 
```

**é—®é¢˜**:
- âŒ æ— æ³•æ ¹æ®æ¨èæ¸ é“åˆ†é…ä¸åŒåˆå§‹ç§¯åˆ†
- âŒ æ— æ³•æ”¯æŒä¿ƒé”€æ´»åŠ¨ï¼ˆå¦‚"æ–°ç”¨æˆ·é€100ç§¯åˆ†"ï¼‰

**å»ºè®®**:
```typescript
// åˆ›å»ºåˆå§‹åŒ–é…ç½®è¡¨
CREATE TABLE IF NOT EXISTS user_initialization_config (
    id UUID PRIMARY KEY,
    channel VARCHAR(50),            -- 'organic'|'referral'|'campaign'|'admin'
    initial_credits INTEGER,        -- åˆå§‹ç§¯åˆ†
    initial_plan VARCHAR(20),       -- åˆå§‹å¥—é¤
    expires_at TIMESTAMPTZ,         -- æ´»åŠ¨æœ‰æ•ˆæœŸ
    metadata JSONB
);

// ä¿®æ”¹ saveUser å‡½æ•°
export async function saveUser(userData: CreateUserData & { channel?: string }): Promise<User> {
    // æŸ¥è¯¢åˆå§‹åŒ–é…ç½®
    const { data: config } = await supabaseAdmin
        .from('user_initialization_config')
        .select('initial_credits, initial_plan')
        .eq('channel', userData.channel || 'organic')
        .eq('expires_at', null, { foreignTable: null })
        .single();
    
    // ä½¿ç”¨é…ç½®ä¸­çš„å€¼ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç çš„ 50
    userToSave.credits_remaining = config?.initial_credits || 50;
}
```

### é—®é¢˜ 3: ç®¡ç†å‘˜ API ç¼ºä¹ç”Ÿäº§ç¯å¢ƒæ”¯æŒ

**ç°çŠ¶**:
```typescript
if (process.env.NODE_ENV !== 'development') {
    return NextResponse.json({ success: false }, { status: 403 });
}
```

**é—®é¢˜**:
- âŒ ç”Ÿäº§ç¯å¢ƒæ— æ³•ç›´æ¥ç®¡ç†ç”¨æˆ·ç§¯åˆ†
- âŒ å¤§è§„æ¨¡è¡¥å¿ç”¨æˆ·æ—¶éœ€è¦ç¼–å†™è„šæœ¬

**å»ºè®®**:
```typescript
// åˆ›å»ºå¸¦æƒé™æ£€æŸ¥å’Œå®¡è®¡æ—¥å¿—çš„ç®¡ç†å‘˜ API
async function adminUpdateCredits(
    userEmails: string[],
    creditsAmount: number,
    reason: string,
    adminUuid: string // æ‰§è¡Œè€…ä¿¡æ¯
): Promise<{ success: boolean; affected: number }> {
    // 1. æƒé™æ£€æŸ¥
    const adminUser = await checkAdminPermission(adminUuid);
    if (!adminUser) throw new Error('Unauthorized');
    
    // 2. åˆ›å»ºæ“ä½œæ—¥å¿—
    const operationId = generateId();
    await supabaseAdmin.from('admin_operations').insert({
        id: operationId,
        admin_uuid: adminUuid,
        operation_type: 'bulk_credit_update',
        affected_users: userEmails.length,
        details: { userEmails, creditsAmount, reason }
    });
    
    // 3. æ‰§è¡Œæ‰¹é‡æ›´æ–°
    await creditsManager.batchCreditsOperation(
        userEmails.map(email => ({
            userUuid: getUserUuidFromEmail(email),
            creditsChange: creditsAmount,
            transactionType: 'bonus',
            description: `${reason} (Operation: ${operationId})`
        }))
    );
}
```

### é—®é¢˜ 4: é¢„æ‰£è¶…æ—¶æ—¶é—´å›ºå®šä¸º 10 åˆ†é’Ÿ

**ç°çŠ¶**:
```sql
expires_at TIMESTAMPTZ NOT NULL DEFAULT (NOW() + INTERVAL '10 minutes')
```

**é—®é¢˜**:
- âŒ å¯¹äºé•¿æ—¶é—´å¤„ç†çš„è§†é¢‘æ— æ³•æ”¯æŒ
- âŒ æ— æ³•æ ¹æ®æ¨¡å‹/åˆ†è¾¨ç‡çµæ´»è®¾ç½®

**å»ºè®®**:
```typescript
const TIMEOUT_CONFIG = {
  'seedance-v1-pro-t2v': {
    '480p': '10 minutes',
    '720p': '15 minutes',
    '1080p': '20 minutes'
  },
  'veo3-fast': {
    '480p': '15 minutes',
    '720p': '20 minutes',
    '1080p': '30 minutes'
  }
};

async reserveCredits(model: string, resolution: string): Promise<string> {
    const timeout = TIMEOUT_CONFIG[model]?.[resolution] || '10 minutes';
    
    const { data: reservationId } = await supabaseAdmin.rpc(
        'reserve_user_credits',
        {
            p_expires_at: `NOW() + INTERVAL '${timeout}'`
        }
    );
}
```

### é—®é¢˜ 5: äº¤æ˜“ç±»å‹å€¼åŸŸæœ‰é™

**ç°çŠ¶**:
```sql
transaction_type VARCHAR(20) CHECK (transaction_type IN (
    'earned', 'spent', 'refunded', 'expired', 'bonus'
))
```

**é—®é¢˜**:
- ç¼ºå°‘"è°ƒæ•´"ã€"è½¬è®©"ã€"é€€æ¬¾"ç­‰ç±»å‹

**å»ºè®®**:
```sql
-- æ‰©å±•äº¤æ˜“ç±»å‹
'earned'      -- æœˆåº¦åˆ†é… / è´­ä¹°
'spent'       -- æ¶ˆè´¹
'bonus'       -- å¥–åŠ±ï¼ˆæ¨èã€æ´»åŠ¨ï¼‰
'refunded'    -- é€€æ¬¾ï¼ˆä»»åŠ¡å¤±è´¥ï¼‰
'expired'     -- è¿‡æœŸæ‰£é™¤
'adjusted'    -- ç®¡ç†å‘˜è°ƒæ•´
'transferred' -- ç”¨æˆ·é—´è½¬è®©
'disputed'    -- äº‰è®®å¤„ç†
```

---

## æ€»ç»“

### ä¼˜åŠ¿

| æ–¹é¢ | è¯„ä»· |
|------|------|
| æ¶æ„å®Œæ•´æ€§ | â­â­â­â­â­ å®Œæ•´çš„é¢„æ‰£-æ¶ˆè´¹-é‡Šæ”¾æµç¨‹ |
| åŸå­æ€§ä¿è¯ | â­â­â­â­â­ ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ RPC å‡½æ•° |
| å®¡è®¡æ—¥å¿— | â­â­â­â­â­ æ¯ç¬”äº¤æ˜“éƒ½æœ‰è®°å½• |
| å¹¶å‘ç®¡ç† | â­â­â­â­â­ é¢„æ‰£è¡¨ + ä»»åŠ¡è®¡æ•°å™¨ |
| API å®Œå–„æ€§ | â­â­â­â­â˜† ç¼ºå°‘ç”Ÿäº§ç¯å¢ƒç®¡ç†å·¥å…· |

### çŸ­æ¿

| çŸ­æ¿ | ä¼˜å…ˆçº§ | è§£å†³æ–¹æ¡ˆ |
|------|--------|--------|
| ä¸æ”¯æŒæœªæ³¨å†Œç”¨æˆ·é¢„åˆ†é… | é«˜ | åˆ›å»ºé¢„åˆ†é…è¡¨æˆ–é’±åŒ…è¡¨ |
| æ–°ç”¨æˆ·åˆå§‹ç§¯åˆ†ç¡¬ç¼–ç  | ä¸­ | é…ç½®åŒ–æ–¹æ¡ˆ |
| ç®¡ç† API ä»…å¼€å‘ç¯å¢ƒ | é«˜ | å¢åŠ æƒé™æ£€æŸ¥ |
| é¢„æ‰£è¶…æ—¶å›ºå®š 10 åˆ†é’Ÿ | ä¸­ | æ ¹æ®æ¨¡å‹çµæ´»è®¾ç½® |

### ç«‹å³å¯ç”¨çš„åŠŸèƒ½

```typescript
// ç»™å·²æ³¨å†Œç”¨æˆ·æ‰¹é‡å¢åŠ ç§¯åˆ†
await creditsManager.batchCreditsOperation([
    {
        userUuid: 'user-1-uuid',
        creditsChange: 100,
        transactionType: 'bonus',
        description: 'æ¨èå¥–åŠ±'
    },
    {
        userUuid: 'user-2-uuid',
        creditsChange: 50,
        transactionType: 'bonus',
        description: 'æ´»åŠ¨å¥–åŠ±'
    }
]);

// ç»™å•ä¸ªç”¨æˆ·æ·»åŠ ç§¯åˆ†
await creditsManager.addBonusCredits(
    userUuid,
    100,
    'Sign-up bonus',
    adminUuid
);

// æŸ¥çœ‹ç”¨æˆ·ç§¯åˆ†å†å²
const history = await creditsManager.getCreditsHistory(userUuid, 50, 0);

// è·å–ç”¨æˆ·ç§¯åˆ†ç»Ÿè®¡
const stats = await supabaseAdmin.rpc('get_user_credits_stats', {
    p_user_uuid: userUuid
});
```

---

## æ¨èåç»­è¡ŒåŠ¨

### ç¬¬ 1 æ­¥ï¼šæ‰©å±•ç®¡ç†åŠŸèƒ½ï¼ˆ1-2 å¤©ï¼‰
- [ ] å‡çº§ `/api/admin/update-credits-direct` æ”¯æŒç”Ÿäº§ç¯å¢ƒ
- [ ] æ·»åŠ æƒé™æ£€æŸ¥å’Œå®¡è®¡æ—¥å¿—
- [ ] æ”¯æŒæ‰¹é‡ç”¨æˆ·é‚®ç®±çš„ç§¯åˆ†æ›´æ–°

### ç¬¬ 2 æ­¥ï¼šå®ç°é¢„åˆ†é…æœºåˆ¶ï¼ˆ2-3 å¤©ï¼‰
- [ ] åˆ›å»º `credit_allocations` è¡¨
- [ ] å®ç°åˆ†é…ç ç”Ÿæˆå’ŒéªŒè¯é€»è¾‘
- [ ] åˆ›å»ºå‰ç«¯å…‘æ¢é¡µé¢

### ç¬¬ 3 æ­¥ï¼šä¼˜åŒ–åˆå§‹åŒ–é…ç½®ï¼ˆ1-2 å¤©ï¼‰
- [ ] åˆ›å»º `user_initialization_config` è¡¨
- [ ] ä¿®æ”¹ `saveUser()` æ”¯æŒåŠ¨æ€é…ç½®
- [ ] åˆ›å»ºåå°ç®¡ç†ç•Œé¢

### ç¬¬ 4 æ­¥ï¼šå¢å¼ºçµæ´»æ€§ï¼ˆ3-5 å¤©ï¼‰
- [ ] æ‰©å±•é¢„æ‰£è¶…æ—¶é…ç½®
- [ ] æ·»åŠ ç§¯åˆ†é’±åŒ…æ¦‚å¿µï¼ˆå¯é€‰ï¼‰
- [ ] å®ç°ç§¯åˆ†è¿‡æœŸç®¡ç†

---

**æŠ¥å‘Šå®Œæˆ** | ç‰ˆæœ¬: 1.0

# è§’è‰²æ›¿æ¢åä»å¼•ç”¨æ—§è§’è‰²é—®é¢˜æ’æŸ¥æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šï¼šåœ¨æ›¿æ¢è§’è‰²åï¼ˆä¾‹å¦‚ä»"å“ˆçš®ç‹—"æ›¿æ¢ä¸º"é‡‘æ¯›"ï¼‰ï¼Œæ‰¹é‡ç”Ÿæˆåˆ†é•œå›¾æ—¶ï¼Œ90%çš„åˆ†é•œå›¾ä½¿ç”¨äº†æ–°è§’è‰²ï¼Œä½†ä»æœ‰çº¦10%çš„åˆ†é•œå›¾å¼•ç”¨äº†æ—§è§’è‰²ã€‚

## æ•°æ®æµåˆ†æ

### 1. æ•°æ®å­˜å‚¨ç»“æ„

```typescript
// video_agent_projects è¡¨
{
  id: UUID,
  script_analysis: {  // JSONB å­—æ®µ
    characters: string[],  // ä¾‹å¦‚: ["Pug (small pug puppy)", "Woman (Asian woman)"]
    shots: Shot[]
  }
}

// Shot æ¥å£
interface Shot {
  shot_number: number,
  description: string,
  character_action: string,
  characters: string[],  // ğŸ”¥ å…³é”®ï¼šè¯¥å­—æ®µå¯èƒ½åŒ…å«åˆ«åï¼Œä¾‹å¦‚ ["the dog", "the woman"]
  // ...
}

// project_characters è¡¨ï¼ˆç‹¬ç«‹å­˜å‚¨ï¼‰
{
  id: UUID,
  project_id: UUID,
  character_name: string,  // ä¾‹å¦‚: "é‡‘æ¯› (Golden Retriever)"
  // ...
}
```

### 2. è§’è‰²æ›¿æ¢æµç¨‹

å½“ç”¨æˆ·æ›¿æ¢è§’è‰²æ—¶ï¼Œè°ƒç”¨ `/api/video-agent/projects/[id]/shots/character-replace`ï¼š

```typescript
// ç¬¬ 254-283 è¡Œ
const nextShots = analysis.shots.map((s: any) => {
  const shot = s as Shot

  // âœ… æ›´æ–°æ–‡æœ¬å­—æ®µ
  const nextDescription = replaceCharacterNameInText(shot.description, fromName, toName)
  const nextAction = replaceCharacterNameInText(shot.character_action, fromName, toName)

  // âš ï¸ æ›´æ–° characters æ•°ç»„
  if (Array.isArray((shot as any).characters)) {
    (updated as any).characters = replaceCharacterNameInListExact(
      (shot as any).characters,
      fromName,
      toName
    )
  }

  return updated
})
```

**å…³é”®é—®é¢˜ï¼š`replaceCharacterNameInListExact` å‡½æ•°çš„é€»è¾‘**

```typescript
// ç¬¬ 109-127 è¡Œ
function replaceCharacterNameInListExact(list: unknown, from: string, to: string): unknown {
  if (!Array.isArray(list)) return list
  const fromShort = shortName(from).trim().toLowerCase()  // ä¾‹å¦‚: "pug"
  const toShort = shortName(to).trim()                     // ä¾‹å¦‚: "é‡‘æ¯›"

  return (list as any[]).map((raw) => {
    const s = String(raw || '').trim()
    const base = s.split('(')[0].trim().toLowerCase()

    // ğŸ”¥ å…³é”®ï¼šåªæ›¿æ¢ç²¾ç¡®åŒ¹é…çš„åç§°
    if (base === fromShort) {
      // ...
      return toShort
    }
    return raw  // âš ï¸ ä¸åŒ¹é…åˆ™ä¿æŒåŸæ ·
  })
}
```

### 3. æ‰¹é‡ç”Ÿæˆåˆ†é•œå›¾æµç¨‹

è°ƒç”¨ `/api/video-agent/projects/[id]/storyboards/generate`ï¼š

```typescript
// ç¬¬ 186 è¡Œï¼šä» script_analysis åŠ è½½ shots
const shots: Shot[] = (project.script_analysis as unknown as ScriptAnalysisResult).shots || []

// ç¬¬ 178-183 è¡Œï¼šä» project_characters è¡¨åŠ è½½å½“å‰è§’è‰²é…ç½®
const characters: CharacterConfig[] = (charactersData || []).map(char => ({
  name: char.character_name,  // ä¾‹å¦‚: "é‡‘æ¯› (Golden Retriever)"
  reference_images: [...]
}))
```

åœ¨ `storyboard-batch-generator.ts` ç¬¬ 148-188 è¡Œçš„è§’è‰²åŒ¹é…é€»è¾‘ï¼š

```typescript
// ç¬¬ 148 è¡Œï¼šä¼˜å…ˆä½¿ç”¨ shot.characters
let shotCharacters = shot.characters || []

// ç¬¬ 151-166 è¡Œï¼šå¤‡ç”¨æ–¹æ¡ˆ1 - ä»æ–‡æœ¬ä¸­æå–
if (shotCharacters.length === 0 && characters.length > 0) {
  const sceneText = `${shot.description} ${shot.character_action}`.toLowerCase()
  const mentionedCharacters = characters
    .filter(char => {
      const shortName = char.name.split('(')[0].trim().toLowerCase()
      return sceneText.includes(shortName)
    })
    .map(char => char.name)

  if (mentionedCharacters.length > 0) {
    shotCharacters = mentionedCharacters
  }
}

// ç¬¬ 168-175 è¡Œï¼šåŒ¹é…ç›¸å…³è§’è‰²
let relevantCharacters = characters.filter(char => {
  const shortCharName = char.name.split('(')[0].trim().toLowerCase()
  return shotCharacters.some(shotChar => {
    const shortShotChar = shotChar.split('(')[0].trim().toLowerCase()
    return shortCharName === shortShotChar
  })
})

// ç¬¬ 179-182 è¡Œï¼šå¤‡ç”¨æ–¹æ¡ˆ2 - ä½¿ç”¨æ‰€æœ‰è§’è‰²
if (relevantCharacters.length === 0 && characters.length > 0) {
  relevantCharacters = characters  // âš ï¸ è¿™å¯èƒ½å¯¼è‡´é—®é¢˜
  console.log('âš ï¸ No character match for shot', shot.shot_number, '- using all characters')
}
```

## é—®é¢˜æ ¹æº

### æƒ…æ™¯1ï¼š`shot.characters` åŒ…å«åˆ«å

å‡è®¾åˆå§‹çŠ¶æ€ï¼š
```javascript
// åˆå§‹è§’è‰²é…ç½®
characters = ["Pug (small pug puppy)"]

// script_analysis.shots[0]
{
  shot_number: 1,
  description: "the dog is walking in the park",
  character_action: "walking slowly",
  characters: ["the dog"]  // ğŸ”¥ åˆ«åï¼Œä¸æ˜¯å®Œæ•´åç§°
}
```

ç”¨æˆ·æ›¿æ¢è§’è‰²ï¼š**å“ˆçš®ç‹— â†’ é‡‘æ¯›**

```javascript
// character-replace API å¤„ç†å
{
  shot_number: 1,
  description: "the cat é‡‘æ¯› is walking in the park",  // âœ… æ–‡æœ¬å·²æ›´æ–°
  character_action: "walking slowly",                    // âœ… æ–‡æœ¬å·²æ›´æ–°
  characters: ["the dog"]  // âŒ åˆ«åæœªè¢«æ›¿æ¢ï¼ˆå› ä¸º "the dog" !== "pug"ï¼‰
}

// project_characters è¡¨
characters = ["é‡‘æ¯› (Golden Retriever)"]
```

æ‰¹é‡ç”Ÿæˆåˆ†é•œå›¾æ—¶ï¼š

```javascript
// ç¬¬ 148 è¡Œ
shotCharacters = ["the dog"]  // ä» shot.characters è·å–

// ç¬¬ 168-175 è¡Œï¼šåŒ¹é…ç›¸å…³è§’è‰²
relevantCharacters = characters.filter(char => {
  // char.name = "é‡‘æ¯› (Golden Retriever)"
  // shortCharName = "é‡‘æ¯›"

  return shotCharacters.some(shotChar => {
    // shotChar = "the dog"
    // shortShotChar = "the dog"

    // "é‡‘æ¯›" !== "the dog" âŒ åŒ¹é…å¤±è´¥
    return "é‡‘æ¯›" === "the dog"
  })
})
// relevantCharacters = []  // ç©ºæ•°ç»„

// ç¬¬ 179-182 è¡Œï¼šè§¦å‘å¤‡ç”¨æ–¹æ¡ˆ
if (relevantCharacters.length === 0) {
  relevantCharacters = characters  // ä½¿ç”¨æ‰€æœ‰è§’è‰²
  // å¦‚æœ characters ä¸­åŒ…å«å¤šä¸ªè§’è‰²ï¼ˆåŒ…æ‹¬æ—§è§’è‰²ï¼‰ï¼Œå°±ä¼šå¯¼è‡´é—®é¢˜
}
```

### æƒ…æ™¯2ï¼š`shot.characters` ä¸ºç©ºï¼Œä½†æ–‡æœ¬ä¸­ä»å¼•ç”¨æ—§åç§°

å‡è®¾æŸä¸ª shot çš„ `characters` æ•°ç»„ä¸ºç©ºï¼Œä½† `description` ä¸­æåˆ°äº†è§’è‰²ï¼š

```javascript
{
  shot_number: 2,
  description: "Pug enters the room",
  character_action: "entering",
  characters: []  // ç©ºæ•°ç»„
}
```

ç”¨æˆ·æ›¿æ¢è§’è‰²åï¼š

```javascript
{
  shot_number: 2,
  description: "é‡‘æ¯› enters the room",  // âœ… å·²æ›´æ–°
  character_action: "entering",
  characters: []  // ä»ç„¶ä¸ºç©º
}
```

æ‰¹é‡ç”Ÿæˆæ—¶ï¼š

```javascript
// ç¬¬ 148 è¡Œ
shotCharacters = []

// ç¬¬ 151-166 è¡Œï¼šä»æ–‡æœ¬ä¸­æå–
const sceneText = "é‡‘æ¯› enters the room entering".toLowerCase()
const mentionedCharacters = characters
  .filter(char => {
    // char.name = "é‡‘æ¯› (Golden Retriever)"
    // shortName = "é‡‘æ¯›"
    return sceneText.includes("é‡‘æ¯›")  // âœ… åŒ¹é…æˆåŠŸ
  })
  .map(char => char.name)
// mentionedCharacters = ["é‡‘æ¯› (Golden Retriever)"]

shotCharacters = ["é‡‘æ¯› (Golden Retriever)"]  // âœ… æ­£ç¡®æå–
```

**è¿™ç§æƒ…å†µä¼šæ­£å¸¸å·¥ä½œï¼**

### æƒ…æ™¯3ï¼šæ•°æ®åº“/ç¼“å­˜ä¸åŒæ­¥

å¯èƒ½çš„åœºæ™¯ï¼š
1. ç”¨æˆ·æ›¿æ¢è§’è‰²åï¼Œ`character-replace` API æ›´æ–°äº† `script_analysis`
2. ä½†æ˜¯å‰ç«¯æˆ–æŸäº›ä¸­é—´å±‚ç¼“å­˜äº†æ—§çš„ `script_analysis` æ•°æ®
3. æ‰¹é‡ç”Ÿæˆæ—¶ï¼Œä½¿ç”¨äº†ç¼“å­˜çš„æ—§æ•°æ®

## å¯èƒ½çš„åŸå› æ€»ç»“

æ ¹æ®ä»£ç åˆ†æï¼Œé—®é¢˜æœ€å¯èƒ½çš„åŸå› æ˜¯ï¼š

### ğŸ”¥ ä¸»è¦åŸå› ï¼š`shot.characters` åŒ…å«åˆ«åï¼ˆ60%æ¦‚ç‡ï¼‰

- `shot.characters` æ•°ç»„ä¸­åŒ…å« `"the dog"`, `"the cat"`, `"the orange cat"` ç­‰åˆ«å
- `character-replace` API çš„ `replaceCharacterNameInListExact` åªèƒ½æ›¿æ¢ç²¾ç¡®åŒ¹é…çš„åç§°
- åˆ«åæœªè¢«æ›¿æ¢ï¼Œå¯¼è‡´åç»­åŒ¹é…å¤±è´¥ï¼Œè§¦å‘"ä½¿ç”¨æ‰€æœ‰è§’è‰²"çš„å¤‡ç”¨é€»è¾‘

### å¯èƒ½åŸå› 2ï¼šæµè§ˆå™¨/å‰ç«¯ç¼“å­˜ï¼ˆ20%æ¦‚ç‡ï¼‰

- ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­æ¸…ç†è¿‡ç¼“å­˜ï¼Œä½†é—®é¢˜ä»å­˜åœ¨
- å¯èƒ½æ˜¯å‰ç«¯ storeï¼ˆZustandï¼‰ç¼“å­˜äº†æ—§æ•°æ®
- æˆ–è€…æ˜¯ API å“åº”è¢«æµè§ˆå™¨ HTTP ç¼“å­˜

### å¯èƒ½åŸå› 3ï¼šç«æ€æ¡ä»¶ï¼ˆ15%æ¦‚ç‡ï¼‰

- ç”¨æˆ·å¿«é€Ÿæ›¿æ¢è§’è‰²å¹¶ç«‹å³æ‰¹é‡ç”Ÿæˆ
- `character-replace` API å°šæœªå®Œæˆæ•°æ®åº“æ›´æ–°
- æ‰¹é‡ç”Ÿæˆ API è¯»å–åˆ°äº†æ—§æ•°æ®

### å¯èƒ½åŸå› 4ï¼šå¤šä¸ªè§’è‰²åŒæ—¶å­˜åœ¨ï¼ˆ5%æ¦‚ç‡ï¼‰

- `project_characters` è¡¨ä¸­åŒæ—¶å­˜åœ¨æ–°æ—§è§’è‰²è®°å½•
- æ‰¹é‡ç”Ÿæˆæ—¶ï¼ŒåŠ è½½äº†æ‰€æœ‰è§’è‰²ï¼ˆåŒ…æ‹¬æ—§è§’è‰²ï¼‰
- å¤‡ç”¨é€»è¾‘ä½¿ç”¨æ‰€æœ‰è§’è‰²ï¼Œå¯¼è‡´æ—§è§’è‰²è¢«å¼•ç”¨

## éªŒè¯å»ºè®®

### 1. æ•°æ®åº“æŸ¥è¯¢ï¼ˆæœ€é‡è¦ï¼‰

```sql
-- æ£€æŸ¥ script_analysis.shots[].characters æ˜¯å¦åŒ…å«åˆ«å
SELECT
  id,
  script_analysis->'shots'->0->'characters' as shot_0_characters,
  script_analysis->'shots'->1->'characters' as shot_1_characters,
  script_analysis->'shots'->2->'characters' as shot_2_characters
FROM video_agent_projects
WHERE id = '<project_id>';

-- æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„è§’è‰²è®°å½•
SELECT
  character_name,
  created_at,
  updated_at
FROM project_characters
WHERE project_id = '<project_id>'
ORDER BY created_at DESC;
```

### 2. æ—¥å¿—åˆ†æ

åœ¨ `storyboard-batch-generator.ts` ç¬¬ 184-188 è¡Œï¼Œå·²ç»æœ‰æ—¥å¿—è¾“å‡ºï¼š

```typescript
console.log('[Storyboard Batch Generator] Characters for shot', shot.shot_number, {
  allCharacters: characters.map(c => c.name),
  shotCharacters,
  relevantCharacters: relevantCharacters.map(c => c.name)
})
```

æŸ¥çœ‹ç”Ÿæˆæ—¥å¿—ï¼Œç¡®è®¤ï¼š
- `shotCharacters` çš„å€¼ï¼ˆæ˜¯å¦åŒ…å«åˆ«åï¼‰
- `relevantCharacters` çš„å€¼ï¼ˆæ˜¯å¦ä¸ºç©ºï¼Œè§¦å‘å¤‡ç”¨é€»è¾‘ï¼‰

### 3. å‰ç«¯çŠ¶æ€æ£€æŸ¥

åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­æ£€æŸ¥ï¼š

```javascript
// æ£€æŸ¥ Zustand store ä¸­çš„æ•°æ®
window.__ZUSTAND_STORE__?.getState()?.currentProject?.script_analysis?.shots
```

## å»ºè®®çš„ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šå¢å¼ºåˆ«åè¯†åˆ«ï¼ˆæ¨èï¼‰

ä¿®æ”¹ `replaceCharacterNameInListExact` å‡½æ•°ï¼Œä½¿å…¶èƒ½å¤Ÿè¯†åˆ«å’Œæ›¿æ¢åˆ«åï¼š

```typescript
function replaceCharacterNameInListExact(list: unknown, from: string, to: string): unknown {
  if (!Array.isArray(list)) return list
  const fromShort = shortName(from).trim().toLowerCase()
  const toShort = shortName(to).trim()
  if (!fromShort || !toShort) return list

  // ğŸ”¥ æ–°å¢ï¼šè·å–æ‰€æœ‰å¯èƒ½çš„åˆ«å
  const fromAliases = [fromShort, ...toGenericAliases(from)]

  return (list as any[]).map((raw) => {
    const s = String(raw || '').trim()
    if (!s) return raw
    const base = s.split('(')[0].trim().toLowerCase()

    // ğŸ”¥ æ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»ä½•åˆ«å
    if (fromAliases.some(alias => alias === base)) {
      const leftParen = s.indexOf('(')
      if (leftParen === -1) return toShort
      return `${toShort} ${s.slice(leftParen).trim()}`
    }
    return raw
  })
}
```

### æ–¹æ¡ˆBï¼šä¼˜å…ˆä½¿ç”¨æ–‡æœ¬æå–ï¼ˆå¤‡é€‰ï¼‰

ä¿®æ”¹ `storyboard-batch-generator.ts` çš„åŒ¹é…é€»è¾‘ï¼Œä¼˜å…ˆä½¿ç”¨ `description` å’Œ `character_action` ä¸­çš„ä¿¡æ¯ï¼š

```typescript
// ğŸ”¥ æ”¹è¿›ï¼šå§‹ç»ˆä»æ–‡æœ¬ä¸­æå–ï¼Œä¸ä¾èµ– shot.characters
let shotCharacters: string[] = []

if (characters.length > 0) {
  const sceneText = `${shot.description} ${shot.character_action}`.toLowerCase()

  shotCharacters = characters
    .filter(char => {
      const shortName = char.name.split('(')[0].trim().toLowerCase()
      return sceneText.includes(shortName)
    })
    .map(char => char.name)
}

// å¦‚æœæ–‡æœ¬æå–ä¸ºç©ºï¼Œæ‰ä½¿ç”¨ shot.characters ä½œä¸ºå¤‡ç”¨
if (shotCharacters.length === 0 && shot.characters && shot.characters.length > 0) {
  shotCharacters = shot.characters
}
```

### æ–¹æ¡ˆCï¼šæ¸…ç†é‡å¤è§’è‰²ï¼ˆè¾…åŠ©ï¼‰

åœ¨ `character-replace` API ä¸­ï¼Œåˆ é™¤æ—§è§’è‰²è®°å½•ï¼Œç¡®ä¿ `project_characters` è¡¨ä¸­åªæœ‰æ–°è§’è‰²ï¼š

```typescript
// åœ¨æ›¿æ¢è§’è‰²åï¼Œåˆ é™¤æ—§è§’è‰²
await supabaseAdmin
  .from('project_characters')
  .delete()
  .eq('project_id', projectId)
  .eq('character_name', fromName)
```

## åç»­è¡ŒåŠ¨

1. âœ… **ç«‹å³æ’æŸ¥**ï¼šæŸ¥çœ‹æ•°æ®åº“ä¸­çš„ `script_analysis.shots[].characters` å­—æ®µ
2. âœ… **æ—¥å¿—åˆ†æ**ï¼šæ£€æŸ¥æœ€è¿‘ä¸€æ¬¡æ‰¹é‡ç”Ÿæˆçš„æ—¥å¿—ï¼Œç¡®è®¤ `shotCharacters` å’Œ `relevantCharacters` çš„å€¼
3. â³ **å®æ–½ä¿®å¤**ï¼šæ ¹æ®æ’æŸ¥ç»“æœï¼Œé€‰æ‹©åˆé€‚çš„ä¿®å¤æ–¹æ¡ˆ
4. â³ **å›å½’æµ‹è¯•**ï¼šä¿®å¤åï¼Œé‡æ–°æµ‹è¯•è§’è‰²æ›¿æ¢å’Œæ‰¹é‡ç”Ÿæˆæµç¨‹

## ç»“è®º

æ ¹æ®ä»£ç åˆ†æï¼Œ**æœ€å¯èƒ½çš„åŸå› æ˜¯ `shot.characters` æ•°ç»„åŒ…å«åˆ«åï¼ˆä¾‹å¦‚ "the dog"ï¼‰ï¼Œè€Œ `character-replace` API æ— æ³•æ­£ç¡®æ›¿æ¢åˆ«åï¼Œå¯¼è‡´åç»­åŒ¹é…å¤±è´¥**ã€‚

å»ºè®®ä¼˜å…ˆå®æ–½**æ–¹æ¡ˆA**ï¼Œå¢å¼ºåˆ«åè¯†åˆ«èƒ½åŠ›ï¼Œç¡®ä¿è§’è‰²æ›¿æ¢æ—¶èƒ½å¤Ÿæ­£ç¡®æ›´æ–°æ‰€æœ‰åˆ«åå¼•ç”¨ã€‚
